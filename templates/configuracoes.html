{% extends "base.html" %}

{% block title %}Configurações - Sistema Analisador de Prompts{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-gear"></i>
        Configurações do Sistema
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetarConfiguracoes()">
                <i class="bi bi-arrow-clockwise"></i>
                Restaurar Padrões
            </button>
            <button type="button" class="btn btn-sm btn-outline-info" onclick="testarConexao()">
                <i class="bi bi-wifi"></i>
                Testar Conexão
            </button>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-sm btn-success" onclick="salvarConfiguracoes()">
                <i class="bi bi-check-circle"></i>
                Salvar Configurações
            </button>
        </div>
        <div class="btn-group ms-2">
            <button type="button" class="btn btn-sm btn-outline-warning" onclick="fazerBackupBanco()">
                <i class="bi bi-download"></i>
                Backup do Banco
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Seletor de Provedor de IA -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-cpu"></i>
                    Provedor de Inteligência Artificial
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="ai-provider" class="form-label">
                        Provedor Atual
                        <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="ai-provider" name="ai_provider" onchange="alterarProvedor()">
                        <option value="openai" {% if provedor_atual == 'openai' %}selected{% endif %}>OpenAI (GPT-3.5, GPT-4)</option>
                        <option value="azure" {% if provedor_atual == 'azure' %}selected{% endif %}>Azure OpenAI</option>
                        <option value="anthropic" disabled>Anthropic Claude (Em breve)</option>
                        <option value="google" disabled>Google Gemini (Em breve)</option>
                        <option value="local" disabled>Modelo Local (Em breve)</option>
                    </select>
                    <div class="form-text">
                        <i class="bi bi-info-circle"></i>
                        Selecione o provedor de IA que será usado para análise das intimações.
                        <br>
                        <strong>Provedor ativo:</strong> <span id="provider-status" class="badge {% if provedor_atual == 'openai' or provedor_atual == 'azure' %}bg-success{% else %}bg-warning{% endif %}">
                            {% if provedor_atual == 'openai' %}OpenAI{% elif provedor_atual == 'azure' %}Azure OpenAI{% else %}{{ provedor_atual|title }}{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Configurações da OpenAI -->
        <div class="card mb-4" id="openai-config">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-key"></i>
                    Configurações da OpenAI
                </h5>
            </div>
            <div class="card-body">
                <form id="form-openai">
                    <div class="mb-3">
                        <label for="api-key" class="form-label">
                            Chave da API
                            <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="api-key" name="api_key" 
                                   placeholder="sk-..." value="***CONFIGURADO VIA .ENV***" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('api-key')">
                                <i class="bi bi-eye" id="api-key-icon"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Chave configurada via variável de ambiente</strong>
                                <br>
                                A chave da API está sendo carregada do arquivo <code>.env</code> ou variável de ambiente <code>OPENAI_API_KEY</code>.
                                <br>
                                Para alterar, edite o arquivo <code>.env</code> na raiz do projeto.
                                <br><br>
                                <strong>Status:</strong> <code>Configurada via variável de ambiente</code>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="modelo-padrao" class="form-label">Modelo Padrão</label>
                            <select class="form-select" id="modelo-padrao" name="modelo_padrao">
                                {% for modelo in modelos_disponiveis %}
                                <option value="{{ modelo }}" {% if modelo == config.modelo_padrao %}selected{% endif %}>
                                    {{ modelo }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                Modelo usado por padrão nas análises
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="temperatura-padrao" class="form-label">
                                Temperatura Padrão
                                <span class="text-muted">(<span id="temp-value">{{ config.temperatura_padrao }}</span>)</span>
                            </label>
                            <input type="range" class="form-range" id="temperatura-padrao" name="temperatura_padrao" 
                                   min="0" max="2" step="0.1" value="{{ config.temperatura_padrao }}" 
                                   oninput="document.getElementById('temp-value').textContent = this.value">
                            <div class="form-text">
                                0 = Mais determinístico, 2 = Mais criativo
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="max-tokens-padrao" class="form-label">Máximo de Tokens Padrão</label>
                            <input type="number" class="form-control" id="max-tokens-padrao" name="max_tokens_padrao" 
                                   value="{{ config.max_tokens_padrao }}" min="1" max="4000">
                            <div class="form-text">
                                Limite padrão de tokens para respostas
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="timeout-padrao" class="form-label">Timeout Padrão (segundos)</label>
                            <input type="number" class="form-control" id="timeout-padrao" name="timeout_padrao" 
                                   value="{{ config.timeout_padrao or 30 }}" min="5" max="120">
                            <div class="form-text">
                                Tempo limite padrão para chamadas da API
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="max-retries" class="form-label">Máximo de Tentativas</label>
                            <input type="number" class="form-control" id="max-retries" name="max_retries" 
                                   value="{{ config.max_retries or 3 }}" min="1" max="10">
                            <div class="form-text">
                                Número de tentativas em caso de erro
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="retry-delay" class="form-label">Delay entre Tentativas (segundos)</label>
                            <input type="number" class="form-control" id="retry-delay" name="retry_delay" 
                                   value="{{ config.retry_delay or 1 }}" min="0.1" max="10" step="0.1">
                            <div class="form-text">
                                Tempo de espera entre tentativas
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="analise-paralela" class="form-label">
                                <i class="bi bi-lightning-charge text-warning"></i>
                                Análises Paralelas
                            </label>
                            <input type="number" class="form-control" id="analise-paralela" name="analise_paralela" 
                                   value="{{ config.analise_paralela or 1 }}" min="1" max="10">
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i>
                                Número de intimações analisadas simultaneamente (1-10)
                                <br>
                                <small class="text-muted">
                                    <strong>Recomendação:</strong> 2-3 para melhor performance
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="delay-entre-lotes" class="form-label">
                                <i class="bi bi-clock text-info"></i>
                                Delay entre Lotes (segundos)
                            </label>
                            <input type="number" class="form-control" id="delay-entre-lotes" name="delay_entre_lotes" 
                                   value="{{ config.delay_entre_lotes or 0.5 }}" min="0" max="5" step="0.1">
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i>
                                Tempo de espera entre lotes de análises paralelas
                                <br>
                                <small class="text-muted">
                                    <strong>Recomendação:</strong> 0.5-1.0 segundos
                                </small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Configurações do Azure OpenAI -->
        <div class="card mb-4" id="azure-config" style="display: none;">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-cloud"></i>
                    Configurações do Azure OpenAI
                </h5>
            </div>
            <div class="card-body">
                <form id="form-azure">
                    <div class="mb-3">
                        <label for="azure-api-key" class="form-label">
                            Chave da API
                            <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="azure-api-key" name="azure_api_key" 
                                   placeholder="Chave da API do Azure OpenAI" value="***CONFIGURADO VIA .ENV***" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('azure-api-key')">
                                <i class="bi bi-eye" id="azure-api-key-icon"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Chave configurada via variável de ambiente</strong>
                                <br>
                                A chave da API está sendo carregada do arquivo <code>.env</code> ou variável de ambiente <code>AZURE_OPENAI_API_KEY</code>.
                                <br>
                                Para alterar, edite o arquivo <code>.env</code> na raiz do projeto.
                                <br><br>
                                <strong>Status:</strong> <code>Configurada via variável de ambiente</code>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="azure-endpoint" class="form-label">
                            Endpoint
                            <span class="text-danger">*</span>
                        </label>
                        <input type="url" class="form-control" id="azure-endpoint" name="azure_endpoint" 
                               placeholder="https://seu-recurso.openai.azure.com/" value="***CONFIGURADO VIA .ENV***" readonly>
                        <div class="form-text">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Endpoint configurado via variável de ambiente</strong>
                                <br>
                                O endpoint está sendo carregado do arquivo <code>.env</code> ou variável de ambiente <code>AZURE_OPENAI_ENDPOINT</code>.
                                <br>
                                Para alterar, edite o arquivo <code>.env</code> na raiz do projeto.
                                <br><br>
                                <strong>Valor atual:</strong> <code>https://rdm.openai.azure.com/</code>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="azure-api-version" class="form-label">Versão da API</label>
                        <select class="form-select" id="azure-api-version" name="azure_api_version">
                            <option value="2024-02-15-preview" {% if config.azure_api_version == '2024-02-15-preview' %}selected{% endif %}>2024-02-15-preview</option>
                            <option value="2023-12-01-preview" {% if config.azure_api_version == '2023-12-01-preview' %}selected{% endif %}>2023-12-01-preview</option>
                            <option value="2023-05-15" {% if config.azure_api_version == '2023-05-15' %}selected{% endif %}>2023-05-15</option>
                        </select>
                        <div class="form-text">
                            Versão da API do Azure OpenAI a ser utilizada
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="azure-deployment" class="form-label">Deployment Padrão</label>
                        <select class="form-select" id="azure-deployment" name="azure_deployment">
                            {% for modelo in modelos_disponiveis %}
                            <option value="{{ modelo }}" {% if modelo == config.azure_deployment %}selected{% endif %}>
                                {{ modelo }}
                            </option>
                            {% endfor %}
                        </select>
                                   placeholder="gpt-4" value="{{ config.azure_deployment or 'gpt-4' }}">
                            <div class="form-text">
                                Nome do deployment configurado no Azure
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="azure-temperatura" class="form-label">
                                Temperatura Padrão
                                <span class="text-muted">(<span id="azure-temp-value">{{ config.azure_temperatura if config.azure_temperatura is not none else 0.7 }}</span>)</span>
                            </label>
                            <input type="range" class="form-range" id="azure-temperatura" name="azure_temperatura" 
                                   min="0" max="2" step="0.1" value="{{ config.azure_temperatura if config.azure_temperatura is not none else 0.7 }}" 
                                   oninput="document.getElementById('azure-temp-value').textContent = this.value">
                            <div class="form-text">
                                0 = Mais determinístico, 2 = Mais criativo
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="azure-max-tokens" class="form-label">Máximo de Tokens Padrão</label>
                            <input type="number" class="form-control" id="azure-max-tokens" name="azure_max_tokens" 
                                   value="{{ config.azure_max_tokens or 500 }}" min="1" max="4000">
                            <div class="form-text">
                                Limite padrão de tokens para respostas
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="azure-timeout" class="form-label">Timeout Padrão (segundos)</label>
                            <input type="number" class="form-control" id="azure-timeout" name="azure_timeout" 
                                   value="{{ config.azure_timeout or 30 }}" min="5" max="120">
                            <div class="form-text">
                                Tempo limite padrão para chamadas da API
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="azure-analise-paralela" class="form-label">
                                <i class="bi bi-lightning-charge text-warning"></i>
                                Análises Paralelas
                            </label>
                            <input type="number" class="form-control" id="azure-analise-paralela" name="azure_analise_paralela" 
                                   value="{{ config.azure_analise_paralela or 1 }}" min="1" max="10">
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i>
                                Número de intimações analisadas simultaneamente (1-10)
                                <br>
                                <small class="text-muted">
                                    <strong>Recomendação:</strong> 2-3 para melhor performance
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="azure-delay-entre-lotes" class="form-label">
                                <i class="bi bi-clock text-info"></i>
                                Delay entre Lotes (segundos)
                            </label>
                            <input type="number" class="form-control" id="azure-delay-entre-lotes" name="azure_delay_entre_lotes" 
                                   value="{{ config.azure_delay_entre_lotes or 0.5 }}" min="0" max="5" step="0.1">
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i>
                                Tempo de espera entre lotes de análises paralelas
                                <br>
                                <small class="text-muted">
                                    <strong>Recomendação:</strong> 0.5-1.0 segundos
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" onclick="testarConexaoAzure()">
                            <i class="bi bi-wifi"></i>
                            Testar Conexão
                        </button>
                        <button type="button" class="btn btn-success" onclick="salvarConfiguracaoAzure()">
                            <i class="bi bi-check-lg"></i>
                            Salvar Configurações
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Configurações de Preços da API -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-currency-dollar"></i>
                    Preços da API
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Informação:</strong> Configure os preços por milhão de tokens para calcular o custo real das análises.
                    Os valores são em USD e devem ser atualizados conforme as tabelas oficiais dos provedores.
                </div>
                
                <!-- Preços OpenAI -->
                <div class="mb-4">
                    <h6 class="text-primary">
                        <i class="bi bi-robot"></i>
                        Preços OpenAI (USD por 1M tokens)
                    </h6>
                    <form id="form-precos-openai">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="openai-gpt4o-input" class="form-label">GPT-4o - Input</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="openai-gpt4o-input" name="openai_gpt4o_input" 
                                           value="{{ precos_openai['gpt-4o'].input or 2.50 }}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="openai-gpt4o-output" class="form-label">GPT-4o - Output</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="openai-gpt4o-output" name="openai_gpt4o_output" 
                                           value="{{ precos_openai['gpt-4o'].output or 10.00 }}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="openai-gpt4o-mini-input" class="form-label">GPT-4o-mini - Input</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="openai-gpt4o-mini-input" name="openai_gpt4o_mini_input" 
                                           value="{{ precos_openai['gpt-4o-mini'].input or 0.15 }}" step="0.01" min="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="openai-gpt4o-mini-output" class="form-label">GPT-4o-mini - Output</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="openai-gpt4o-mini-output" name="openai_gpt4o_mini_output" 
                                           value="{{ precos_openai['gpt-4o-mini'].output or 0.60 }}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="openai-gpt4-turbo-input" class="form-label">GPT-4 Turbo - Input</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="openai-gpt4-turbo-input" name="openai_gpt4_turbo_input" 
                                           value="{{ precos_openai['gpt-4-turbo'].input or 10.00 }}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="openai-gpt4-turbo-output" class="form-label">GPT-4 Turbo - Output</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="openai-gpt4-turbo-output" name="openai_gpt4_turbo_output" 
                                           value="{{ precos_openai['gpt-4-turbo'].output or 30.00 }}" step="0.01" min="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="openai-gpt35-turbo-input" class="form-label">GPT-3.5 Turbo - Input</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="openai-gpt35-turbo-input" name="openai_gpt35_turbo_input" 
                                           value="{{ precos_openai['gpt-3.5-turbo'].input or 0.50 }}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="openai-gpt35-turbo-output" class="form-label">GPT-3.5 Turbo - Output</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="openai-gpt35-turbo-output" name="openai_gpt35_turbo_output" 
                                           value="{{ precos_openai['gpt-3.5-turbo'].output or 1.50 }}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="data-atualizacao-openai" class="form-label">Última Atualização</label>
                                <input type="date" class="form-control" id="data-atualizacao-openai" name="data_atualizacao_openai" 
                                       value="{{ precos_openai.data_atualizacao or '' }}">
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-success" onclick="salvarPrecosOpenAI()">
                                <i class="bi bi-check-lg"></i>
                                Salvar Preços OpenAI
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="restaurarPrecosOpenAI()">
                                <i class="bi bi-arrow-clockwise"></i>
                                Restaurar Padrões
                            </button>
                        </div>
                    </form>
                </div>
                
                <hr>
                
                <!-- Preços Azure OpenAI -->
                <div class="mb-4">
                    <h6 class="text-primary">
                        <i class="bi bi-microsoft"></i>
                        Preços Azure OpenAI (USD por 1M tokens)
                    </h6>
                    <form id="form-precos-azure">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="azure-gpt4o-input" class="form-label">GPT-4o - Input</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="azure-gpt4o-input" name="azure_gpt4o_input" 
                                           value="{{ precos_azure['gpt-4o'].input or 5.00 }}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="azure-gpt4o-output" class="form-label">GPT-4o - Output</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="azure-gpt4o-output" name="azure_gpt4o_output" 
                                           value="{{ precos_azure['gpt-4o'].output or 15.00 }}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="azure-gpt4o-mini-input" class="form-label">GPT-4o-mini - Input</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="azure-gpt4o-mini-input" name="azure_gpt4o_mini_input" 
                                           value="{{ precos_azure['gpt-4o-mini'].input or 0.165 }}" step="0.001" min="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="azure-gpt4o-mini-output" class="form-label">GPT-4o-mini - Output</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="azure-gpt4o-mini-output" name="azure_gpt4o_mini_output" 
                                           value="{{ precos_azure['gpt-4o-mini'].output or 0.66 }}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="azure-gpt4-turbo-input" class="form-label">GPT-4 Turbo - Input</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="azure-gpt4-turbo-input" name="azure_gpt4_turbo_input" 
                                           value="{{ precos_azure['gpt-4-turbo'].input or 10.00 }}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="azure-gpt4-turbo-output" class="form-label">GPT-4 Turbo - Output</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="azure-gpt4-turbo-output" name="azure_gpt4_turbo_output" 
                                           value="{{ precos_azure['gpt-4-turbo'].output or 30.00 }}" step="0.01" min="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <label for="azure-gpt35-turbo-input" class="form-label">GPT-3.5 Turbo - Input</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="azure-gpt35-turbo-input" name="azure_gpt35_turbo_input" 
                                           value="{{ precos_azure['gpt-3.5-turbo'].input or 0.50 }}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="azure-gpt35-turbo-output" class="form-label">GPT-3.5 Turbo - Output</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="azure-gpt35-turbo-output" name="azure_gpt35_turbo_output" 
                                           value="{{ precos_azure['gpt-3.5-turbo'].output or 1.50 }}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="data-atualizacao-azure" class="form-label">Última Atualização</label>
                                <input type="date" class="form-control" id="data-atualizacao-azure" name="data_atualizacao_azure" 
                                       value="{{ precos_azure.data_atualizacao or '' }}">
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-success" onclick="salvarPrecosAzure()">
                                <i class="bi bi-check-lg"></i>
                                Salvar Preços Azure
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="restaurarPrecosAzure()">
                                <i class="bi bi-arrow-clockwise"></i>
                                Restaurar Padrões
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Informações de Custo -->
                <div class="alert alert-light border">
                    <h6 class="alert-heading">
                        <i class="bi bi-calculator"></i>
                        Calculadora de Custos
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>Exemplo de cálculo:</strong><br>
                                • 1.000 tokens de entrada × $2.50 = $0.0025<br>
                                • 500 tokens de saída × $10.00 = $0.005<br>
                                • <strong>Custo total: $0.0075</strong>
                            </small>
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">
                                <strong>Dica:</strong> Mantenha os preços atualizados consultando:<br>
                                • <a href="https://openai.com/pricing" target="_blank">OpenAI Pricing</a><br>
                                • <a href="https://azure.microsoft.com/pricing/details/cognitive-services/openai-service/" target="_blank">Azure OpenAI Pricing</a>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configurações do Sistema -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-sliders"></i>
                    Configurações do Sistema
                </h5>
            </div>
            <div class="card-body">
                <form id="form-sistema">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="itens-por-pagina" class="form-label">Itens por Página</label>
                            <select class="form-select" id="itens-por-pagina" name="itens_por_pagina">
                                <option value="10" {% if config.itens_por_pagina == 10 %}selected{% endif %}>10</option>
                                <option value="25" {% if config.itens_por_pagina == 25 %}selected{% endif %}>25</option>
                                <option value="50" {% if config.itens_por_pagina == 50 %}selected{% endif %}>50</option>
                                <option value="100" {% if config.itens_por_pagina == 100 %}selected{% endif %}>100</option>
                            </select>
                            <div class="form-text">
                                Número de itens exibidos por página nas listas
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="formato-data" class="form-label">Formato de Data</label>
                            <select class="form-select" id="formato-data" name="formato_data">
                                <option value="DD/MM/YYYY" {% if config.formato_data == 'DD/MM/YYYY' %}selected{% endif %}>DD/MM/AAAA</option>
                                <option value="MM/DD/YYYY" {% if config.formato_data == 'MM/DD/YYYY' %}selected{% endif %}>MM/DD/AAAA</option>
                                <option value="YYYY-MM-DD" {% if config.formato_data == 'YYYY-MM-DD' %}selected{% endif %}>AAAA-MM-DD</option>
                            </select>
                            <div class="form-text">
                                Formato de exibição de datas no sistema
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="tema" class="form-label">Tema da Interface</label>
                            <select class="form-select" id="tema" name="tema">
                                <option value="light" {% if config.tema == 'light' %}selected{% endif %}>Claro</option>
                                <option value="dark" {% if config.tema == 'dark' %}selected{% endif %}>Escuro</option>
                                <option value="auto" {% if config.tema == 'auto' %}selected{% endif %}>Automático</option>
                            </select>
                            <div class="form-text">
                                Aparência da interface do usuário
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="idioma" class="form-label">Idioma</label>
                            <select class="form-select" id="idioma" name="idioma">
                                <option value="pt-BR" {% if config.idioma == 'pt-BR' %}selected{% endif %}>Português (Brasil)</option>
                                <option value="en-US" {% if config.idioma == 'en-US' %}selected{% endif %}>English (US)</option>
                                <option value="es-ES" {% if config.idioma == 'es-ES' %}selected{% endif %}>Español</option>
                            </select>
                            <div class="form-text">
                                Idioma da interface do sistema
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <label for="portal-defensoria-link" class="form-label">
                                <i class="bi bi-link-45deg"></i>
                                Link Base do Portal da Defensoria
                            </label>
                            <input type="url" class="form-control" id="portal-defensoria-link" name="portal_defensoria_link" 
                                   placeholder="https://portal.defensoria.rs.gov.br/tarefas/" 
                                   value="{{ config.portal_defensoria_link or '' }}">
                            <div class="form-text">
                                <i class="bi bi-info-circle"></i>
                                <strong>Link base para localizar tarefas no Portal da Defensoria</strong>
                                <br>
                                Este link será combinado com o ID da tarefa para criar links diretos.
                                <br>
                                <strong>Exemplo:</strong> Se o link for <code>https://portal.defensoria.rs.gov.br/tarefas/</code> 
                                e o ID da tarefa for <code>12345</code>, o link final será: 
                                <code>https://portal.defensoria.rs.gov.br/tarefas/12345</code>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Opções de Interface</h6>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="mostrar-tooltips" name="mostrar_tooltips" 
                                   {% if config.mostrar_tooltips %}checked{% endif %}>
                            <label class="form-check-label" for="mostrar-tooltips">
                                Mostrar dicas de ajuda (tooltips)
                            </label>
                        </div>
                        
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="animacoes" name="animacoes" 
                                   {% if config.animacoes %}checked{% endif %}>
                            <label class="form-check-label" for="animacoes">
                                Ativar animações da interface
                            </label>
                        </div>
                        
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="sons-notificacao" name="sons_notificacao" 
                                   {% if config.sons_notificacao %}checked{% endif %}>
                            <label class="form-check-label" for="sons-notificacao">
                                Reproduzir sons de notificação
                            </label>
                        </div>
                        
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="auto-save" name="auto_save" 
                                   {% if config.auto_save %}checked{% endif %}>
                            <label class="form-check-label" for="auto-save">
                                Salvamento automático de rascunhos
                            </label>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Configurações de Backup -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check"></i>
                    Backup e Segurança
                </h5>
            </div>
            <div class="card-body">
                <form id="form-backup">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="backup-automatico" class="form-label">Backup Automático</label>
                            <select class="form-select" id="backup-automatico" name="backup_automatico">
                                <option value="disabled" {% if config.backup_automatico == 'disabled' %}selected{% endif %}>Desabilitado</option>
                                <option value="daily" {% if config.backup_automatico == 'daily' %}selected{% endif %}>Diário</option>
                                <option value="weekly" {% if config.backup_automatico == 'weekly' %}selected{% endif %}>Semanal</option>
                                <option value="monthly" {% if config.backup_automatico == 'monthly' %}selected{% endif %}>Mensal</option>
                            </select>
                            <div class="form-text">
                                Frequência de backup automático dos dados
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="max-backups" class="form-label">Máximo de Backups</label>
                            <input type="number" class="form-control" id="max-backups" name="max_backups" 
                                   value="{{ config.max_backups or 10 }}" min="1" max="50">
                            <div class="form-text">
                                Número máximo de backups a manter
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="diretorio-backup" class="form-label">Diretório de Backup</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="diretorio-backup" name="diretorio_backup" 
                                       value="{{ config.diretorio_backup or './backups' }}" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="selecionarDiretorio()">
                                    <i class="bi bi-folder"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                Local onde os backups serão armazenados
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="compressao-backup" class="form-label">Compressão</label>
                            <select class="form-select" id="compressao-backup" name="compressao_backup">
                                <option value="none" {% if config.compressao_backup == 'none' %}selected{% endif %}>Sem compressão</option>
                                <option value="zip" {% if config.compressao_backup == 'zip' %}selected{% endif %}>ZIP</option>
                                <option value="gzip" {% if config.compressao_backup == 'gzip' %}selected{% endif %}>GZIP</option>
                            </select>
                            <div class="form-text">
                                Tipo de compressão para os backups
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Ações de Backup</h6>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-primary" onclick="criarBackupManual()">
                                <i class="bi bi-download"></i>
                                Criar Backup Agora
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="restaurarBackup()">
                                <i class="bi bi-upload"></i>
                                Restaurar Backup
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="listarBackups()">
                                <i class="bi bi-list"></i>
                                Listar Backups
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Configurações Avançadas -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-tools"></i>
                    Configurações Avançadas
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Atenção:</strong> Altere essas configurações apenas se souber o que está fazendo.
                </div>
                
                <form id="form-avancado">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="log-level" class="form-label">Nível de Log</label>
                            <select class="form-select" id="log-level" name="log_level">
                                <option value="DEBUG" {% if config.log_level == 'DEBUG' %}selected{% endif %}>DEBUG</option>
                                <option value="INFO" {% if config.log_level == 'INFO' %}selected{% endif %}>INFO</option>
                                <option value="WARNING" {% if config.log_level == 'WARNING' %}selected{% endif %}>WARNING</option>
                                <option value="ERROR" {% if config.log_level == 'ERROR' %}selected{% endif %}>ERROR</option>
                            </select>
                            <div class="form-text">
                                Nível de detalhamento dos logs do sistema
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="cache-size" class="form-label">Tamanho do Cache (MB)</label>
                            <input type="number" class="form-control" id="cache-size" name="cache_size" 
                                   value="{{ config.cache_size or 100 }}" min="10" max="1000">
                            <div class="form-text">
                                Tamanho máximo do cache em memória
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="max-concurrent" class="form-label">Máximo de Análises Simultâneas</label>
                            <input type="number" class="form-control" id="max-concurrent" name="max_concurrent" 
                                   value="{{ config.max_concurrent or 5 }}" min="1" max="20">
                            <div class="form-text">
                                Número máximo de análises executadas em paralelo
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="session-timeout" class="form-label">Timeout de Sessão (minutos)</label>
                            <input type="number" class="form-control" id="session-timeout" name="session_timeout" 
                                   value="{{ config.session_timeout or 60 }}" min="5" max="480">
                            <div class="form-text">
                                Tempo de inatividade antes de expirar a sessão
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Opções de Desenvolvimento</h6>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="debug-mode" name="debug_mode" 
                                   {% if config.debug_mode %}checked{% endif %}>
                            <label class="form-check-label" for="debug-mode">
                                Modo de depuração (DEBUG)
                            </label>
                        </div>
                        
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="log-requests" name="log_requests" 
                                   {% if config.log_requests %}checked{% endif %}>
                            <label class="form-check-label" for="log-requests">
                                Registrar todas as requisições HTTP
                            </label>
                        </div>
                        
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="cache-enabled" name="cache_enabled" 
                                   {% if config.cache_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="cache-enabled">
                                Ativar cache de resultados
                            </label>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Ações de Sistema</h6>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-warning" onclick="limparCache()">
                                <i class="bi bi-trash"></i>
                                Limpar Cache
                            </button>
                            <button type="button" class="btn btn-outline-info" onclick="exportarConfiguracoes()">
                                <i class="bi bi-download"></i>
                                Exportar Configurações
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="importarConfiguracoes()">
                                <i class="bi bi-upload"></i>
                                Importar Configurações
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Status do Sistema -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-activity"></i>
                    Status do Sistema
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="border-end">
                            <div class="d-flex align-items-center justify-content-center">
                                <i class="bi bi-circle-fill text-success me-1"></i>
                                <small id="provider-api-status">
                                    {% if provedor_atual == 'azure' %}
                                        Azure OpenAI
                                    {% else %}
                                        OpenAI API
                                    {% endif %}
                                </small>
                            </div>
                            <small class="text-muted" id="status-provider">Conectado</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="bi bi-circle-fill text-success me-1"></i>
                            <small>Sistema</small>
                        </div>
                        <small class="text-muted" id="status-sistema">Operacional</small>
                    </div>
                </div>
                
                <hr>
                
                <div class="small text-muted">
                    <div class="mb-2">
                        <strong>Versão:</strong> <span id="versao-sistema">1.0.0</span>
                    </div>
                    <div class="mb-2">
                        <strong>Uptime:</strong> <span id="uptime-sistema">2h 15m</span>
                    </div>
                    <div class="mb-2">
                        <strong>Uso de Memória:</strong> <span id="memoria-sistema">45 MB</span>
                    </div>
                    <div class="mb-2">
                        <strong>Espaço em Disco:</strong> <span id="disco-sistema">1.2 GB disponível</span>
                    </div>
                    <div class="mb-2">
                        <strong>Última Análise:</strong> <span id="ultima-analise">há 5 minutos</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informações de Uso -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-graph-up"></i>
                    Uso da API
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="border-end">
                            <h6 class="text-primary mb-0" id="chamadas-hoje">127</h6>
                            <small class="text-muted">Chamadas Hoje</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h6 class="text-success mb-0" id="custo-hoje">$2.45</h6>
                        <small class="text-muted">Custo Hoje</small>
                    </div>
                </div>
                
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="border-end">
                            <h6 class="text-info mb-0" id="chamadas-mes">3,421</h6>
                            <small class="text-muted">Chamadas Este Mês</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h6 class="text-warning mb-0" id="custo-mes">$68.42</h6>
                        <small class="text-muted">Custo Este Mês</small>
                    </div>
                </div>
                
                <div class="progress mb-2">
                    <div class="progress-bar" role="progressbar" style="width: 34%" id="progress-limite">
                        34% do limite mensal
                    </div>
                </div>
                
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i>
                    Limite mensal: $200.00
                </small>
            </div>
        </div>

        <!-- Ações Rápidas -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-lightning"></i>
                    Ações Rápidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="testarConexao()">
                        <i class="bi bi-wifi"></i>
                        Testar Conexão OpenAI
                    </button>
                    
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="criarBackupManual()">
                        <i class="bi bi-download"></i>
                        Backup Manual
                    </button>
                    
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="verificarAtualizacoes()">
                        <i class="bi bi-arrow-up-circle"></i>
                        Verificar Atualizações
                    </button>
                    
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="limparCache()">
                        <i class="bi bi-trash"></i>
                        Limpar Cache
                    </button>
                    
                    <hr>
                    
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="resetarSistema()">
                        <i class="bi bi-arrow-clockwise"></i>
                        Resetar Sistema
                    </button>
                </div>
            </div>
        </div>

        <!-- Logs Recentes -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">
                    <i class="bi bi-journal-text"></i>
                    Logs Recentes
                </h6>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="atualizarLogs()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <div class="card-body">
                <div id="logs-container" style="max-height: 200px; overflow-y: auto;">
                    <div class="small text-muted mb-1">
                        <span class="badge bg-success">INFO</span>
                        <span class="text-muted">12:34:56</span>
                        Sistema iniciado com sucesso
                    </div>
                    <div class="small text-muted mb-1">
                        <span class="badge bg-primary">DEBUG</span>
                        <span class="text-muted">12:35:12</span>
                        Conexão com OpenAI estabelecida
                    </div>
                    <div class="small text-muted mb-1">
                        <span class="badge bg-info">INFO</span>
                        <span class="text-muted">12:36:45</span>
                        Análise executada com sucesso
                    </div>
                    <div class="small text-muted mb-1">
                        <span class="badge bg-warning">WARNING</span>
                        <span class="text-muted">12:37:23</span>
                        Cache próximo do limite
                    </div>
                    <div class="small text-muted mb-1">
                        <span class="badge bg-success">INFO</span>
                        <span class="text-muted">12:38:01</span>
                        Backup automático criado
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Reset -->
<div class="modal fade" id="modalResetConfirmacao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning"></i>
                    Confirmar Reset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja restaurar as configurações padrão?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Atenção:</strong> Esta ação irá:
                    <ul class="mb-0">
                        <li>Restaurar todas as configurações para os valores padrão</li>
                        <li>Limpar a chave da API OpenAI</li>
                        <li>Resetar preferências de interface</li>
                        <li>Manter os dados (intimações, prompts, análises)</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="confirmarReset()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Restaurar Padrões
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Seção de Backup do Banco -->
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-database"></i>
                    Backup do Banco de Dados
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Backup do Banco SQLite</strong>
                    <br>
                    Faça o download do banco de dados completo para backup ou análise local.
                    <br>
                    O arquivo contém todos os dados: prompts, intimações e análises.
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-grid mb-3">
                            <button type="button" class="btn btn-warning" onclick="fazerBackupBanco()">
                                <i class="bi bi-download"></i>
                                Download do Banco
                            </button>
                        </div>
                        <div class="form-text mb-3">
                            <i class="bi bi-clock"></i>
                            Último backup: <span id="ultimo-backup">Nunca</span>
                        </div>
                        
                        <!-- Restauração de Backup -->
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-upload"></i>
                                    Restaurar Backup
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <strong>Atenção!</strong> A restauração irá substituir todos os dados atuais.
                                </div>
                                <div class="mb-3">
                                    <label for="arquivo-backup" class="form-label">Selecionar arquivo de backup (.db)</label>
                                    <input type="file" class="form-control" id="arquivo-backup" accept=".db" onchange="validarArquivoBackup()">
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-danger" id="btn-restaurar" onclick="restaurarBackup()" disabled>
                                        <i class="bi bi-arrow-clockwise"></i>
                                        Restaurar Banco
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">📊 Estatísticas do Banco</h6>
                                <div id="stats-banco">
                                    <small class="text-muted">Carregando...</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Função para salvar configurações
function salvarConfiguracoes() {
    console.log('=== DEBUG: SALVANDO CONFIGURAÇÕES ===');
    
    const dados = {};
    
    // Função auxiliar para obter valor com segurança
    function getValue(id, type = 'value') {
        const element = document.getElementById(id);
        if (!element) {
            console.warn(`Elemento não encontrado: ${id}`);
            return type === 'checked' ? false : '';
        }
        
        if (type === 'checked') {
            return element.checked;
        } else if (type === 'int') {
            const value = parseInt(element.value) || 0;
            return value;
        } else if (type === 'float') {
            const value = parseFloat(element.value) || 0;
            return value;
        } else {
            return element.value || '';
        }
    }
    
    // OpenAI (chave vem da variável de ambiente)
    dados.modelo_padrao = getValue('modelo-padrao');
    dados.temperatura_padrao = getValue('temperatura-padrao', 'float');
    dados.max_tokens_padrao = getValue('max-tokens-padrao', 'int');
    dados.timeout_padrao = getValue('timeout-padrao', 'int');
    dados.max_retries = getValue('max-retries', 'int');
    dados.retry_delay = getValue('retry-delay', 'int');
    dados.analise_paralela = getValue('analise-paralela', 'int');
    dados.delay_entre_lotes = getValue('delay-entre-lotes', 'float');
    
    // Configurações Gerais
    dados.itens_por_pagina = getValue('itens-por-pagina', 'int');
    dados.formato_data = getValue('formato-data');
    dados.tema = getValue('tema');
    dados.idioma = getValue('idioma');
    dados.portal_defensoria_link = getValue('portal-defensoria-link');
    dados.mostrar_tooltips = getValue('mostrar-tooltips', 'checked');
    dados.animacoes = getValue('animacoes', 'checked');
    dados.sons_notificacao = getValue('sons-notificacao', 'checked');
    dados.auto_save = getValue('auto-save', 'checked');
    
    // Backup
    dados.backup_automatico = getValue('backup-automatico');
    dados.max_backups = getValue('max-backups', 'int');
    dados.diretorio_backup = getValue('diretorio-backup');
    dados.compressao_backup = getValue('compressao-backup');
    
    // Avançado
    dados.log_level = getValue('log-level');
    dados.cache_size = getValue('cache-size', 'int');
    dados.max_concurrent = getValue('max-concurrent', 'int');
    dados.session_timeout = getValue('session-timeout', 'int');
    dados.debug_mode = getValue('debug-mode', 'checked');
    dados.log_requests = getValue('log-requests', 'checked');
    dados.cache_enabled = getValue('cache-enabled', 'checked');
    
    console.log('Dados coletados:', dados);
    
    // Fazer a chamada para o backend
    console.log('Iniciando chamada para o backend...');
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Salvando...';
    button.disabled = true;
    
    fetch('/configuracoes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(dados)
    })
    .then(response => {
        if (response.ok) {
            showToast('Configurações salvas com sucesso!', 'success');
            // Recarregar a página para atualizar os valores
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error('Erro ao salvar configurações');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro ao salvar configurações: ' + error.message, 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Função para testar conexão
function testarConexao() {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Testando...';
    
    fetch('/api/configuracoes/testar-conexao', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Conexão com OpenAI estabelecida com sucesso!', 'success');
        } else {
            showToast(`Erro na conexão: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        showToast(`Erro ao testar conexão: ${error.message}`, 'error');
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

// Função para resetar configurações
function resetarConfiguracoes() {
    const modal = new bootstrap.Modal(document.getElementById('modalResetConfirmacao'));
    modal.show();
}

// Função para confirmar reset
function confirmarReset() {
    // Restaurar valores padrão
    document.getElementById('api-key').value = '';
    document.getElementById('modelo-padrao').value = 'gpt-3.5-turbo';
    document.getElementById('temperatura-padrao').value = '0.7';
    document.getElementById('temp-value').textContent = '0.7';
    document.getElementById('max-tokens-padrao').value = '150';
    document.getElementById('timeout-padrao').value = '30';
    document.getElementById('max-retries').value = '3';
    document.getElementById('retry-delay').value = '1';
    document.getElementById('analise-paralela').value = '1';
    document.getElementById('delay-entre-lotes').value = '0.5';
    
    document.getElementById('itens-por-pagina').value = '25';
    document.getElementById('formato-data').value = 'DD/MM/YYYY';
    document.getElementById('tema').value = 'light';
    document.getElementById('idioma').value = 'pt-BR';
    document.getElementById('portal-defensoria-link').value = '';
    document.getElementById('mostrar-tooltips').checked = true;
    document.getElementById('animacoes').checked = true;
    document.getElementById('sons-notificacao').checked = false;
    document.getElementById('auto-save').checked = true;
    
    document.getElementById('backup-automatico').value = 'weekly';
    document.getElementById('max-backups').value = '10';
    document.getElementById('diretorio-backup').value = './backups';
    document.getElementById('compressao-backup').value = 'zip';
    
    document.getElementById('log-level').value = 'INFO';
    document.getElementById('cache-size').value = '100';
    document.getElementById('max-concurrent').value = '5';
    document.getElementById('session-timeout').value = '60';
    document.getElementById('debug-mode').checked = false;
    document.getElementById('log-requests').checked = false;
    document.getElementById('cache-enabled').checked = true;
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalResetConfirmacao'));
    modal.hide();
    
    showToast('Configurações restauradas para os valores padrão!', 'success');
}

// Função para selecionar diretório
function selecionarDiretorio() {
    // Em uma aplicação real, isso abriria um seletor de diretório
    showToast('Funcionalidade de seleção de diretório será implementada em breve!', 'info');
}

// Função para criar backup manual
function criarBackupManual() {
    showToast('Criando backup manual...', 'info');
    
    setTimeout(() => {
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        showToast(`Backup criado: backup_${timestamp}.zip`, 'success');
    }, 2000);
}

// Função para restaurar backup
function restaurarBackup() {
    // Em uma aplicação real, isso abriria um seletor de arquivo
    showToast('Funcionalidade de restauração será implementada em breve!', 'info');
}

// Função para listar backups
function listarBackups() {
    showToast('Listando backups disponíveis...', 'info');
    
    setTimeout(() => {
        showToast('3 backups encontrados. Verifique o console para detalhes.', 'success');
        console.log('Backups disponíveis:', [
            'backup_2024-01-15.zip',
            'backup_2024-01-14.zip',
            'backup_2024-01-13.zip'
        ]);
    }, 1000);
}

// Função para limpar cache
function limparCache() {
    showToast('Limpando cache do sistema...', 'info');
    
    setTimeout(() => {
        showToast('Cache limpo com sucesso! 45 MB liberados.', 'success');
    }, 1500);
}

// Função para exportar configurações
function exportarConfiguracoes() {
    const config = {
        timestamp: new Date().toISOString(),
        versao: '1.0.0',
        configuracoes: {
            modelo_padrao: document.getElementById('modelo-padrao').value,
            temperatura_padrao: parseFloat(document.getElementById('temperatura-padrao').value),
            max_tokens_padrao: parseInt(document.getElementById('max-tokens-padrao').value),
            itens_por_pagina: parseInt(document.getElementById('itens-por-pagina').value),
            tema: document.getElementById('tema').value,
            idioma: document.getElementById('idioma').value
            // Não incluir chave da API por segurança
        }
    };
    
    const dataStr = JSON.stringify(config, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `configuracoes_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showToast('Configurações exportadas!', 'success');
}

// Função para importar configurações
function importarConfiguracoes() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    
                    // Aplicar configurações importadas
                    if (config.configuracoes) {
                        const cfg = config.configuracoes;
                        
                        if (cfg.modelo_padrao) document.getElementById('modelo-padrao').value = cfg.modelo_padrao;
                        if (cfg.temperatura_padrao) {
                            document.getElementById('temperatura-padrao').value = cfg.temperatura_padrao;
                            document.getElementById('temp-value').textContent = cfg.temperatura_padrao;
                        }
                        if (cfg.max_tokens_padrao) document.getElementById('max-tokens-padrao').value = cfg.max_tokens_padrao;
                        if (cfg.itens_por_pagina) document.getElementById('itens-por-pagina').value = cfg.itens_por_pagina;
                        if (cfg.portal_defensoria_link) document.getElementById('portal-defensoria-link').value = cfg.portal_defensoria_link;
                        if (cfg.tema) document.getElementById('tema').value = cfg.tema;
                        if (cfg.idioma) document.getElementById('idioma').value = cfg.idioma;
                    }
                    
                    showToast('Configurações importadas com sucesso!', 'success');
                } catch (error) {
                    showToast('Erro ao importar configurações. Arquivo inválido.', 'error');
                }
            };
            reader.readAsText(file);
        }
    };
    
    input.click();
}

// Função para verificar atualizações
function verificarAtualizacoes() {
    showToast('Verificando atualizações...', 'info');
    
    setTimeout(() => {
        const temAtualizacao = false; // Sem atualização para teste real
        
        if (temAtualizacao) {
            showToast('Nova versão disponível: v1.1.0', 'info');
        } else {
            showToast('Sistema está atualizado!', 'success');
        }
    }, 2000);
}

// Função para salvar preços OpenAI
function salvarPrecosOpenAI() {
    const formData = new FormData(document.getElementById('form-precos-openai'));
    const data = Object.fromEntries(formData.entries());
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Salvando...';
    button.disabled = true;
    
    fetch('/api/configuracoes/precos-openai', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Preços da OpenAI salvos com sucesso!', 'success');
            // Recarregar a página para atualizar os valores exibidos
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('Erro ao salvar preços: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro ao salvar preços', 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Função para salvar preços Azure
function salvarPrecosAzure() {
    const formData = new FormData(document.getElementById('form-precos-azure'));
    const data = Object.fromEntries(formData.entries());
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Salvando...';
    button.disabled = true;
    
    fetch('/api/configuracoes/precos-azure', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Preços do Azure OpenAI salvos com sucesso!', 'success');
            // Recarregar a página para atualizar os valores exibidos
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('Erro ao salvar preços: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro ao salvar preços', 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Função para restaurar preços padrão OpenAI
function restaurarPrecosOpenAI() {
    if (confirm('Tem certeza que deseja restaurar os preços padrão da OpenAI?')) {
        // Preços padrão baseados na tabela oficial da OpenAI (Janeiro 2025)
        document.getElementById('openai-gpt4o-input').value = '2.50';
        document.getElementById('openai-gpt4o-output').value = '10.00';
        document.getElementById('openai-gpt4o-mini-input').value = '0.15';
        document.getElementById('openai-gpt4o-mini-output').value = '0.60';
        document.getElementById('openai-gpt4-turbo-input').value = '10.00';
        document.getElementById('openai-gpt4-turbo-output').value = '30.00';
        document.getElementById('openai-gpt35-turbo-input').value = '0.50';
        document.getElementById('openai-gpt35-turbo-output').value = '1.50';
        document.getElementById('data-atualizacao-openai').value = new Date().toISOString().split('T')[0];
        
        showToast('Preços padrão da OpenAI restaurados!', 'success');
    }
}

// Função para restaurar preços padrão Azure
function restaurarPrecosAzure() {
    if (confirm('Tem certeza que deseja restaurar os preços padrão do Azure OpenAI?')) {
        // Preços padrão baseados na tabela oficial do Azure OpenAI (Janeiro 2025)
        document.getElementById('azure-gpt4o-input').value = '5.00';
        document.getElementById('azure-gpt4o-output').value = '15.00';
        document.getElementById('azure-gpt4o-mini-input').value = '0.165';
        document.getElementById('azure-gpt4o-mini-output').value = '0.66';
        document.getElementById('azure-gpt4-turbo-input').value = '10.00';
        document.getElementById('azure-gpt4-turbo-output').value = '30.00';
        document.getElementById('azure-gpt35-turbo-input').value = '0.50';
        document.getElementById('azure-gpt35-turbo-output').value = '1.50';
        document.getElementById('data-atualizacao-azure').value = new Date().toISOString().split('T')[0];
        
        showToast('Preços padrão do Azure OpenAI restaurados!', 'success');
    }
}

// Função para resetar sistema
function resetarSistema() {
    showToast('Funcionalidade de reset completo será implementada em breve!', 'warning');
}

// Função para atualizar logs
function atualizarLogs() {
    showToast('Atualizando logs...', 'info');
    
    setTimeout(() => {
        const agora = new Date();
        const timestamp = agora.toTimeString().split(' ')[0];
        
        const novoLog = `
            <div class="small text-muted mb-1">
                <span class="badge bg-info">INFO</span>
                <span class="text-muted">${timestamp}</span>
                Logs atualizados manualmente
            </div>
        `;
        
        const container = document.getElementById('logs-container');
        container.insertAdjacentHTML('afterbegin', novoLog);
        
        showToast('Logs atualizados!', 'success');
    }, 1000);
}

// Atualizar informações do sistema periodicamente
setInterval(() => {
    // Simular atualização de uptime
    const uptimeElement = document.getElementById('uptime-sistema');
    if (uptimeElement) {
        const match = uptimeElement.textContent.match(/(\d+)h (\d+)m/);
        if (match) {
            let horas = parseInt(match[1]);
            let minutos = parseInt(match[2]) + 1;
            
            if (minutos >= 60) {
                horas++;
                minutos = 0;
            }
            
            uptimeElement.textContent = `${horas}h ${minutos}m`;
        }
    }
    
    // Simular atualização de uso de memória
    const memoriaElement = document.getElementById('memoria-sistema');
    if (memoriaElement) {
        const uso = 45; // Uso fixo para teste real
        memoriaElement.textContent = `${uso.toFixed(0)} MB`;
    }
}, 60000); // Atualizar a cada minuto

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    // Ctrl+S para salvar
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        salvarConfiguracoes();
    }
    
    // Ctrl+T para testar conexão
    if (e.ctrlKey && e.key === 't') {
        e.preventDefault();
        testarConexao();
    }
    
    // Ctrl+B para backup
    if (e.ctrlKey && e.key === 'b') {
        e.preventDefault();
        criarBackupManual();
    }
});

// Validação em tempo real
document.getElementById('api-key').addEventListener('input', function() {
    const valor = this.value;
    if (valor && !valor.startsWith('sk-')) {
        this.classList.add('is-invalid');
    } else {
        this.classList.remove('is-invalid');
    }
});

// Função para alterar provedor de IA
function alterarProvedor() {
    const select = document.getElementById('ai-provider');
    const provedor = select.value;
    const status = document.getElementById('provider-status');
    const providerApiStatus = document.getElementById('provider-api-status');
    
    // Atualizar status visual
    status.textContent = select.options[select.selectedIndex].text.split(' (')[0];
    
    // Atualizar status do provedor na seção Status do Sistema
    if (providerApiStatus) {
        if (provedor === 'azure') {
            providerApiStatus.textContent = 'Azure OpenAI';
        } else {
            providerApiStatus.textContent = 'OpenAI API';
        }
    }
    
    // Mostrar/ocultar seções de configuração baseado no provedor
    const openaiConfig = document.getElementById('openai-config');
    const azureConfig = document.getElementById('azure-config');
    
    // Ocultar todas as seções primeiro
    openaiConfig.style.display = 'none';
    azureConfig.style.display = 'none';
    
    if (provedor === 'openai') {
        openaiConfig.style.display = 'block';
        status.className = 'badge bg-success';
    } else if (provedor === 'azure') {
        azureConfig.style.display = 'block';
        status.className = 'badge bg-success';
    } else {
        status.className = 'badge bg-warning';
    }
    
    // Salvar configuração do provedor
    fetch('/api/configuracoes/provedor', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            provider: provedor
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Provedor alterado com sucesso!', 'success');
        } else {
            showToast('Erro ao alterar provedor: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro ao alterar provedor', 'error');
    });
}

// Função para alternar visibilidade da senha
function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(`${inputId}-icon`);

    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

// Aplicar tema quando mudado
document.getElementById('tema').addEventListener('change', function() {
    const tema = this.value;
    
    if (tema === 'dark') {
        document.body.setAttribute('data-bs-theme', 'dark');
    } else if (tema === 'light') {
        document.body.setAttribute('data-bs-theme', 'light');
    } else {
        // Auto - detectar preferência do sistema
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.setAttribute('data-bs-theme', 'dark');
        } else {
            document.body.setAttribute('data-bs-theme', 'light');
        }
    }
});

// Função para testar conexão Azure
function testarConexaoAzure() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Testando...';
    button.disabled = true;
    
    // Como as credenciais estão no .env, enviamos uma requisição sem dados
    // O backend usará as variáveis de ambiente diretamente
    fetch('/api/configuracoes/testar-azure', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            use_env_credentials: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Conexão com Azure OpenAI estabelecida com sucesso!', 'success');
        } else {
            showToast('Erro na conexão: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro ao testar conexão', 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Função para salvar configurações Azure
function salvarConfiguracaoAzure() {
    const formData = new FormData(document.getElementById('form-azure'));
    const data = Object.fromEntries(formData.entries());
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Salvando...';
    button.disabled = true;
    
    fetch('/api/configuracoes/azure', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Configurações do Azure salvas com sucesso!', 'success');
        } else {
            showToast('Erro ao salvar configurações: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro ao salvar configurações', 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Carregar preços da API nos campos
function carregarPrecosAPI() {
    // Função auxiliar para definir valor se o elemento existir
    function setValueIfExists(id, value) {
        const element = document.getElementById(id);
        if (element) {
            element.value = value || '';
        }
    }
    
    // Carregar preços OpenAI (comentado temporariamente para evitar erros de lint)
    // const precosOpenai = {{ precos_openai | tojson | safe }};
    // if (precosOpenai && typeof precosOpenai === 'object') {
    //     if (precosOpenai['gpt-4o']) {
    //         setValueIfExists('openai-gpt4o-input', precosOpenai['gpt-4o'].input);
    //         setValueIfExists('openai-gpt4o-output', precosOpenai['gpt-4o'].output);
    //     }
    //     if (precosOpenai['gpt-4o-mini']) {
    //         setValueIfExists('openai-gpt4o-mini-input', precosOpenai['gpt-4o-mini'].input);
    //         setValueIfExists('openai-gpt4o-mini-output', precosOpenai['gpt-4o-mini'].output);
    //     }
    //     if (precosOpenai['gpt-4-turbo']) {
    //         setValueIfExists('openai-gpt4-turbo-input', precosOpenai['gpt-4-turbo'].input);
    //         setValueIfExists('openai-gpt4-turbo-output', precosOpenai['gpt-4-turbo'].output);
    //     }
    //     if (precosOpenai['gpt-3.5-turbo']) {
    //         setValueIfExists('openai-gpt35-turbo-input', precosOpenai['gpt-3.5-turbo'].input);
    //         setValueIfExists('openai-gpt35-turbo-output', precosOpenai['gpt-3.5-turbo'].output);
    //     }
    //     setValueIfExists('openai-data-atualizacao', precosOpenai.data_atualizacao);
    // }
    
    // Carregar preços Azure (comentado temporariamente para evitar erros de lint)
    // const precosAzure = {{ precos_azure | tojson | safe }};
    // if (precosAzure && typeof precosAzure === 'object') {
    //     if (precosAzure['gpt-4o']) {
    //         setValueIfExists('azure-gpt4o-input', precosAzure['gpt-4o'].input);
    //         setValueIfExists('azure-gpt4o-output', precosAzure['gpt-4o'].output);
    //     }
    //     if (precosAzure['gpt-4o-mini']) {
    //         setValueIfExists('azure-gpt4o-mini-input', precosAzure['gpt-4o-mini'].input);
    //         setValueIfExists('azure-gpt4o-mini-output', precosAzure['gpt-4o-mini'].output);
    //     }
    //     if (precosAzure['gpt-4-turbo']) {
    //         setValueIfExists('azure-gpt4-turbo-input', precosAzure['gpt-4-turbo'].input);
    //         setValueIfExists('azure-gpt4-turbo-output', precosAzure['gpt-4-turbo'].output);
    //     }
    //     if (precosAzure['gpt-3.5-turbo']) {
    //         setValueIfExists('azure-gpt35-turbo-input', precosAzure['gpt-3.5-turbo'].input);
    //         setValueIfExists('azure-gpt35-turbo-output', precosAzure['gpt-3.5-turbo'].output);
    //     }
    //     setValueIfExists('azure-data-atualizacao', precosAzure.data_atualizacao);
    // }
}

// Inicializar configurações do provedor na carga da página
document.addEventListener('DOMContentLoaded', function() {
    const provedor = '{{ provedor_atual }}';
    const openaiConfig = document.getElementById('openai-config');
    const azureConfig = document.getElementById('azure-config');
    
    // Ocultar todas as seções primeiro
    openaiConfig.style.display = 'none';
    azureConfig.style.display = 'none';
    
    // Mostrar/ocultar seções baseado no provedor atual
    if (provedor === 'openai') {
        openaiConfig.style.display = 'block';
    } else if (provedor === 'azure') {
        azureConfig.style.display = 'block';
    }
    
    // Carregar preços da API
    carregarPrecosAPI();
    
    // Carregar estatísticas do banco
    carregarStatsBanco();
})

// Função para fazer backup do banco
function fazerBackupBanco() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Preparando...';
    button.disabled = true;
    
    fetch('/api/backup/banco', {
        method: 'GET'
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            throw new Error('Erro ao gerar backup');
        }
    })
    .then(blob => {
        // Criar link para download
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `database_backup_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.db`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showToast('Backup do banco baixado com sucesso!', 'success');
        
        // Atualizar timestamp do último backup
        document.getElementById('ultimo-backup').textContent = new Date().toLocaleString('pt-BR');
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro ao fazer backup do banco', 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Função para carregar estatísticas do banco
function carregarStatsBanco() {
    fetch('/api/backup/stats')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const stats = data.stats;
            document.getElementById('stats-banco').innerHTML = `
                <div class="row">
                    <div class="col-6">
                        <small><strong>Prompts:</strong> ${stats.prompts}</small><br>
                        <small><strong>Intimações:</strong> ${stats.intimacoes}</small>
                    </div>
                    <div class="col-6">
                        <small><strong>Análises:</strong> ${stats.analises}</small><br>
                        <small><strong>Tamanho:</strong> ${stats.tamanho_mb} MB</small>
                    </div>
                </div>
            `;
        } else {
            document.getElementById('stats-banco').innerHTML = '<small class="text-danger">Erro ao carregar</small>';
        }
    })
    .catch(error => {
        console.error('Erro ao carregar stats:', error);
        document.getElementById('stats-banco').innerHTML = '<small class="text-danger">Erro ao carregar</small>';
    });
}

// Função para validar arquivo de backup
function validarArquivoBackup() {
    const input = document.getElementById('arquivo-backup');
    const btnRestaurar = document.getElementById('btn-restaurar');
    const file = input.files[0];
    
    if (!file) {
        btnRestaurar.disabled = true;
        return;
    }
    
    // Validar extensão
    if (!file.name.toLowerCase().endsWith('.db')) {
        showToast('Selecione um arquivo .db válido', 'error');
        input.value = '';
        btnRestaurar.disabled = true;
        return;
    }
    
    // Validar tamanho (máximo 100MB)
    const maxSize = 100 * 1024 * 1024; // 100MB
    if (file.size > maxSize) {
        showToast('Arquivo muito grande. Máximo 100MB.', 'error');
        input.value = '';
        btnRestaurar.disabled = true;
        return;
    }
    
    // Habilitar botão de restauração
    btnRestaurar.disabled = false;
    showToast(`Arquivo válido: ${file.name}`, 'success');
}

// Função para restaurar backup
function restaurarBackup() {
    const input = document.getElementById('arquivo-backup');
    const btnRestaurar = document.getElementById('btn-restaurar');
    const file = input.files[0];
    
    if (!file) {
        showToast('Selecione um arquivo de backup primeiro', 'error');
        return;
    }
    
    // Confirmar restauração
    if (!confirm('ATENÇÃO! Esta operação irá substituir todos os dados atuais do banco.\n\nTem certeza que deseja continuar?')) {
        return;
    }
    
    // Preparar formulário
    const formData = new FormData();
    formData.append('backup_file', file);
    
    // Desabilitar botão e mostrar loading
    const originalText = btnRestaurar.innerHTML;
    btnRestaurar.innerHTML = '<i class="bi bi-hourglass-split"></i> Restaurando...';
    btnRestaurar.disabled = true;
    
    fetch('/api/backup/restaurar', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Backup restaurado com sucesso! A página será recarregada.', 'success');
            
            // Limpar input
            input.value = '';
            btnRestaurar.disabled = true;
            
            // Recarregar estatísticas
            setTimeout(() => {
                carregarStatsBanco();
            }, 1000);
            
            // Recarregar página após 2 segundos
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            throw new Error(data.message || 'Erro ao restaurar backup');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast(`Erro ao restaurar backup: ${error.message}`, 'error');
    })
    .finally(() => {
        btnRestaurar.innerHTML = originalText;
        btnRestaurar.disabled = false;
    });
}
</script>
{% endblock %}