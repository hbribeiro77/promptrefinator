{% extends "base.html" %}

{% block title %}Análise de Prompts - Sistema Analisador de Prompts{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-cpu"></i>
        Análise de Prompts
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparFormulario()">
                <i class="bi bi-arrow-clockwise"></i>
                Limpar
            </button>
            <button type="button" class="btn btn-sm btn-outline-info" onclick="carregarExemplo()">
                <i class="bi bi-lightbulb"></i>
                Exemplo
            </button>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-sm btn-secondary" onclick="testeSimples()" style="margin-right: 10px;">
                <i class="bi bi-bug"></i>
                Teste JS
            </button>
            <button type="button" class="btn btn-sm btn-primary" onclick="executarAnalise()" id="btn-executar">
                <i class="bi bi-play-circle"></i>
                Executar Análise
            </button>
            <button type="button" class="btn btn-sm btn-secondary ms-2" onclick="testarLoading()">
                <i class="bi bi-hourglass"></i>
                Testar Loading
            </button>
        </div>
    </div>
</div>

<div class="row">
            <div class="col-12">
        <!-- Formulário de Análise -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear"></i>
                    Configuração da Análise
                </h5>
            </div>
            <div class="card-body">
                <form id="form-analise">
                    <!-- Configurações da OpenAI -->
                    <div class="mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="toggleOpenAIConfig()">
                                <h6 class="mb-0">
                                    <i class="bi bi-sliders"></i>
                                    Configurações da OpenAI
                                </h6>
                                <div>
                                    <span class="badge bg-primary me-2" id="config-summary">GPT-4, Temp: 0</span>
                                    <i class="bi bi-chevron-down" id="openai-toggle-icon"></i>
                                </div>
                            </div>
                            <div class="card-body" id="openai-config-content" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="modelo" class="form-label">Modelo</label>
                                        <select class="form-select" id="modelo" name="modelo" onchange="atualizarConfigSummary()">
                                            {% for modelo in modelos_disponiveis %}
                                            <option value="{{ modelo }}" {% if modelo == modelo_padrao %}selected{% endif %}>
                                                {{ modelo }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="temperatura" class="form-label">
                                            Temperatura 
                                            <span class="text-muted">(<span id="temp-value">0</span>)</span>
                                        </label>
                                        <input type="range" class="form-range" id="temperatura" name="temperatura" 
                                               min="0" max="2" step="0.1" value="0" 
                                               oninput="document.getElementById('temp-value').textContent = this.value; atualizarConfigSummary()">
                                        <div class="form-text">
                                            0 = Mais determinístico, 2 = Mais criativo
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <label for="max-tokens" class="form-label">Máximo de Tokens</label>
                                        <input type="number" class="form-control" id="max-tokens" name="max_tokens" 
                                               value="{{ max_tokens_padrao }}" min="1" max="4000">
                                        <div class="form-text">
                                            Limite de tokens para a resposta da IA
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="timeout" class="form-label">Timeout (segundos)</label>
                                        <input type="number" class="form-control" id="timeout" name="timeout" 
                                               value="30" min="5" max="120">
                                        <div class="form-text">
                                            Tempo limite para cada chamada da API
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seleção de Prompt -->
                    <div class="mb-4">
                        <label for="prompt-selecionado" class="form-label">
                            <i class="bi bi-code-square"></i>
                            Prompt para Testar
                            <span class="text-danger">*</span>
                        </label>
                        <div class="row">
                            <div class="col-md-8">
                                <select class="form-select" id="prompt-selecionado" name="prompt_id" required>
                                    <option value="">Selecione um prompt...</option>
                                    {% for prompt in prompts %}
                                    <option value="{{ prompt.id }}" 
                                            {% if request.args.get('prompt_id') == prompt.id %}selected{% endif %}>
                                        {{ prompt.nome }} ({{ prompt.conteudo | length }} chars)
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    Escolha um prompt para testar com as intimações selecionadas.
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-grid gap-2">
                                    <a href="{{ url_for('novo_prompt') }}" class="btn btn-outline-success btn-sm">
                                        <i class="bi bi-plus-circle"></i>
                                        Novo Prompt
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preview do Prompt Selecionado -->
                        <div id="prompt-preview" class="mt-3" style="display: none;">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-code-square"></i>
                                        Preview do Prompt
                                    </h6>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-info me-2" onclick="mostrarPromptModal()">
                                            <i class="bi bi-eye"></i>
                                            Ver Completo
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="togglePromptPreview()">
                                            <i class="bi bi-chevron-up" id="toggle-icon"></i>
                                            <span id="toggle-text">Colapsar</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body" id="prompt-preview-content">
                                    <pre id="prompt-content" class="mb-0"></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seleção de Intimações -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label mb-0">
                            <i class="bi bi-file-text"></i>
                            Intimações para Analisar
                            <span class="text-danger">*</span>
                        </label>
                            <div class="d-flex gap-2">
                                <span id="intimacoes-count" class="badge bg-primary">0 selecionada(s)</span>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="selecionarTodasIntimacoes()">
                                        <i class="bi bi-check-all"></i>
                                    Todas
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limparSelecaoIntimacoes()">
                                        <i class="bi bi-x-circle"></i>
                                    Limpar
                                    </button>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="filtrarPorClassificacao()">
                                        <i class="bi bi-funnel"></i>
                                        Filtrar
                                    </button>
                                    <a href="{{ url_for('nova_intimacao') }}" class="btn btn-outline-success btn-sm">
                                        <i class="bi bi-plus-circle"></i>
                                    Nova
                                    </a>
                        </div>
                    </div>

                        <!-- Lista de Intimações -->
                        <div class="card">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th width="50">
                                                    <input type="checkbox" id="select-all-intimacoes" onchange="toggleSelectAllIntimacoes()">
                                                </th>
                                                <th>Contexto</th>
                                                <th width="200">Classificação Manual</th>
                                                <th width="150">Data de Criação</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for intimacao in intimacoes %}
                                            <tr>
                                                <td>
                                                    <input type="checkbox" class="intimacao-checkbox" 
                                                           value="{{ intimacao.id }}" 
                                                           data-classificacao="{{ intimacao.classificacao_manual or '' }}"
                                                           onchange="updateIntimacoesSelection()">
                                                </td>
                                                <td>
                                                    <div class="text-truncate-custom" title="{{ intimacao.contexto }}">
                                                        {{ intimacao.contexto }}
                                                    </div>
                                                    {% if intimacao.informacoes_adicionais %}
                                                        <small class="text-muted">
                                                            <i class="bi bi-info-circle"></i>
                                                            {{ intimacao.informacoes_adicionais[:100] }}{% if intimacao.informacoes_adicionais | length > 100 %}...{% endif %}
                                                        </small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% set badge_class = {
                                                        'URGÊNCIA': 'danger',
                                                        'ELABORAR PEÇA': 'success',
                                                        'ANALISAR PROCESSO': 'info',
                                                        'CONTATAR ASSISTIDO': 'warning',
                                                        'RENUNCIAR PRAZO': 'secondary',
                                                        'OCULTAR': 'dark',
                                                        'ENCAMINHAR INTIMAÇÃO PARA OUTRO DEFENSOR': 'primary'
                                                    } %}
                                                    <span class="badge bg-{{ badge_class.get(intimacao.classificacao_manual, 'secondary') }}">
                                                        {{ intimacao.classificacao_manual or 'N/A' }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <small class="text-muted">
                                                        {% if intimacao.data_criacao %}
                                                            {% set data = intimacao.data_criacao.split('T')[0] if 'T' in intimacao.data_criacao else intimacao.data_criacao %}
                                                            {% set hora = intimacao.data_criacao.split('T')[1][:8] if 'T' in intimacao.data_criacao else '' %}
                                                            {{ data.split('-')[2] }}/{{ data.split('-')[1] }}/{{ data.split('-')[0] }}{% if hora %} {{ hora }}{% endif %}
                                                        {% else %}
                                                            N/A
                                                        {% endif %}
                                                    </small>
                                                </td>
                                            </tr>
                                    {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Opções Avançadas (Ocultas) -->
                    <div style="display: none;">
                        <input class="form-check-input" type="checkbox" id="salvar-resultados" name="salvar_resultados" checked>
                        <input class="form-check-input" type="checkbox" id="calcular-acuracia" name="calcular_acuracia" checked>
                        <input class="form-check-input" type="checkbox" id="modo-paralelo" name="modo_paralelo">
                    </div>

                </form>
            </div>
        </div>

        <!-- Resultados da Análise -->
        <div class="card" id="card-resultados" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clipboard-data"></i>
                    Resultados da Análise
                </h5>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-info me-2" onclick="toggleConfiguracoesColunas()">
                        <i class="bi bi-gear"></i>
                        Colunas
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="exportarResultados()">
                        <i class="bi bi-download"></i>
                        Exportar
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparResultados()">
                        <i class="bi bi-x-circle"></i>
                        Limpar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Configuração de Colunas -->
                <div id="config-colunas" class="mb-4" style="display: none;">
                    <div class="card">
            <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-columns"></i>
                                Configurar Colunas Visíveis
                </h6>
            </div>
            <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-intimacao" checked>
                                        <label class="form-check-label" for="col-intimacao">
                                            Intimação
                                        </label>
                </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-classificacao-manual" checked>
                                        <label class="form-check-label" for="col-classificacao-manual">
                                            Classificação Manual
                                        </label>
                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-informacao-adicional" checked>
                                        <label class="form-check-label" for="col-informacao-adicional">
                                            Informação Adicional
                                        </label>
                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-resultado-ia" checked>
                                        <label class="form-check-label" for="col-resultado-ia">
                                            Resultado IA
                                        </label>
                </div>
                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-status" checked>
                                        <label class="form-check-label" for="col-status">
                                            Status
                                        </label>
                </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-configuracoes" checked>
                                        <label class="form-check-label" for="col-configuracoes">
                                            Configurações
                                        </label>
            </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-tempo" checked>
                                        <label class="form-check-label" for="col-tempo">
                                            Tempo
                                        </label>
        </div>
            </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-custo" checked>
                                        <label class="form-check-label" for="col-custo">
                                            Custo
                                        </label>
                        </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-prompt" checked>
                                        <label class="form-check-label" for="col-prompt">
                                            Prompt
                                        </label>
                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-resposta" checked>
                                        <label class="form-check-label" for="col-resposta">
                                            Resposta
                                        </label>
                    </div>
                </div>
                                <div class="col-md-3">
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodasColunas()">
                                            <i class="bi bi-check-all"></i>
                                            Todas
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparSelecaoColunas()">
                                            <i class="bi bi-x-circle"></i>
                                            Nenhuma
                                        </button>
                                        <button type="button" class="btn btn-sm btn-success" onclick="salvarConfiguracaoColunas()">
                                            <i class="bi bi-check-circle"></i>
                                            Salvar
                                        </button>
                    </div>
                </div>
                    </div>
                    </div>
                    </div>
                    </div>

                <!-- Resumo Geral -->
                <div id="resumo-geral" class="mb-4" style="display: none;">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border-end">
                                <h4 class="text-primary mb-0" id="total-testes">0</h4>
                                <small class="text-muted">Total de Testes</small>
                </div>
            </div>
                        <div class="col-md-3">
                            <div class="border-end">
                                <h4 class="text-success mb-0" id="acertos">0</h4>
                                <small class="text-muted">Acertos</small>
        </div>
            </div>
                        <div class="col-md-3">
                            <div class="border-end">
                                <h4 class="text-danger mb-0" id="erros">0</h4>
                                <small class="text-muted">Erros</small>
                    </div>
                    </div>
                        <div class="col-md-3">
                            <h4 class="text-info mb-0" id="acuracia-geral">0%</h4>
                            <small class="text-muted">Acurácia</small>
                    </div>
                    </div>
                    </div>
                
                <!-- Detalhes dos Resultados -->
                <div id="resultados-container">
                    <!-- Resultados serão inseridos aqui via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Filtro por Classificação -->
<div class="modal fade" id="modalFiltro" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-funnel text-info"></i>
                    Filtrar Intimações por Classificação
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Selecione as classificações:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="filtro-todas" checked>
                        <label class="form-check-label" for="filtro-todas">
                            <strong>Todas as classificações</strong>
                        </label>
                    </div>
                    <hr>
                    {% for tipo in tipos_acao %}
                    <div class="form-check">
                        <input class="form-check-input filtro-classificacao" type="checkbox" id="filtro-{{ loop.index }}" value="{{ tipo }}" checked>
                        <label class="form-check-label" for="filtro-{{ loop.index }}">
                            {{ tipo }}
                        </label>
                    </div>
                    {% endfor %}
                    <div class="form-check">
                        <input class="form-check-input filtro-classificacao" type="checkbox" id="filtro-sem-classificacao" value="" checked>
                        <label class="form-check-label" for="filtro-sem-classificacao">
                            <em>Sem classificação</em>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="aplicarFiltro()">
                    <i class="bi bi-funnel"></i>
                    Aplicar Filtro
                </button>
            </div>
        </div>
    </div>
</div>

{% include 'partials/modais_prompt_resposta.html' %}

<!-- Modal para mostrar Prompt Selecionado -->
<div class="modal fade" id="modalPrompt" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-code-square text-primary"></i>
                    Prompt Selecionado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="modal-prompt-content" class="bg-light p-3 rounded" style="max-height: 500px; overflow-y: auto; white-space: pre-wrap;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-outline-primary" onclick="copiarPromptModal()">
                    <i class="bi bi-clipboard"></i>
                    Copiar
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<!-- Overlay de Loading -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner">
            <div class="ai-brain">
                <div class="brain-pulse"></div>
                <div class="brain-pulse"></div>
                <div class="brain-pulse"></div>
            </div>
        </div>
        <div class="loading-text">
            <h4 class="text-white mb-3">🤖 IA Analisando...</h4>
            <p class="text-white-50 mb-0">Processando intimações com inteligência artificial</p>
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>
</div>
<style>
    .text-truncate-custom {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.1);
    }
    
    .intimacao-checkbox:checked + td {
        background-color: rgba(40, 167, 69, 0.1);
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: 99999;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(10px);
        opacity: 1;
        visibility: visible;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .loading-overlay.hidden {
        opacity: 0;
        visibility: hidden;
    }

    .loading-content {
        text-align: center;
        color: white;
    }

    .loading-spinner {
        margin-bottom: 2rem;
    }

    /* AI Brain Animation */
    .ai-brain {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .brain-pulse {
        position: absolute;
        width: 20px;
        height: 20px;
        background: #fff;
        border-radius: 50%;
        animation: brainPulse 2s infinite;
    }

    .brain-pulse:nth-child(1) {
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        animation-delay: 0s;
    }

    .brain-pulse:nth-child(2) {
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        animation-delay: 0.6s;
    }

    .brain-pulse:nth-child(3) {
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        animation-delay: 1.2s;
    }

    @keyframes brainPulse {
        0%, 100% {
            opacity: 0.3;
            transform: scale(0.8);
        }
        50% {
            opacity: 1;
            transform: scale(1.2);
        }
    }

    /* Loading Dots */
    .loading-dots {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 1rem;
    }

    .loading-dots span {
        width: 8px;
        height: 8px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 50%;
        animation: loadingDots 1.4s infinite ease-in-out;
    }

    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    .loading-dots span:nth-child(3) { animation-delay: 0s; }

    @keyframes loadingDots {
        0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Smooth Scroll */
    html {
        scroll-behavior: smooth;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
console.log('=== DEBUG: Script de análise carregado ===');

// Variáveis globais
let analiseAtual = null;
let resultadosAnalise = [];
const promptsData = {{ prompts | tojson | safe }};
let dadosCompletos = {}; // Objeto para armazenar prompt e resposta completos

// Configuração de colunas
let configuracaoColunas = {
    intimacao: true,
    classificacao_manual: true,
    informacao_adicional: true,
    resultado_ia: true,
    status: true,
    configuracoes: true,
    tempo: true,
    custo: true,
    prompt: true,
    resposta: true
};

// Função para alternar configurações da OpenAI
function toggleOpenAIConfig() {
    const content = document.getElementById('openai-config-content');
    const icon = document.getElementById('openai-toggle-icon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'bi bi-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
    }
}

// Função para atualizar resumo das configurações
function atualizarConfigSummary() {
    const modelo = document.getElementById('modelo').value;
    const temperatura = document.getElementById('temperatura').value;
    const summary = document.getElementById('config-summary');
    
    summary.textContent = `${modelo}, Temp: ${temperatura}`;
}

// Função para mostrar preview do prompt
function mostrarPreviewPrompt(promptId) {
    const prompt = promptsData.find(p => p.id === promptId);
    
    if (prompt) {
        document.getElementById('prompt-content').textContent = prompt.conteudo;
        document.getElementById('prompt-preview').style.display = 'block';
        // Por padrão, mostrar colapsado
        colapsarPromptPreview();
    }
}

// Função para alternar preview do prompt (expandir/colapsar)
function togglePromptPreview() {
    const content = document.getElementById('prompt-preview-content');
    const icon = document.getElementById('toggle-icon');
    const text = document.getElementById('toggle-text');
    
    if (content.style.display === 'none') {
        expandirPromptPreview();
    } else {
        colapsarPromptPreview();
    }
}

// Função para expandir preview do prompt
function expandirPromptPreview() {
    const content = document.getElementById('prompt-preview-content');
    const icon = document.getElementById('toggle-icon');
    const text = document.getElementById('toggle-text');
    
    content.style.display = 'block';
    icon.className = 'bi bi-chevron-up';
    text.textContent = 'Colapsar';
}

// Função para colapsar preview do prompt
function colapsarPromptPreview() {
    const content = document.getElementById('prompt-preview-content');
    const icon = document.getElementById('toggle-icon');
    const text = document.getElementById('toggle-text');
    
    content.style.display = 'none';
    icon.className = 'bi bi-chevron-down';
    text.textContent = 'Expandir';
}

// Função para mostrar prompt em modal
function mostrarPromptModal() {
    const promptSelecionado = document.getElementById('prompt-selecionado');
    if (promptSelecionado.value) {
        const prompt = promptsData.find(p => p.id === promptSelecionado.value);
        if (prompt) {
            document.getElementById('modal-prompt-content').textContent = prompt.conteudo;
            const modal = new bootstrap.Modal(document.getElementById('modalPrompt'));
            modal.show();
        }
    }
}

// Função para atualizar contador de seleção
function updateIntimacoesSelection() {
    const checkboxes = document.querySelectorAll('.intimacao-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('intimacoes-count').textContent = count + ' selecionada(s)';
    
    // Atualizar checkbox "selecionar todas"
    const selectAll = document.getElementById('select-all-intimacoes');
    const totalCheckboxes = document.querySelectorAll('.intimacao-checkbox');
    selectAll.checked = count === totalCheckboxes.length && totalCheckboxes.length > 0;
    selectAll.indeterminate = count > 0 && count < totalCheckboxes.length;
    
    atualizarResumo();
}

// Função para alternar seleção de todas as intimações
function toggleSelectAllIntimacoes() {
    const selectAll = document.getElementById('select-all-intimacoes');
    const checkboxes = document.querySelectorAll('.intimacao-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = selectAll.checked);
    updateIntimacoesSelection();
}

// Função para selecionar todas as intimações
function selecionarTodasIntimacoes() {
    const checkboxes = document.querySelectorAll('.intimacao-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = true);
    updateIntimacoesSelection();
}

// Função para limpar seleção de intimações
function limparSelecaoIntimacoes() {
    const checkboxes = document.querySelectorAll('.intimacao-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    updateIntimacoesSelection();
}

// Função para mostrar loading
function mostrarLoading() {
    console.log('=== DEBUG: Mostrando loading ===');
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'flex';
        overlay.style.opacity = '1';
        overlay.style.visibility = 'visible';
        overlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Bloquear scroll
        console.log('=== DEBUG: Loading overlay ativado ===');
    } else {
        console.error('=== ERRO: Loading overlay não encontrado ===');
    }
}

// Função para esconder loading
function esconderLoading() {
    console.log('=== DEBUG: Escondendo loading ===');
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'none';
        overlay.style.opacity = '0';
        overlay.style.visibility = 'hidden';
        overlay.classList.add('hidden');
        document.body.style.overflow = 'auto'; // Restaurar scroll
        console.log('=== DEBUG: Loading overlay desativado ===');
    } else {
        console.error('=== ERRO: Loading overlay não encontrado ===');
    }
}

// Função para testar loading
function testarLoading() {
    console.log('=== DEBUG: Testando loading ===');
    mostrarLoading();
    
    // Simular processamento por 3 segundos
    setTimeout(() => {
        esconderLoading();
        showToast('Teste de loading concluído!', 'success');
    }, 3000);
}

// Função para scroll suave para resultados
function scrollParaResultados() {
    const resultadosContainer = document.getElementById('resultados-container');
    if (resultadosContainer) {
        resultadosContainer.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }
}

// Função para executar análise
function executarAnalise() {
    console.log('=== DEBUG: executarAnalise chamada ===');
    const promptSelecionado = document.getElementById('prompt-selecionado').value;
    const intimacoesSelecionadas = Array.from(document.querySelectorAll('.intimacao-checkbox:checked')).map(cb => cb.value);
    
    if (!promptSelecionado) {
        showToast('Selecione um prompt!', 'error');
        return;
    }
    
    if (intimacoesSelecionadas.length === 0) {
        showToast('Selecione pelo menos uma intimação!', 'error');
        return;
    }
    
    const dados = {
        prompt_id: promptSelecionado,
        intimacao_ids: intimacoesSelecionadas,
        configuracoes: {
            modelo: document.getElementById('modelo').value,
            temperatura: parseFloat(document.getElementById('temperatura').value),
            max_tokens: parseInt(document.getElementById('max-tokens').value),
            timeout: parseInt(document.getElementById('timeout').value),
            salvar_resultados: document.getElementById('salvar-resultados').checked,
            calcular_acuracia: document.getElementById('calcular-acuracia').checked,
            modo_paralelo: document.getElementById('modo-paralelo').checked
        }
    };
    
    // Mostrar loading antes de iniciar
    mostrarLoading();
    iniciarAnalise(dados);
}

// Atualizar contadores quando seleções mudarem
const promptSelecionado = document.getElementById('prompt-selecionado');
const intimacoesSelecionadas = document.getElementById('intimacoes-selecionadas');
const modelo = document.getElementById('modelo');
const temperatura = document.getElementById('temperatura');
const maxTokens = document.getElementById('max-tokens');

if (promptSelecionado) promptSelecionado.addEventListener('change', atualizarResumo);
if (intimacoesSelecionadas) intimacoesSelecionadas.addEventListener('change', atualizarResumo);
if (modelo) modelo.addEventListener('change', atualizarResumo);
if (temperatura) temperatura.addEventListener('change', atualizarResumo);
if (maxTokens) maxTokens.addEventListener('change', atualizarResumo);

// Função para atualizar resumo da configuração
function atualizarResumo() {
    const promptSelecionado = document.getElementById('prompt-selecionado');
    const intimacoesSelecionadas = document.querySelectorAll('.intimacao-checkbox:checked').length;
    const totalAnalises = intimacoesSelecionadas;
    
    // Atualizar contadores (se existirem)
    const intimacoesCount = document.getElementById('intimacoes-count');
    if (intimacoesCount) {
        intimacoesCount.textContent = intimacoesSelecionadas + ' selecionada(s)';
    }
    
    // Atualizar nome do prompt
    if (promptSelecionado.value) {
        // Mostrar preview do prompt
        mostrarPreviewPrompt(promptSelecionado.value);
    } else {
        const promptPreview = document.getElementById('prompt-preview');
        if (promptPreview) {
            promptPreview.style.display = 'none';
        }
    }
}

// Função para mostrar preview do prompt
function mostrarPreviewPrompt(promptId) {
    const prompt = promptsData.find(p => p.id === promptId);
    
    if (prompt) {
        document.getElementById('prompt-content').textContent = prompt.conteudo;
        document.getElementById('prompt-preview').style.display = 'block';
        // Por padrão, mostrar colapsado
        colapsarPromptPreview();
    }
}

// Função para alternar preview do prompt (expandir/colapsar)
function togglePromptPreview() {
    const content = document.getElementById('prompt-preview-content');
    const icon = document.getElementById('toggle-icon');
    const text = document.getElementById('toggle-text');
    
    if (content.style.display === 'none') {
        expandirPromptPreview();
    } else {
        colapsarPromptPreview();
    }
}

// Função para expandir preview do prompt
function expandirPromptPreview() {
    const content = document.getElementById('prompt-preview-content');
    const icon = document.getElementById('toggle-icon');
    const text = document.getElementById('toggle-text');
    
    content.style.display = 'block';
    icon.className = 'bi bi-chevron-up';
    text.textContent = 'Colapsar';
}

// Função para colapsar preview do prompt
function colapsarPromptPreview() {
    const content = document.getElementById('prompt-preview-content');
    const icon = document.getElementById('toggle-icon');
    const text = document.getElementById('toggle-text');
    
    content.style.display = 'none';
    icon.className = 'bi bi-chevron-down';
    text.textContent = 'Expandir';
}

// Função para mostrar prompt em modal
function mostrarPromptModal() {
    const promptSelecionado = document.getElementById('prompt-selecionado');
    if (promptSelecionado.value) {
        const prompt = promptsData.find(p => p.id === promptSelecionado.value);
        if (prompt) {
            document.getElementById('modal-prompt-content').textContent = prompt.conteudo;
            const modal = new bootstrap.Modal(document.getElementById('modalPrompt'));
            modal.show();
        }
    }
}

// Função para alternar configurações da OpenAI
function toggleOpenAIConfig() {
    const content = document.getElementById('openai-config-content');
    const icon = document.getElementById('openai-toggle-icon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'bi bi-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
    }
}

// Função para alternar configurações de colunas
function toggleConfiguracoesColunas() {
    const configDiv = document.getElementById('config-colunas');
    if (configDiv.style.display === 'none') {
        configDiv.style.display = 'block';
        carregarConfiguracaoColunas();
    } else {
        configDiv.style.display = 'none';
    }
}

// Função para carregar configuração de colunas
function carregarConfiguracaoColunas() {
    const configSalva = localStorage.getItem('configuracaoColunas');
    if (configSalva) {
        configuracaoColunas = JSON.parse(configSalva);
    }
    
    // Aplicar configuração aos checkboxes
            document.getElementById('col-intimacao').checked = configuracaoColunas.intimacao;
        document.getElementById('col-classificacao-manual').checked = configuracaoColunas.classificacao_manual;
        document.getElementById('col-informacao-adicional').checked = configuracaoColunas.informacao_adicional;
        document.getElementById('col-resultado-ia').checked = configuracaoColunas.resultado_ia;
    document.getElementById('col-status').checked = configuracaoColunas.status;
    document.getElementById('col-configuracoes').checked = configuracaoColunas.configuracoes;
    document.getElementById('col-tempo').checked = configuracaoColunas.tempo;
    document.getElementById('col-custo').checked = configuracaoColunas.custo;
    document.getElementById('col-prompt').checked = configuracaoColunas.prompt;
    document.getElementById('col-resposta').checked = configuracaoColunas.resposta;
}

// Função para selecionar todas as colunas
function selecionarTodasColunas() {
    const checkboxes = document.querySelectorAll('#config-colunas input[type="checkbox"]');
    checkboxes.forEach(checkbox => checkbox.checked = true);
}

// Função para limpar seleção de colunas
function limparSelecaoColunas() {
    const checkboxes = document.querySelectorAll('#config-colunas input[type="checkbox"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
}

// Função para salvar configuração de colunas
function salvarConfiguracaoColunas() {
    configuracaoColunas = {
        intimacao: document.getElementById('col-intimacao').checked,
        classificacao_manual: document.getElementById('col-classificacao-manual').checked,
        informacao_adicional: document.getElementById('col-informacao-adicional').checked,
        resultado_ia: document.getElementById('col-resultado-ia').checked,
        status: document.getElementById('col-status').checked,
        configuracoes: document.getElementById('col-configuracoes').checked,
        tempo: document.getElementById('col-tempo').checked,
        custo: document.getElementById('col-custo').checked,
        prompt: document.getElementById('col-prompt').checked,
        resposta: document.getElementById('col-resposta').checked
    };
    
    localStorage.setItem('configuracaoColunas', JSON.stringify(configuracaoColunas));
    
    // Reaplicar configuração se há resultados
    if (resultadosAnalise.length > 0) {
        exibirResultados();
    }
    
    // Fechar configuração
    document.getElementById('config-colunas').style.display = 'none';
    
    showToast('Configuração de colunas salva!', 'success');
}

// Função para atualizar resumo das configurações
function atualizarConfigSummary() {
    const modelo = document.getElementById('modelo').value;
    const temperatura = document.getElementById('temperatura').value;
    const summary = document.getElementById('config-summary');
    
    summary.textContent = `${modelo}, Temp: ${temperatura}`;
}



// Função para selecionar todas as intimações
function selecionarTodasIntimacoes() {
    const checkboxes = document.querySelectorAll('.intimacao-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = true);
    updateIntimacoesSelection();
}

// Função para limpar seleção de intimações
function limparSelecaoIntimacoes() {
    const checkboxes = document.querySelectorAll('.intimacao-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    updateIntimacoesSelection();
}



// Função para filtrar por classificação
function filtrarPorClassificacao() {
    const modal = new bootstrap.Modal(document.getElementById('modalFiltro'));
    modal.show();
}

// Função para aplicar filtro
function aplicarFiltro() {
    const todasMarcadas = document.getElementById('filtro-todas').checked;
    const classificacoesSelecionadas = [];
    
    if (!todasMarcadas) {
        const checkboxes = document.querySelectorAll('.filtro-classificacao:checked');
        checkboxes.forEach(cb => classificacoesSelecionadas.push(cb.value));
    }
    
    const select = document.getElementById('intimacoes-selecionadas');
    for (let option of select.options) {
        const classificacao = option.dataset.classificacao || '';
        
        if (todasMarcadas || classificacoesSelecionadas.includes(classificacao)) {
            option.style.display = '';
        } else {
            option.style.display = 'none';
            option.selected = false;
        }
    }
    
    atualizarResumo();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalFiltro'));
    modal.hide();
    
    showToast('Filtro aplicado com sucesso!', 'success');
}

// Função para carregar exemplo
function carregarExemplo() {
    // Selecionar primeiro prompt e primeira intimação
    const promptSelect = document.getElementById('prompt-selecionado');
    const intimacaoSelect = document.getElementById('intimacoes-selecionadas');
    
    if (promptSelect.options.length > 1) {
        promptSelect.selectedIndex = 1; // Primeiro prompt (pula a opção vazia)
    }
    
    if (intimacaoSelect.options.length > 0) {
        intimacaoSelect.options[0].selected = true;
    }
    
    // Configurar parâmetros de exemplo
    document.getElementById('temperatura').value = '0.2';
    document.getElementById('temp-value').textContent = '0.2';
    document.getElementById('max-tokens').value = '150';
    
    atualizarResumo();
    showToast('Exemplo carregado!', 'info');
}

// Função para limpar formulário
function limparFormulario() {
    document.getElementById('prompt-selecionado').value = '';
    limparSelecaoIntimacoes();
    
    document.getElementById('temperatura').value = '{{ temperatura_padrao }}';
    document.getElementById('temp-value').textContent = '{{ temperatura_padrao }}';
    document.getElementById('max-tokens').value = '{{ max_tokens_padrao }}';
    document.getElementById('timeout').value = '30';
    
    document.getElementById('salvar-resultados').checked = true;
    document.getElementById('calcular-acuracia').checked = true;
    document.getElementById('modo-paralelo').checked = false;
    
    atualizarResumo();
    limparResultados();
    
    showToast('Formulário limpo!', 'info');
}

// Função para executar análise
function executarAnalise() {
    console.log('=== DEBUG: executarAnalise chamada ===');
    const promptSelecionado = document.getElementById('prompt-selecionado').value;
    const intimacoesSelecionadas = Array.from(document.querySelectorAll('.intimacao-checkbox:checked')).map(cb => cb.value);
    
    if (!promptSelecionado) {
        showToast('Selecione um prompt!', 'error');
        return;
    }
    
    if (intimacoesSelecionadas.length === 0) {
        showToast('Selecione pelo menos uma intimação!', 'error');
        return;
    }
    
    const dados = {
        prompt_id: promptSelecionado,
        intimacao_ids: intimacoesSelecionadas,
        configuracoes: {
        modelo: document.getElementById('modelo').value,
        temperatura: parseFloat(document.getElementById('temperatura').value),
        max_tokens: parseInt(document.getElementById('max-tokens').value),
        timeout: parseInt(document.getElementById('timeout').value),
        salvar_resultados: document.getElementById('salvar-resultados').checked,
        calcular_acuracia: document.getElementById('calcular-acuracia').checked,
        modo_paralelo: document.getElementById('modo-paralelo').checked
        }
    };
    
    iniciarAnalise(dados);
}

// Função para iniciar análise
function iniciarAnalise(dados) {
    // Mostrar loading
    mostrarLoading();
    
    // Desabilitar botão
    const btnExecutar = document.getElementById('btn-executar');
    btnExecutar.disabled = true;
    btnExecutar.innerHTML = '<i class="bi bi-hourglass-split"></i> Executando...';
    
    // Limpar resultados anteriores
    limparResultados();
    
    // Executar análise real no backend
    executarAnaliseReal(dados);
}

// Função para executar análise real
function executarAnaliseReal(dados) {
    console.log('=== DEBUG: executarAnaliseReal chamada com dados:', dados);
    
    // Fazer chamada real para o backend
    fetch('/executar-analise', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dados)
    })
    .then(response => {
        console.log('=== DEBUG: Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('=== DEBUG: Dados recebidos do backend:', data);
        
        if (data.success) {
            // Converter dados do backend para o formato esperado
            resultadosAnalise = data.resultados.map(resultado => ({
                prompt_id: resultado.prompt_id,
                prompt_nome: resultado.prompt_nome,
                intimacao_id: resultado.intimacao_id,
                resultado_ia: resultado.resultado_ia,
                classificacao_manual: resultado.classificacao_manual,
                informacao_adicional: resultado.informacao_adicional,
                tempo_processamento: resultado.tempo_processamento,
                acertou: resultado.acertou,
                custo_estimado: resultado.custo_estimado,
                prompt_completo: resultado.prompt_completo,
                resposta_completa: resultado.resposta_completa,
                modelo: resultado.modelo,
                temperatura: resultado.temperatura
            }));
            
            finalizarAnalise();
        } else {
            throw new Error(data.error || 'Erro desconhecido');
        }
    })
    .catch(error => {
        console.error('=== ERRO na análise:', error);
        
        // Esconder loading
        esconderLoading();
        
        // Reabilitar botão
        const btnExecutar = document.getElementById('btn-executar');
        btnExecutar.disabled = false;
        btnExecutar.innerHTML = '<i class="bi bi-play-circle"></i> Executar Análise';
        
        showToast('Erro na análise: ' + error.message, 'error');
    });
}

// Função para finalizar análise
function finalizarAnalise() {
    const totalAnalises = resultadosAnalise.length;
    const acertos = resultadosAnalise.filter(r => r.acertou).length;
    const acuracia = totalAnalises > 0 ? (acertos / totalAnalises * 100).toFixed(1) : 0;
    
    // Esconder loading
    esconderLoading();
    
    // Reabilitar botão
    const btnExecutar = document.getElementById('btn-executar');
    btnExecutar.disabled = false;
    btnExecutar.innerHTML = '<i class="bi bi-play-circle"></i> Executar Análise';
    
    // Mostrar resultados
    exibirResultados();
    
    // Scroll suave para os resultados
    setTimeout(() => {
        scrollParaResultados();
    }, 100);
    
    showToast(`${totalAnalises} análises concluídas. Acurácia: ${acuracia}%`, 'success');
}

// Função para exibir resultados
function exibirResultados() {
    const container = document.getElementById('resultados-container');
    const cardResultados = document.getElementById('card-resultados');
    
    if (resultadosAnalise.length === 0) {
        cardResultados.style.display = 'none';
        return;
    }
    
    // Calcular estatísticas
    const totalAnalises = resultadosAnalise.length;
    const acertos = resultadosAnalise.filter(r => r.acertou).length;
    const erros = totalAnalises - acertos;
    const acuracia = totalAnalises > 0 ? (acertos / totalAnalises * 100).toFixed(1) : 0;
    const tempoMedio = (resultadosAnalise.reduce((sum, r) => sum + r.tempo_processamento, 0) / totalAnalises).toFixed(2);
    const custoTotal = resultadosAnalise.reduce((sum, r) => sum + r.custo_estimado, 0).toFixed(4);
    
    // Atualizar resumo geral
    document.getElementById('resumo-geral').style.display = 'block';
    document.getElementById('total-testes').textContent = totalAnalises;
    document.getElementById('acertos').textContent = acertos;
    document.getElementById('erros').textContent = erros;
    document.getElementById('acuracia-geral').textContent = acuracia + '%';
    
    // Carregar configuração de colunas
    const configSalva = localStorage.getItem('configuracaoColunas');
    if (configSalva) {
        configuracaoColunas = JSON.parse(configSalva);
    }
    
    let html = `
        <!-- Detalhes dos Resultados -->
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        ${configuracaoColunas.intimacao ? '<th>Intimação</th>' : ''}
                        ${configuracaoColunas.classificacao_manual ? '<th>Classificação Manual</th>' : ''}
                        ${configuracaoColunas.informacao_adicional ? '<th>Informação Adicional</th>' : ''}
                        ${configuracaoColunas.resultado_ia ? '<th>Resultado IA</th>' : ''}
                        ${configuracaoColunas.status ? '<th>Status</th>' : ''}
                        ${configuracaoColunas.configuracoes ? '<th>Configurações</th>' : ''}
                        ${configuracaoColunas.tempo ? '<th>Tempo</th>' : ''}
                        ${configuracaoColunas.custo ? '<th>Custo</th>' : ''}
                        ${configuracaoColunas.prompt ? '<th>Prompt</th>' : ''}
                        ${configuracaoColunas.resposta ? '<th>Resposta</th>' : ''}
                    </tr>
                </thead>
                <tbody>
    `;
    
    resultadosAnalise.forEach(resultado => {
        console.log('=== DEBUG: Processando resultado:', resultado);
        console.log('=== DEBUG: Modelo:', resultado.modelo);
        console.log('=== DEBUG: Temperatura:', resultado.temperatura);
        console.log('=== DEBUG: Informação Adicional:', resultado.informacao_adicional);
        
        const statusClass = resultado.acertou ? 'text-success' : 'text-danger';
        const statusIcon = resultado.acertou ? 'bi-check-circle' : 'bi-x-circle';
        const statusText = resultado.acertou ? 'Acertou' : 'Errou';
        
        // Armazenar dados completos no objeto global
        dadosCompletos[resultado.intimacao_id] = {
            prompt_completo: resultado.prompt_completo || 'N/A',
            resposta_completa: resultado.resposta_completa || 'N/A'
        };
        
        html += `
            <tr>
                ${configuracaoColunas.intimacao ? `<td>#${resultado.intimacao_id.substring(0, 8)}...</td>` : ''}
                ${configuracaoColunas.classificacao_manual ? `<td><span class="badge bg-secondary">${resultado.classificacao_manual || 'N/A'}</span></td>` : ''}
                ${configuracaoColunas.informacao_adicional ? `<td>
                    ${resultado.informacao_adicional ? 
                        `<small class="text-muted">
                            ${resultado.informacao_adicional.length > 100 ? 
                                resultado.informacao_adicional.substring(0, 100) + '...' : 
                                resultado.informacao_adicional
                            }
                        </small>` : 
                        '<small class="text-muted">N/A</small>'
                    }
                </td>` : ''}
                ${configuracaoColunas.resultado_ia ? `<td><span class="badge bg-primary">${resultado.resultado_ia || 'N/A'}</span></td>` : ''}
                ${configuracaoColunas.status ? `<td><i class="bi ${statusIcon} ${statusClass}"></i> ${statusText}</td>` : ''}
                ${configuracaoColunas.configuracoes ? `<td>
                    <small>
                        <div><strong>Modelo:</strong> ${resultado.modelo || 'N/A'}</div>
                        <div><strong>Temp:</strong> ${resultado.temperatura !== undefined && resultado.temperatura !== null ? parseFloat(resultado.temperatura).toFixed(1) : 'N/A'}</div>
                    </small>
                </td>` : ''}
                ${configuracaoColunas.tempo ? `<td>${(resultado.tempo_processamento || 0).toFixed(2)}s</td>` : ''}
                ${configuracaoColunas.custo ? `<td>$${(resultado.custo_estimado || 0).toFixed(4)}</td>` : ''}
                ${configuracaoColunas.prompt ? `<td>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="mostrarPromptCompleto('${resultado.intimacao_id}')">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>` : ''}
                ${configuracaoColunas.resposta ? `<td>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="mostrarRespostaCompleta('${resultado.intimacao_id}')">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>` : ''}
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        
        <!-- Estatísticas Detalhadas -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h4>${tempoMedio}s</h4>
                        <small>Tempo Médio</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h4>$${custoTotal}</h4>
                        <small>Custo Total</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h4>${resultadosAnalise[0].prompt_nome}</h4>
                        <small>Prompt Testado</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-secondary text-white">
                    <div class="card-body text-center">
                        <h4>${document.getElementById('modelo').value}</h4>
                        <small>Modelo Usado</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    cardResultados.style.display = 'block';
}

// Função para limpar resultados
function limparResultados() {
    resultadosAnalise = [];
    const cardResultados = document.getElementById('card-resultados');
    if (cardResultados) {
        cardResultados.style.display = 'none';
    }
}

// Função para exportar resultados
function exportarResultados() {
    if (resultadosAnalise.length === 0) {
        showToast('Nenhum resultado para exportar!', 'warning');
        return;
    }
    
    const dados = {
        timestamp: new Date().toISOString(),
        total_analises: resultadosAnalise.length,
        acuracia_geral: (resultadosAnalise.filter(r => r.acertou).length / resultadosAnalise.length * 100).toFixed(1),
        tempo_medio: (resultadosAnalise.reduce((sum, r) => sum + r.tempo_processamento, 0) / resultadosAnalise.length).toFixed(2),
        custo_total: resultadosAnalise.reduce((sum, r) => sum + r.custo_estimado, 0).toFixed(4),
        resultados: resultadosAnalise
    };
    
    const dataStr = JSON.stringify(dados, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `analise_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showToast('Resultados exportados!', 'success');
}

// Controle do filtro "todas"
const filtroTodas = document.getElementById('filtro-todas');
if (filtroTodas) {
    filtroTodas.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.filtro-classificacao');
    checkboxes.forEach(cb => {
        cb.checked = this.checked;
        cb.disabled = this.checked;
    });
});
}

// Controle dos filtros individuais
document.querySelectorAll('.filtro-classificacao').forEach(cb => {
    cb.addEventListener('change', function() {
        const todasMarcadas = document.querySelectorAll('.filtro-classificacao:checked').length === document.querySelectorAll('.filtro-classificacao').length;
        const filtroTodas = document.getElementById('filtro-todas');
        if (filtroTodas) filtroTodas.checked = todasMarcadas;
    });
});

// Atalhos de teclado




// Teste simples para verificar se o JavaScript está funcionando
function testeSimples() {
    console.log('=== TESTE SIMPLES FUNCIONANDO ===');
    alert('JavaScript está funcionando!');
}

// Funções para mostrar prompt e resposta completos
function mostrarPromptCompleto(intimacaoId) {
    console.log('=== DEBUG: mostrarPromptCompleto chamada ===');
    console.log('Intimação ID:', intimacaoId);
    console.log('Dados completos:', dadosCompletos);
    
    const dados = dadosCompletos[intimacaoId];
    const promptCompleto = dados ? dados.prompt_completo : 'N/A';
    
    console.log('Prompt completo:', promptCompleto);
    console.log('Prompt completo length:', promptCompleto ? promptCompleto.length : 'null');
    
    const elementoId = document.getElementById('prompt-intimacao-id');
    const elementoConteudo = document.getElementById('prompt-completo-conteudo');
    
    console.log('Elemento ID encontrado:', elementoId);
    console.log('Elemento conteúdo encontrado:', elementoConteudo);
    
    if (elementoId) elementoId.textContent = intimacaoId;
    if (elementoConteudo) elementoConteudo.textContent = promptCompleto;
    
    const modal = new bootstrap.Modal(document.getElementById('modalPromptCompleto'));
    modal.show();
}

function mostrarRespostaCompleta(intimacaoId) {
    console.log('=== DEBUG: mostrarRespostaCompleta chamada ===');
    console.log('Intimação ID:', intimacaoId);
    console.log('Dados completos:', dadosCompletos);
    
    const dados = dadosCompletos[intimacaoId];
    const respostaCompleta = dados ? dados.resposta_completa : 'N/A';
    
    console.log('Resposta completa:', respostaCompleta);
    console.log('Resposta completa length:', respostaCompleta ? respostaCompleta.length : 'null');
    
    const elementoId = document.getElementById('resposta-intimacao-id');
    const elementoConteudo = document.getElementById('resposta-completa-conteudo');
    
    console.log('Elemento ID encontrado:', elementoId);
    console.log('Elemento conteúdo encontrado:', elementoConteudo);
    
    if (elementoId) elementoId.textContent = intimacaoId;
    if (elementoConteudo) elementoConteudo.textContent = respostaCompleta;
    
    const modal = new bootstrap.Modal(document.getElementById('modalRespostaCompleta'));
    modal.show();
}

function copiarPrompt() {
    const conteudo = document.getElementById('prompt-completo-conteudo').textContent;
    navigator.clipboard.writeText(conteudo).then(() => {
        showToast('Prompt copiado para a área de transferência!', 'success');
    });
}

function copiarPromptModal() {
    const conteudo = document.getElementById('modal-prompt-content').textContent;
    navigator.clipboard.writeText(conteudo).then(() => {
        showToast('Prompt copiado para a área de transferência!', 'success');
    });
}

function copiarResposta() {
    const conteudo = document.getElementById('resposta-completa-conteudo').textContent;
    navigator.clipboard.writeText(conteudo).then(() => {
        showToast('Resposta copiada para a área de transferência!', 'success');
    });
}

// Inicializar resumo
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOMContentLoaded executado ===');
    atualizarResumo();
    atualizarConfigSummary();
    carregarConfiguracaoColunas();
    
    // Adicionar event listeners para atalhos de teclado
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter para executar
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        executarAnalise();
    }
    
    // Ctrl+R para limpar
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        limparFormulario();
    }
    
    // Ctrl+E para exemplo
    if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        carregarExemplo();
    }
});
});
</script>
{% endblock %}