{% extends "base.html" %}

{% block title %}Análise de Prompts - Sistema Analisador de Prompts{% endblock %}

{% block extra_head %}
<!-- Marked.js será carregado no final da página -->
<style>
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-cpu"></i>
        Análise de Prompts
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparFormulario()">
                <i class="bi bi-arrow-clockwise"></i>
                Limpar
            </button>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-sm btn-primary" onclick="executarAnalise()" id="btn-executar">
                <i class="bi bi-play-circle"></i>
                Executar Análise
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <!-- Informação do Provedor Atual -->
        <div class="alert alert-info mb-3" role="alert">
            <i class="bi bi-info-circle"></i>
            <strong>Provedor de IA Ativo:</strong> 
            <span id="provedor-info">
                {% if provedor_atual == 'azure' %}
                    Azure OpenAI
                {% else %}
                    OpenAI
                {% endif %}
            </span>
            <small class="text-muted ms-2">
                (Para alterar o provedor, acesse as <a href="{{ url_for('configuracoes') }}" class="alert-link">Configurações do Sistema</a>)
            </small>
        </div>
    </div>
</div>

<div class="row">
            <div class="col-12">
        <!-- Formulário de Análise -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear"></i>
                    Configuração da Análise
                </h5>
            </div>
            <div class="card-body">
                <form id="form-analise">
                    <!-- Configurações da OpenAI -->
                    <div class="mb-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="toggleOpenAIConfig()">
                                <h6 class="mb-0">
                                    <i class="bi bi-sliders"></i>
                                    <span id="config-provider-title">
                                        {% if provedor_atual == 'azure' %}
                                            Configurações do Azure OpenAI
                                        {% else %}
                                            Configurações da OpenAI
                                        {% endif %}
                                    </span>
                                </h6>
                                <div>
                                    <span class="badge bg-primary me-2" id="config-summary">GPT-4, Temp: 0</span>
                                    <i class="bi bi-chevron-down" id="openai-toggle-icon"></i>
                                </div>
                            </div>
                            <div class="card-body" id="openai-config-content" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="modelo" class="form-label">Modelo</label>
                                        <select class="form-select" id="modelo" name="modelo" onchange="atualizarConfigSummary()">
                                            {% for modelo in modelos_disponiveis %}
                                            <option value="{{ modelo }}" {% if modelo == modelo_padrao %}selected{% endif %}>
                                                {{ modelo }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="temperatura" class="form-label">
                                            Temperatura 
                                            <span class="text-muted">(<span id="temp-value">{{ temperatura_padrao }}</span>)</span>
                                        </label>
                                        <input type="range" class="form-range" id="temperatura" name="temperatura" 
                                               min="0" max="2" step="0.1" value="{{ temperatura_padrao }}" 
                                               oninput="document.getElementById('temp-value').textContent = this.value; atualizarConfigSummary()">
                                        <div class="form-text">
                                            0 = Mais determinístico, 2 = Mais criativo
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <label for="max-tokens" class="form-label">Máximo de Tokens</label>
                                        <input type="number" class="form-control" id="max-tokens" name="max_tokens" 
                                               value="{{ max_tokens_padrao }}" min="1" max="4000">
                                        <div class="form-text">
                                            Limite de tokens para a resposta da IA
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="timeout" class="form-label">Timeout (segundos)</label>
                                        <input type="number" class="form-control" id="timeout" name="timeout" 
                                               value="30" min="5" max="120">
                                        <div class="form-text">
                                            Tempo limite para cada chamada da API
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seleção de Prompt -->
                    <div class="mb-4">
                        <label for="prompt-selecionado" class="form-label">
                            <i class="bi bi-code-square"></i>
                            Prompt para Testar
                            <span class="text-danger">*</span>
                        </label>
                        <div class="row">
                            <div class="col-md-6">
                                <select class="form-select" id="prompt-selecionado" name="prompt_id" required onchange="atualizarBotaoRegrasNegocio()">
                                    <option value="">Selecione um prompt...</option>
                                    {% for prompt in prompts %}
                                    <option value="{{ prompt.id }}" 
                                            {% if request.args.get('prompt_id') == prompt.id %}selected{% endif %}>
                                        {{ prompt.nome }} ({{ prompt.conteudo | length }} chars)
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">
                                    Escolha um prompt para testar com as intimações selecionadas.
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-outline-info btn-sm" id="btn-regras-negocio" 
                                            onclick="visualizarRegrasNegocio()" disabled>
                                        <i class="bi bi-file-earmark-text"></i>
                                        Regras de Negócio
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-grid gap-2">
                                    <a href="{{ url_for('novo_prompt') }}" class="btn btn-outline-success btn-sm">
                                        <i class="bi bi-plus-circle"></i>
                                        Novo Prompt
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preview do Prompt Selecionado -->
                        <div id="prompt-preview" class="mt-3" style="display: none;">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-code-square"></i>
                                        Preview do Prompt
                                    </h6>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-info me-2" onclick="mostrarPromptModal()">
                                            <i class="bi bi-eye"></i>
                                            Ver Completo
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="togglePromptPreview()">
                                            <i class="bi bi-chevron-up" id="toggle-icon"></i>
                                            <span id="toggle-text">Colapsar</span>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body" id="prompt-preview-content">
                                    <pre id="prompt-content" class="mb-0"></pre>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seleção de Intimações -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label mb-0">
                            <i class="bi bi-file-text"></i>
                            Intimações para Analisar
                            <span class="text-danger">*</span>
                        </label>
                            <div class="d-flex gap-2">
                                <span id="intimacoes-count" class="badge bg-primary">0 selecionada(s)</span>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="selecionarTodasIntimacoes()">
                                        <i class="bi bi-check-all"></i>
                                    Todas
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limparSelecaoIntimacoes()">
                                        <i class="bi bi-x-circle"></i>
                                    Limpar
                                    </button>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="filtrarPorClassificacao()">
                                        <i class="bi bi-funnel"></i>
                                        Filtrar
                                    </button>
                                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="configurarColunasIntimacoes()">
                                        <i class="bi bi-gear"></i>
                                        Colunas
                                    </button>
                                    <a href="{{ url_for('nova_intimacao') }}" class="btn btn-outline-success btn-sm">
                                        <i class="bi bi-plus-circle"></i>
                                    Nova
                                    </a>
                        </div>
                    </div>

                        <!-- Lista de Intimações com Cards Compactos -->
                        <div class="card">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover intimacoes-cards-table mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 20px;">
                                                    <input type="checkbox" id="select-all-intimacoes" onchange="toggleSelectAllIntimacoes()">
                                                </th>
                                                <th class="col-checkbox" style="width: 25%;">Card da Intimação</th>
                                                <th class="col-defensor" style="width: 10%;">Defensor</th>
                                                <th class="col-classe" style="width: 10%;">Classe</th>
                                                <th class="col-classificacao" style="width: 12%;">Classificação Manual</th>
                                                <th class="col-informacoes" style="width: 15%;">Informações Adicionais</th>
                                                <th class="col-taxa" style="width: 10%;">Taxa de Acerto</th>
                                                <th class="col-data" style="width: 10%;">Data de Criação</th>
                                                <th class="col-acoes" style="width: 8%;">Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for intimacao in intimacoes %}
                                            <tr class="intimacao-row" data-intimacao-id="{{ intimacao.id }}" data-defensor="{{ intimacao.defensor or '' }}" data-classe="{{ intimacao.classe or '' }}">
                                                <td>
                                                    <input type="checkbox" class="intimacao-checkbox" 
                                                           value="{{ intimacao.id }}" 
                                                           data-classificacao="{{ intimacao.classificacao_manual or '' }}"
                                                           onchange="updateIntimacoesSelection()">
                                                </td>
                                                <td class="col-checkbox card-cell">
                                                    {% include 'partials/card_intimacao_compact.html' %}
                                                </td>
                                                <td class="col-defensor">
                                                    {% if intimacao.defensor %}
                                                    <span class="badge bg-info" title="{{ intimacao.defensor }}">
                                                        {{ intimacao.defensor[:20] }}{% if intimacao.defensor|length > 20 %}...{% endif %}
                                                    </span>
                                                    {% else %}
                                                    <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td class="col-classe">
                                                    {% if intimacao.classe %}
                                                    <span class="badge bg-secondary" title="{{ intimacao.classe }}">
                                                        {{ intimacao.classe[:20] }}{% if intimacao.classe|length > 20 %}...{% endif %}
                                                    </span>
                                                    {% else %}
                                                    <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td class="col-classificacao classificacao-cell">
                                                    {% set badge_class = {
                                                        'URGÊNCIA': 'danger',
                                                        'ELABORAR PEÇA': 'success',
                                                        'ANALISAR PROCESSO': 'info',
                                                        'CONTATAR ASSISTIDO': 'warning',
                                                        'RENUNCIAR PRAZO': 'secondary',
                                                        'OCULTAR': 'dark',
                                                        'ENCAMINHAR INTIMAÇÃO PARA OUTRO DEFENSOR': 'primary'
                                                    } %}
                                                    {% if intimacao.classificacao_manual %}
                                                    <span class="badge bg-{{ badge_class.get(intimacao.classificacao_manual, 'secondary') }}">
                                                        {{ intimacao.classificacao_manual }}
                                                    </span>
                                                    {% else %}
                                                    <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td class="col-informacoes info-cell">
                                                    {% if intimacao.informacao_adicional %}
                                                    <div class="info-adicional-text" title="{{ intimacao.informacao_adicional }}">
                                                        {{ intimacao.informacao_adicional[:80] }}{% if intimacao.informacao_adicional|length > 80 %}...{% endif %}
                                                    </div>
                                                    {% else %}
                                                    <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td class="col-taxa taxa-acerto-cell">
                                                    <div id="taxa-acerto-{{ intimacao.id }}" class="taxa-acerto-placeholder">
                                                        <i class="bi bi-hourglass-split text-muted"></i>
                                                        <small class="text-muted">Carregando...</small>
                                                    </div>
                                                </td>
                                                <td class="col-data data-cell">
                                                    {% if intimacao.data_criacao %}
                                                        {% set data = intimacao.data_criacao.split('T')[0] if 'T' in intimacao.data_criacao else intimacao.data_criacao %}
                                                        {% set hora = intimacao.data_criacao.split('T')[1][:8] if 'T' in intimacao.data_criacao else '' %}
                                                        <small class="text-muted">
                                                            {{ data.split('-')[2] }}/{{ data.split('-')[1] }}/{{ data.split('-')[0] }}{% if hora %}<br>{{ hora }}{% endif %}
                                                        </small>
                                                    {% else %}
                                                        <small class="text-muted">N/A</small>
                                                    {% endif %}
                                                </td>
                                                <td class="col-acoes acoes-cell">
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                                data-intimacao-id="{{ intimacao.id }}" 
                                                                data-contexto="{{ intimacao.contexto|replace('`', '\\`')|replace('\n', '\\n')|replace('\r', '') }}"
                                                                onclick="visualizarContexto(this.dataset.intimacaoId, this.dataset.contexto)"
                                                                title="Visualizar Contexto">
                                                            <i class="bi bi-eye"></i>
                                                        </button>
                                                        <a href="{{ url_for('visualizar_intimacao', id=intimacao.id) }}" 
                                                           class="btn btn-outline-info btn-sm" 
                                                           title="Página Completa">
                                                            <i class="bi bi-file-text"></i>
                                                        </a>
                                                        <button type="button" 
                                                                class="btn btn-outline-danger btn-sm" 
                                                                data-intimacao-id="{{ intimacao.id }}"
                                                                onclick="excluirIntimacaoTabela(this.dataset.intimacaoId)"
                                                                title="Excluir">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Opções Avançadas (Ocultas) -->
                    <div style="display: none;">
                        <input class="form-check-input" type="checkbox" id="salvar-resultados" name="salvar_resultados" checked>
                        <input class="form-check-input" type="checkbox" id="calcular-acuracia" name="calcular_acuracia" checked>
                        <input class="form-check-input" type="checkbox" id="modo-paralelo" name="modo_paralelo">
                    </div>

                </form>
            </div>
        </div>

        <!-- Resultados da Análise -->
        <div class="card" id="card-resultados" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <h5 class="card-title mb-0 me-3">
                        <i class="bi bi-clipboard-data"></i>
                        Resultados da Análise
                    </h5>
                    <span id="contador-resultados-header" class="badge bg-info" style="display: none;">
                        <i class="bi bi-eye"></i>
                        <span id="contador-texto-header">0 de 0</span>
                    </span>
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-info me-2" onclick="toggleConfiguracoesColunas()">
                        <i class="bi bi-gear"></i>
                        Colunas
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="exportarResultados()">
                        <i class="bi bi-download"></i>
                        Exportar
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparResultados()">
                        <i class="bi bi-x-circle"></i>
                        Limpar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Configuração de Colunas -->
                <div id="config-colunas" class="mb-4" style="display: none;">
                    <div class="card">
            <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-columns"></i>
                                Configurar Colunas Visíveis
                </h6>
            </div>
            <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-intimacao" checked>
                                        <label class="form-check-label" for="col-intimacao">
                                            Intimação
                                        </label>
                </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-classificacao-manual" checked>
                                        <label class="form-check-label" for="col-classificacao-manual">
                                            Classificação Manual
                                        </label>
                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-informacao-adicional" checked>
                                        <label class="form-check-label" for="col-informacao-adicional">
                                            Informação Adicional
                                        </label>
                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-resultado-ia" checked>
                                        <label class="form-check-label" for="col-resultado-ia">
                                            Resultado IA
                                        </label>
                </div>
                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-status" checked>
                                        <label class="form-check-label" for="col-status">
                                            Status
                                        </label>
                </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-configuracoes" checked>
                                        <label class="form-check-label" for="col-configuracoes">
                                            Configurações
                                        </label>
            </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-tempo" checked>
                                        <label class="form-check-label" for="col-tempo">
                                            Tempo
                                        </label>
        </div>
            </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-custo" checked>
                                        <label class="form-check-label" for="col-custo">
                                            Custo
                                        </label>
                        </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-tokens-input" checked>
                                        <label class="form-check-label" for="col-tokens-input">
                                            Tokens Input
                                        </label>
                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-tokens-output" checked>
                                        <label class="form-check-label" for="col-tokens-output">
                                            Tokens Output
                                        </label>
                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-prompt" checked>
                                        <label class="form-check-label" for="col-prompt">
                                            Prompt
                                        </label>
                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="col-resposta" checked>
                                        <label class="form-check-label" for="col-resposta">
                                            Resposta
                                        </label>
                    </div>
                </div>
                                <div class="col-md-3">
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodasColunas()">
                                            <i class="bi bi-check-all"></i>
                                            Todas
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparSelecaoColunas()">
                                            <i class="bi bi-x-circle"></i>
                                            Nenhuma
                                        </button>
                                        <button type="button" class="btn btn-sm btn-success" onclick="salvarConfiguracaoColunas()">
                                            <i class="bi bi-check-circle"></i>
                                            Salvar
                                        </button>
                    </div>
                </div>
                    </div>
                    </div>
                    </div>
                    </div>

                <!-- Resumo Geral -->
                <div id="resumo-geral" class="mb-4" style="display: none;">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border-end">
                                <div class="stat-card" onclick="filtrarPorStatus('todos')" style="cursor: pointer;" title="Clique para mostrar todos os resultados">
                                    <h4 class="text-primary mb-0" id="total-testes">0</h4>
                                    <small class="text-muted">Total de Testes</small>
                                    <div class="stat-hover-effect"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-end">
                                <div class="stat-card" onclick="filtrarPorStatus('acertos')" style="cursor: pointer;" title="Clique para mostrar apenas os acertos">
                                    <h4 class="text-success mb-0" id="acertos">0</h4>
                                    <small class="text-muted">Acertos</small>
                                    <div class="stat-hover-effect"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border-end">
                                <div class="stat-card" onclick="filtrarPorStatus('erros')" style="cursor: pointer;" title="Clique para mostrar apenas os erros">
                                    <h4 class="text-danger mb-0" id="erros">0</h4>
                                    <small class="text-muted">Erros</small>
                                    <div class="stat-hover-effect"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" onclick="filtrarPorStatus('todos')" style="cursor: pointer;" title="Clique para mostrar todos os resultados">
                                <h4 class="text-info mb-0" id="acuracia-geral">0%</h4>
                                <small class="text-muted">Acurácia</small>
                                <div class="stat-hover-effect"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Detalhes dos Resultados -->
                <div id="resultados-container">
                    <!-- Resultados serão inseridos aqui via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Filtro -->
<div class="modal fade" id="modalFiltro" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-funnel text-info"></i>
                    Filtrar Intimações
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Filtro por Defensor -->
                <div class="mb-4">
                    <label class="form-label">
                        <i class="bi bi-person-badge text-primary"></i>
                        <strong>Defensor:</strong>
                    </label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="filtro-todos-defensores" checked>
                        <label class="form-check-label" for="filtro-todos-defensores">
                            <strong>Todos os defensores</strong>
                        </label>
                    </div>
                    <hr>
                    <div id="filtros-defensores">
                        <div class="text-center py-3">
                            <i class="bi bi-hourglass-split"></i>
                            Carregando defensores...
                        </div>
                    </div>
                </div>
                
                <!-- Filtro por Classificação -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-tags text-success"></i>
                        <strong>Classificação:</strong>
                    </label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="filtro-todas-classificacoes" checked>
                        <label class="form-check-label" for="filtro-todas-classificacoes">
                            <strong>Todas as classificações</strong>
                        </label>
                    </div>
                    <hr>
                    <div id="filtros-classificacoes">
                        <div class="text-center py-3">
                            <i class="bi bi-hourglass-split"></i>
                            Carregando classificações...
                        </div>
                    </div>
                </div>
                
                <!-- Filtro por Classe -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-book text-warning"></i>
                        <strong>Classe:</strong>
                    </label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="filtro-todas-classes" checked>
                        <label class="form-check-label" for="filtro-todas-classes">
                            <strong>Todas as classes</strong>
                        </label>
                    </div>
                    <hr>
                    <div id="filtros-classes">
                        <div class="text-center py-3">
                            <i class="bi bi-hourglass-split"></i>
                            Carregando classes...
                        </div>
                    </div>
                </div>
                
                <!-- Filtro por Taxa de Acerto -->
                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-graph-up text-primary"></i>
                        <strong>Taxa de Acerto:</strong>
                        </label>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="taxa-minima" class="form-label">Mínima (%)</label>
                            <input type="number" class="form-control" id="taxa-minima" min="0" max="100" placeholder="0">
                        </div>
                        <div class="col-md-6">
                            <label for="taxa-maxima" class="form-label">Máxima (%)</label>
                            <input type="number" class="form-control" id="taxa-maxima" min="0" max="100" placeholder="100">
                        </div>
                    </div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limparFiltroTaxa()">
                            <i class="bi bi-arrow-clockwise"></i>
                            Limpar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="limparFiltros()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Limpar Filtros
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="aplicarFiltro()">
                    <i class="bi bi-funnel"></i>
                    Aplicar Filtro
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Configuração de Colunas -->
<div class="modal fade" id="modalConfigColunas" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-gear text-warning"></i>
                    Configurar Colunas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Selecione quais colunas deseja exibir na tabela de intimações:</p>
                
                <div class="row">
                    <div class="col-md-6">
                    <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="col-checkbox" checked>
                            <label class="form-check-label" for="col-checkbox">
                                Card da Intimação
                        </label>
                    </div>
                    <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="col-defensor" checked>
                            <label class="form-check-label" for="col-defensor">
                                Defensor
                        </label>
                    </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="col-classe" checked>
                            <label class="form-check-label" for="col-classe">
                                Classe
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="col-classificacao" checked>
                            <label class="form-check-label" for="col-classificacao">
                                Classificação Manual
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="col-informacoes" checked>
                            <label class="form-check-label" for="col-informacoes">
                                Informações Adicionais
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="col-taxa" checked>
                            <label class="form-check-label" for="col-taxa">
                                Taxa de Acerto
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="col-data" checked>
                            <label class="form-check-label" for="col-data">
                                Data de Criação
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="col-acoes" checked>
                            <label class="form-check-label" for="col-acoes">
                                Ações
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="resetarColunasIntimacoes()">
                    <i class="bi bi-arrow-clockwise"></i>
                    Resetar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="aplicarConfigColunasIntimacoes()">
                    <i class="bi bi-check"></i>
                    Aplicar
                </button>
            </div>
        </div>
    </div>
</div>

{% include 'partials/modais_prompt_resposta.html' %}

<!-- Modal para mostrar Prompt Selecionado -->
<div class="modal fade" id="modalPrompt" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-code-square text-primary"></i>
                    Prompt Selecionado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="modal-prompt-content" class="bg-light p-3 rounded" style="max-height: 500px; overflow-y: auto; white-space: pre-wrap;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-outline-primary" onclick="copiarPromptModal()">
                    <i class="bi bi-clipboard"></i>
                    Copiar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Contexto da Intimação -->
<div class="modal fade" id="modalContextoIntimacao" tabindex="-1">
    <div class="modal-dialog modal-xl" style="max-width: 90vw; width: 90vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-file-text text-primary"></i>
                    Contexto da Intimação
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">Contexto:</label>
                    <div class="border rounded p-3 bg-light" style="max-height: 65vh; overflow-y: auto;">
                        <div id="modal-contexto-content" class="markdown-content"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-outline-primary" onclick="copiarContexto()">
                    <i class="bi bi-clipboard"></i>
                    Copiar Contexto
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<!-- Overlay de Loading -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="loading-spinner">
            <div class="ai-brain">
                <div class="brain-pulse"></div>
                <div class="brain-pulse"></div>
                <div class="brain-pulse"></div>
            </div>
        </div>
        <div class="loading-text">
            <h4 class="text-white mb-3" id="loading-title">🤖 IA Analisando...</h4>
            <p class="text-white-50 mb-0" id="loading-description">Processando intimações com inteligência artificial</p>
            
            <!-- Progress Bar -->
            <div class="progress mt-3" style="width: 300px; background: rgba(255,255,255,0.2);">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%; background: #28a745;" 
                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    0%
                </div>
            </div>
            
            <!-- Progress Details -->
            <div class="mt-3">
                <small class="text-white-50" id="progress-details">Iniciando...</small>
            </div>
            
            <!-- Cancel Button -->
            <div class="mt-4">
                <button id="cancel-analysis-btn" class="btn btn-outline-light btn-sm" onclick="cancelarAnalise()">
                    <i class="bi bi-x-circle"></i> Cancelar Análise
                </button>
            </div>
            
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>
</div>
<style>
    .text-truncate-custom {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.1);
    }
    
    .intimacao-checkbox:checked + td {
        background-color: rgba(40, 167, 69, 0.1);
    }

    /* Estilos para a tabela de cards compactos */
    .intimacoes-cards-table {
        border-collapse: separate;
        border-spacing: 0;
    }

    .intimacoes-cards-table th {
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        padding: 12px 8px;
        background: #f8f9fa;
    }

    .intimacoes-cards-table td {
        padding: 8px;
        vertical-align: top;
        border-bottom: 1px solid #dee2e6;
    }

    /* Forçar largura da primeira coluna */
    .intimacoes-cards-table th:first-child,
    .intimacoes-cards-table td:first-child {
        width: 20px !important;
        min-width: 20px !important;
        max-width: 20px !important;
        padding: 4px 2px !important;
        text-align: center !important;
        overflow: hidden !important;
    }

    /* Forçar largura da tabela */
    .intimacoes-cards-table {
        width: 100% !important;
    }

    /* Ajustar largura das outras colunas */
    .intimacoes-cards-table th:nth-child(2),
    .intimacoes-cards-table td:nth-child(2) {
        width: 35% !important;
    }

    .intimacoes-cards-table th:nth-child(3),
    .intimacoes-cards-table td:nth-child(3) {
        width: 15% !important;
    }

    .intimacoes-cards-table th:nth-child(4),
    .intimacoes-cards-table td:nth-child(4) {
        width: 20% !important;
    }

    .intimacoes-cards-table th:nth-child(5),
    .intimacoes-cards-table td:nth-child(5) {
        width: 12% !important;
    }

    .intimacoes-cards-table th:nth-child(6),
    .intimacoes-cards-table td:nth-child(6) {
        width: 10% !important;
    }

    .intimacoes-cards-table th:nth-child(7),
    .intimacoes-cards-table td:nth-child(7) {
        width: 8% !important;
    }

    .intimacao-row:hover {
        background-color: #f8f9fa;
    }

    /* Células da tabela */
    .classificacao-cell {
        text-align: center;
    }

    .info-cell {
        max-width: 200px;
    }

    .info-adicional-text {
        font-size: 12px;
        line-height: 1.3;
        color: #495057;
        cursor: help;
    }

    .data-cell {
        text-align: center;
    }

    .acoes-cell {
        text-align: center;
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: 99999;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(10px);
        opacity: 1;
        visibility: visible;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .loading-overlay.hidden {
        opacity: 0;
        visibility: hidden;
    }

    .loading-content {
        text-align: center;
        color: white;
    }

    .loading-spinner {
        margin-bottom: 2rem;
    }

    /* Estilos para cartões de estatísticas clicáveis */
    .stat-card {
        position: relative;
        padding: 15px;
        border-radius: 8px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-color: rgba(0, 123, 255, 0.3);
    }

    .stat-card:active {
        transform: translateY(0);
    }

    .stat-hover-effect {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        border-radius: 8px;
    }

    .stat-card:hover .stat-hover-effect {
        opacity: 1;
    }



    /* Estilos para linhas filtradas */
    .resultado-row.filtrado {
        display: none;
    }

    .resultado-row.visivel {
        display: table-row;
    }

    /* Estilos para o contador no cabeçalho */
    #contador-resultados-header {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        transition: all 0.3s ease;
    }

    #contador-resultados-header:hover {
        transform: scale(1.05);
    }

    #contador-texto-header {
        font-weight: 500;
    }

    /* Estilos para conteúdo Markdown */
    .markdown-content {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
        color: #333;
    }

    .markdown-content h1 {
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 8px;
        margin-top: 24px;
        margin-bottom: 16px;
        font-size: 1.8em;
        font-weight: 600;
    }

    .markdown-content h2 {
        color: #34495e;
        border-bottom: 1px solid #bdc3c7;
        padding-bottom: 6px;
        margin-top: 20px;
        margin-bottom: 12px;
        font-size: 1.5em;
        font-weight: 600;
    }

    .markdown-content h3 {
        color: #2c3e50;
        margin-top: 16px;
        margin-bottom: 8px;
        font-size: 1.3em;
        font-weight: 600;
    }

    .markdown-content h4 {
        color: #34495e;
        margin-top: 12px;
        margin-bottom: 6px;
        font-size: 1.1em;
        font-weight: 600;
    }

    .markdown-content strong {
        color: #2c3e50;
        font-weight: 600;
    }

    .markdown-content em {
        color: #7f8c8d;
        font-style: italic;
    }

    .markdown-content p {
        margin-bottom: 12px;
    }

    .markdown-content ul, .markdown-content ol {
        margin-bottom: 12px;
        padding-left: 24px;
    }

    .markdown-content li {
        margin-bottom: 4px;
    }

    .markdown-content blockquote {
        border-left: 4px solid #3498db;
        padding-left: 16px;
        margin: 16px 0;
        color: #7f8c8d;
        font-style: italic;
    }

    .markdown-content code {
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        color: #e74c3c;
    }

    .markdown-content pre {
        background-color: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        border: 1px solid #e9ecef;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-width: 100%;
    }

    .markdown-content pre code {
        background-color: transparent;
        padding: 0;
        color: #333;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    /* Estilos específicos para texto de documentos */
    .markdown-content p {
        margin-bottom: 8px;
        line-height: 1.4;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    /* Reduzir espaçamento entre parágrafos */
    .markdown-content p + p {
        margin-top: 4px;
    }

    /* Melhorar quebra de palavras longas */
    .markdown-content {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
    }

    /* Ajustar largura máxima para evitar rolagem horizontal */
    .markdown-content * {
        max-width: 100%;
        box-sizing: border-box;
    }

    /* Estilos específicos para documentos jurídicos */
    .markdown-content h3 {
        margin-top: 12px;
        margin-bottom: 6px;
        font-size: 1.2em;
        font-weight: 600;
        color: #2c3e50;
        border-bottom: 1px solid #ecf0f1;
        padding-bottom: 4px;
    }

    /* Reduzir espaçamento em seções de documento */
    .markdown-content h3 + p {
        margin-top: 2px;
        margin-bottom: 4px;
    }

    /* Reduzir espaçamento entre parágrafos em seções de documento */
    .markdown-content h3 ~ p {
        margin-bottom: 4px;
        line-height: 1.3;
    }

    /* Estilo especial para seções de documento */
    .markdown-content h3:contains("Documento") + *,
    .markdown-content h3:contains("Documento") ~ * {
        margin-bottom: 3px;
    }

    /* Fonte maior para textos de documentos */
    .markdown-content h3:contains("Documento") ~ p {
        font-size: 1.05rem !important;
        line-height: 1.4 !important;
    }

    /* Melhorar espaçamento para listas */
    .markdown-content ul, .markdown-content ol {
        margin-bottom: 8px;
        padding-left: 20px;
    }

    .markdown-content li {
        margin-bottom: 2px;
        line-height: 1.4;
    }

    /* Ajustar espaçamento para títulos */
    .markdown-content h1 {
        margin-top: 16px;
        margin-bottom: 12px;
    }

    .markdown-content h2 {
        margin-top: 14px;
        margin-bottom: 8px;
    }

    /* Melhorar legibilidade de textos longos */
    .markdown-content {
        font-size: 0.95rem;
        line-height: 1.5;
    }

    /* Aumentar fonte para seções de documento */
    .markdown-content h3 + p,
    .markdown-content h3 ~ p {
        font-size: 1.05rem;
        line-height: 1.4;
    }

    /* Ajustar padding da modal para melhor aproveitamento do espaço */
    .modal-body {
        padding: 1rem;
    }

    .modal-body .border {
        padding: 0.75rem !important;
    }

    /* Modal responsiva e proporcional */
    @media (max-width: 768px) {
        #modalContextoIntimacao .modal-dialog {
            max-width: 95vw !important;
            width: 95vw !important;
            margin: 1vh auto;
        }
        
        #modalContextoIntimacao .modal-body .border {
            max-height: 55vh !important;
        }
    }

    @media (min-width: 769px) and (max-width: 1200px) {
        #modalContextoIntimacao .modal-dialog {
            max-width: 85vw !important;
            width: 85vw !important;
        }
        
        #modalContextoIntimacao .modal-body .border {
            max-height: 60vh !important;
        }
    }

    @media (min-width: 1201px) {
        #modalContextoIntimacao .modal-dialog {
            max-width: 80vw !important;
            width: 80vw !important;
        }
        
        #modalContextoIntimacao .modal-body .border {
            max-height: 65vh !important;
        }
    }

    /* Estilo específico para texto de documento */
    .documento-texto {
        font-size: 1.15rem !important;
        line-height: 1.4 !important;
        font-weight: 500 !important;
        color: #2c3e50 !important;
        display: block;
        margin-bottom: 2px;
    }

    /* Estilo para parágrafos de documento */
    .documento-paragrafo {
        font-size: 0.95rem !important;
        font-weight: 400 !important;
        color: #333 !important;
        background-color: transparent !important;
        padding: 0 !important;
        margin-bottom: 3px !important;
        line-height: 1.4 !important;
    }



    .markdown-content table {
        border-collapse: collapse;
        width: 100%;
        margin: 16px 0;
    }

    .markdown-content th, .markdown-content td {
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        text-align: left;
    }

    .markdown-content th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }

    .markdown-content tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    /* AI Brain Animation */
    .ai-brain {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .brain-pulse {
        position: absolute;
        width: 20px;
        height: 20px;
        background: #fff;
        border-radius: 50%;
        animation: brainPulse 2s infinite;
    }

    .brain-pulse:nth-child(1) {
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        animation-delay: 0s;
    }

    .brain-pulse:nth-child(2) {
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        animation-delay: 0.6s;
    }

    .brain-pulse:nth-child(3) {
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        animation-delay: 1.2s;
    }

    @keyframes brainPulse {
        0%, 100% {
            opacity: 0.3;
            transform: scale(0.8);
        }
        50% {
            opacity: 1;
            transform: scale(1.2);
        }
    }

    /* Loading Dots */
    .loading-dots {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 1rem;
    }

    .loading-dots span {
        width: 8px;
        height: 8px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 50%;
        animation: loadingDots 1.4s infinite ease-in-out;
    }

    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    .loading-dots span:nth-child(3) { animation-delay: 0s; }

    @keyframes loadingDots {
        0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Smooth Scroll */
    html {
        scroll-behavior: smooth;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Script oculto com dados dos prompts -->
<script type="application/json" id="prompts-data">
{{ prompts|tojson }}
</script>

<script>
console.log('=== DEBUG: Script de análise carregado ===');

// Dados dos prompts passados do backend via JSON
let prompts = [];
try {
    const promptsDataElement = document.getElementById('prompts-data');
    if (promptsDataElement) {
        prompts = JSON.parse(promptsDataElement.textContent);
        console.log('=== DEBUG: Prompts carregados via JSON ===', prompts.length);
    } else {
        console.error('=== ERRO: Elemento prompts-data não encontrado ===');
    }
} catch (error) {
        console.error('=== ERRO ao parsear prompts ===', error);
        prompts = [];
}

// Variáveis globais
let analiseAtual = null;
let resultadosAnalise = [];
let dadosCompletos = {}; // Objeto para armazenar prompt e resposta completos

// Configuração de colunas
let configuracaoColunas = {
    intimacao: true,
    classificacao_manual: true,
    informacao_adicional: true,
    resultado_ia: true,
    status: true,
    configuracoes: true,
    tempo: true,
    custo: true,
    tokens_input: true,
    tokens_output: true,
    prompt: true,
    resposta: true
};

// Variáveis para controle de progresso
let analiseEmAndamento = false;
let totalIntimacoes = 0;
let intimacoesProcessadas = 0;
let eventoSource = null;
let sessionId = null;  // ID da sessão para cancelamento

// Função para alternar configurações da OpenAI
function toggleOpenAIConfig() {
    const content = document.getElementById('openai-config-content');
    const icon = document.getElementById('openai-toggle-icon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'bi bi-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
    }
}

// Função para atualizar resumo das configurações
function atualizarConfigSummary() {
    const modelo = document.getElementById('modelo').value;
    const temperatura = document.getElementById('temperatura').value;
    const summary = document.getElementById('config-summary');
    
    summary.textContent = `${modelo}, Temp: ${temperatura}`;
}

// Função para mostrar preview do prompt
function mostrarPreviewPrompt(promptId) {
    const prompt = prompts.find(p => p.id === promptId);
    
    if (prompt) {
        document.getElementById('prompt-content').textContent = prompt.conteudo;
        document.getElementById('prompt-preview').style.display = 'block';
        // Por padrão, mostrar colapsado
        colapsarPromptPreview();
    }
}

// Função para alternar preview do prompt (expandir/colapsar)
function togglePromptPreview() {
    const content = document.getElementById('prompt-preview-content');
    const icon = document.getElementById('toggle-icon');
    const text = document.getElementById('toggle-text');
    
    if (content.style.display === 'none') {
        expandirPromptPreview();
    } else {
        colapsarPromptPreview();
    }
}

// Função para expandir preview do prompt
function expandirPromptPreview() {
    const content = document.getElementById('prompt-preview-content');
    const icon = document.getElementById('toggle-icon');
    const text = document.getElementById('toggle-text');
    
    content.style.display = 'block';
    icon.className = 'bi bi-chevron-up';
    text.textContent = 'Colapsar';
}

// Função para colapsar preview do prompt
function colapsarPromptPreview() {
    const content = document.getElementById('prompt-preview-content');
    const icon = document.getElementById('toggle-icon');
    const text = document.getElementById('toggle-text');
    
    content.style.display = 'none';
    icon.className = 'bi bi-chevron-down';
    text.textContent = 'Expandir';
}

// Função para mostrar prompt em modal
function mostrarPromptModal() {
    const promptSelecionado = document.getElementById('prompt-selecionado');
    if (promptSelecionado.value) {
        const prompt = prompts.find(p => p.id === promptSelecionado.value);
        if (prompt) {
            document.getElementById('modal-prompt-content').textContent = prompt.conteudo;
            const modal = new bootstrap.Modal(document.getElementById('modalPrompt'));
            modal.show();
        }
    }
}

// Função para atualizar contador de seleção
function updateIntimacoesSelection() {
    const checkboxes = document.querySelectorAll('.intimacao-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('intimacoes-count').textContent = count + ' selecionada(s)';
    
    // Atualizar checkbox "selecionar todas" considerando apenas intimações visíveis
    const selectAll = document.getElementById('select-all-intimacoes');
    const allCheckboxes = document.querySelectorAll('.intimacao-checkbox');
    const visibleCheckboxes = Array.from(allCheckboxes).filter(checkbox => {
        const row = checkbox.closest('tr');
        return row.style.display !== 'none';
    });
    const visibleChecked = Array.from(allCheckboxes).filter(checkbox => {
        const row = checkbox.closest('tr');
        return row.style.display !== 'none' && checkbox.checked;
    });
    
    selectAll.checked = visibleChecked.length === visibleCheckboxes.length && visibleCheckboxes.length > 0;
    selectAll.indeterminate = visibleChecked.length > 0 && visibleChecked.length < visibleCheckboxes.length;
    
    atualizarResumo();
}

// Função para alternar seleção de todas as intimações
function toggleSelectAllIntimacoes() {
    const selectAll = document.getElementById('select-all-intimacoes');
    const checkboxes = document.querySelectorAll('.intimacao-checkbox');
    
    // Selecionar apenas as intimações visíveis (não filtradas)
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        if (row.style.display !== 'none') {
            checkbox.checked = selectAll.checked;
        }
    });
    
    updateIntimacoesSelection();
}

// Função para selecionar todas as intimações
function selecionarTodasIntimacoes() {
    const checkboxes = document.querySelectorAll('.intimacao-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = true);
    updateIntimacoesSelection();
}

// Função para limpar seleção de intimações
function limparSelecaoIntimacoes() {
    const checkboxes = document.querySelectorAll('.intimacao-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    updateIntimacoesSelection();
}

// Função para mostrar loading
function mostrarLoading() {
    console.log('=== DEBUG: Mostrando loading ===');
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'flex';
        overlay.style.opacity = '1';
        overlay.style.visibility = 'visible';
        overlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Bloquear scroll
        console.log('=== DEBUG: Loading overlay ativado ===');
    } else {
        console.error('=== ERRO: Loading overlay não encontrado ===');
    }
}

// Função para atualizar progresso
function atualizarProgresso(atual, total, descricao = '') {
    const progressBar = document.getElementById('progress-bar');
    const progressDetails = document.getElementById('progress-details');
    const loadingTitle = document.getElementById('loading-title');
    
    if (progressBar && progressDetails) {
        const percentual = total > 0 ? Math.round((atual / total) * 100) : 0;
        
        progressBar.style.width = percentual + '%';
        progressBar.setAttribute('aria-valuenow', percentual);
        progressBar.textContent = percentual + '%';
        
        progressDetails.textContent = descricao || `Analisando ${atual} de ${total} intimações...`;
        
        if (loadingTitle) {
            loadingTitle.textContent = `🤖 IA Analisando... (${atual}/${total})`;
        }
    }
}

// Função para cancelar análise
async function cancelarAnalise() {
    if (analiseEmAndamento && sessionId) {
        if (confirm('Tem certeza que deseja cancelar a análise em andamento?')) {
            console.log('=== DEBUG: Cancelando análise ===');
            
            try {
                // Enviar requisição para cancelar no backend
                const response = await fetch('/api/cancelar-analise', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('=== DEBUG: Análise cancelada no backend ===');
                } else {
                    console.warn('=== DEBUG: Erro ao cancelar no backend:', data.message);
                }
            } catch (error) {
                console.error('=== ERRO ao cancelar análise:', error);
            }
            
            // Fechar conexão SSE
            if (eventoSource) {
                eventoSource.close();
                eventoSource = null;
            }
            
            // Resetar variáveis
            analiseEmAndamento = false;
            totalIntimacoes = 0;
            intimacoesProcessadas = 0;
            sessionId = null;
            
            // Esconder loading
            esconderLoading();
            
            // Reabilitar botão
            const btnExecutar = document.getElementById('btn-executar');
            if (btnExecutar) {
                btnExecutar.disabled = false;
                btnExecutar.innerHTML = '<i class="bi bi-play-circle"></i> Executar Análise';
            }
            
            showToast('Análise cancelada pelo usuário', 'warning');
        }
    }
}

// Função para esconder loading
function esconderLoading() {
    console.log('=== DEBUG: Escondendo loading ===');
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
        overlay.style.display = 'none';
        overlay.style.opacity = '0';
        overlay.style.visibility = 'hidden';
        overlay.classList.add('hidden');
        document.body.style.overflow = 'auto'; // Restaurar scroll
        console.log('=== DEBUG: Loading overlay desativado ===');
    } else {
        console.error('=== ERRO: Loading overlay não encontrado ===');
    }
}



// Função para scroll suave para resultados
function scrollParaResultados() {
    const resultadosContainer = document.getElementById('resultados-container');
    if (resultadosContainer) {
        resultadosContainer.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }
}

// Função para executar análise
function executarAnalise() {
    console.log('=== DEBUG: executarAnalise chamada ===');
    const promptSelecionado = document.getElementById('prompt-selecionado').value;
    const intimacoesSelecionadas = Array.from(document.querySelectorAll('.intimacao-checkbox:checked')).map(cb => cb.value);
    
    if (!promptSelecionado) {
        showToast('Selecione um prompt!', 'error');
        return;
    }
    
    if (intimacoesSelecionadas.length === 0) {
        showToast('Selecione pelo menos uma intimação!', 'error');
        return;
    }
    
    const dados = {
        prompt_id: promptSelecionado,
        intimacao_ids: intimacoesSelecionadas,
        configuracoes: {
            modelo: document.getElementById('modelo').value,
            temperatura: parseFloat(document.getElementById('temperatura').value),
            max_tokens: parseInt(document.getElementById('max-tokens').value),
            timeout: parseInt(document.getElementById('timeout').value),
            salvar_resultados: document.getElementById('salvar-resultados').checked,
            calcular_acuracia: document.getElementById('calcular-acuracia').checked,
            modo_paralelo: document.getElementById('modo-paralelo').checked
        }
    };
    
    // Mostrar loading antes de iniciar
    mostrarLoading();
    iniciarAnalise(dados);
}

// Atualizar contadores quando seleções mudarem
const promptSelecionado = document.getElementById('prompt-selecionado');
const intimacoesSelecionadas = document.getElementById('intimacoes-selecionadas');
const modelo = document.getElementById('modelo');
const temperatura = document.getElementById('temperatura');
const maxTokens = document.getElementById('max-tokens');

if (promptSelecionado) promptSelecionado.addEventListener('change', atualizarResumo);
if (intimacoesSelecionadas) intimacoesSelecionadas.addEventListener('change', atualizarResumo);
if (modelo) modelo.addEventListener('change', atualizarResumo);
if (temperatura) temperatura.addEventListener('change', atualizarResumo);
if (maxTokens) maxTokens.addEventListener('change', atualizarResumo);

// Função para atualizar resumo da configuração
function atualizarResumo() {
    const promptSelecionado = document.getElementById('prompt-selecionado');
    const intimacoesSelecionadas = document.querySelectorAll('.intimacao-checkbox:checked').length;
    const totalAnalises = intimacoesSelecionadas;
    
    // Atualizar contadores (se existirem)
    const intimacoesCount = document.getElementById('intimacoes-count');
    if (intimacoesCount) {
        intimacoesCount.textContent = intimacoesSelecionadas + ' selecionada(s)';
    }
    
    // Atualizar nome do prompt
    if (promptSelecionado.value) {
        // Mostrar preview do prompt
        mostrarPreviewPrompt(promptSelecionado.value);
    } else {
        const promptPreview = document.getElementById('prompt-preview');
        if (promptPreview) {
            promptPreview.style.display = 'none';
        }
    }
}

// Função para mostrar preview do prompt
function mostrarPreviewPrompt(promptId) {
    const prompt = prompts.find(p => p.id === promptId);
    
    if (prompt) {
        document.getElementById('prompt-content').textContent = prompt.conteudo;
        document.getElementById('prompt-preview').style.display = 'block';
        // Por padrão, mostrar colapsado
        colapsarPromptPreview();
    }
}

// Função para alternar preview do prompt (expandir/colapsar)
function togglePromptPreview() {
    const content = document.getElementById('prompt-preview-content');
    const icon = document.getElementById('toggle-icon');
    const text = document.getElementById('toggle-text');
    
    if (content.style.display === 'none') {
        expandirPromptPreview();
    } else {
        colapsarPromptPreview();
    }
}

// Função para expandir preview do prompt
function expandirPromptPreview() {
    const content = document.getElementById('prompt-preview-content');
    const icon = document.getElementById('toggle-icon');
    const text = document.getElementById('toggle-text');
    
    content.style.display = 'block';
    icon.className = 'bi bi-chevron-up';
    text.textContent = 'Colapsar';
}

// Função para colapsar preview do prompt
function colapsarPromptPreview() {
    const content = document.getElementById('prompt-preview-content');
    const icon = document.getElementById('toggle-icon');
    const text = document.getElementById('toggle-text');
    
    content.style.display = 'none';
    icon.className = 'bi bi-chevron-down';
    text.textContent = 'Expandir';
}

// Função para mostrar prompt em modal
function mostrarPromptModal() {
    const promptSelecionado = document.getElementById('prompt-selecionado');
    if (promptSelecionado.value) {
        const prompt = prompts.find(p => p.id === promptSelecionado.value);
        if (prompt) {
            document.getElementById('modal-prompt-content').textContent = prompt.conteudo;
            const modal = new bootstrap.Modal(document.getElementById('modalPrompt'));
            modal.show();
        }
    }
}

// Função para alternar configurações da OpenAI
function toggleOpenAIConfig() {
    const content = document.getElementById('openai-config-content');
    const icon = document.getElementById('openai-toggle-icon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.className = 'bi bi-chevron-up';
    } else {
        content.style.display = 'none';
        icon.className = 'bi bi-chevron-down';
    }
}

// Função para alternar configurações de colunas
function toggleConfiguracoesColunas() {
    const configDiv = document.getElementById('config-colunas');
    if (configDiv.style.display === 'none') {
        configDiv.style.display = 'block';
        carregarConfiguracaoColunas();
    } else {
        configDiv.style.display = 'none';
    }
}

// Função para carregar configuração de colunas
function carregarConfiguracaoColunas() {
    const configSalva = localStorage.getItem('configuracaoColunas');
    if (configSalva) {
        configuracaoColunas = JSON.parse(configSalva);
        console.log('=== DEBUG: Configuração carregada:', configuracaoColunas);
    } else {
        console.log('=== DEBUG: Nenhuma configuração salva encontrada, usando padrão');
    }
    
    // Aplicar configuração aos checkboxes
    const elementos = {
        'col-intimacao': 'intimacao',
        'col-classificacao-manual': 'classificacao_manual',
        'col-informacao-adicional': 'informacao_adicional',
        'col-resultado-ia': 'resultado_ia',
        'col-status': 'status',
        'col-configuracoes': 'configuracoes',
        'col-tempo': 'tempo',
        'col-custo': 'custo',
        'col-tokens-input': 'tokens_input',
        'col-tokens-output': 'tokens_output',
        'col-prompt': 'prompt',
        'col-resposta': 'resposta'
    };
    
    Object.entries(elementos).forEach(([elementId, configKey]) => {
        const elemento = document.getElementById(elementId);
        if (elemento) {
            elemento.checked = configuracaoColunas[configKey];
            console.log(`=== DEBUG: ${elementId} = ${configuracaoColunas[configKey]}`);
        } else {
            console.warn(`=== DEBUG: Elemento ${elementId} não encontrado`);
        }
    });
}

// Função para selecionar todas as colunas
function selecionarTodasColunas() {
    const checkboxes = document.querySelectorAll('#config-colunas input[type="checkbox"]');
    checkboxes.forEach(checkbox => checkbox.checked = true);
}

// Função para limpar seleção de colunas
function limparSelecaoColunas() {
    const checkboxes = document.querySelectorAll('#config-colunas input[type="checkbox"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);
}

// Função para salvar configuração de colunas
function salvarConfiguracaoColunas() {
    configuracaoColunas = {
        intimacao: document.getElementById('col-intimacao').checked,
        classificacao_manual: document.getElementById('col-classificacao-manual').checked,
        informacao_adicional: document.getElementById('col-informacao-adicional').checked,
        resultado_ia: document.getElementById('col-resultado-ia').checked,
        status: document.getElementById('col-status').checked,
        configuracoes: document.getElementById('col-configuracoes').checked,
        tempo: document.getElementById('col-tempo').checked,
        custo: document.getElementById('col-custo').checked,
        tokens_input: document.getElementById('col-tokens-input').checked,
        tokens_output: document.getElementById('col-tokens-output').checked,
        prompt: document.getElementById('col-prompt').checked,
        resposta: document.getElementById('col-resposta').checked
    };
    
    localStorage.setItem('configuracaoColunas', JSON.stringify(configuracaoColunas));
    
    // Reaplicar configuração se há resultados
    if (resultadosAnalise.length > 0) {
        exibirResultados();
    }
    
    // Fechar configuração
    document.getElementById('config-colunas').style.display = 'none';
    
    showToast('Configuração de colunas salva!', 'success');
}

// Função para atualizar resumo das configurações
function atualizarConfigSummary() {
    const modelo = document.getElementById('modelo').value;
    const temperatura = document.getElementById('temperatura').value;
    const summary = document.getElementById('config-summary');
    
    summary.textContent = `${modelo}, Temp: ${temperatura}`;
}



// Função para selecionar todas as intimações
function selecionarTodasIntimacoes() {
    const checkboxes = document.querySelectorAll('.intimacao-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = true);
    updateIntimacoesSelection();
}

// Função para limpar seleção de intimações
function limparSelecaoIntimacoes() {
    const checkboxes = document.querySelectorAll('.intimacao-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    updateIntimacoesSelection();
}



// Função para filtrar por classificação
function filtrarPorClassificacao() {
    carregarFiltros();
    const modal = new bootstrap.Modal(document.getElementById('modalFiltro'));
    modal.show();
}

// Função para configurar colunas
function configurarColunasIntimacoes() {
    const modal = new bootstrap.Modal(document.getElementById('modalConfigColunas'));
    modal.show();
}

// Função para aplicar configuração de colunas
function aplicarConfigColunasIntimacoes() {
    const colunas = [
        'col-checkbox', 'col-defensor', 'col-classe', 'col-classificacao',
        'col-informacoes', 'col-taxa', 'col-data', 'col-acoes'
    ];
    
    colunas.forEach(coluna => {
        const checkbox = document.getElementById(coluna);
        const elementos = document.querySelectorAll(`.${coluna}`);
        
        if (checkbox.checked) {
            elementos.forEach(el => el.style.display = '');
        } else {
            elementos.forEach(el => el.style.display = 'none');
        }
    });
    
    // Salvar configuração no localStorage
    const config = {};
    colunas.forEach(coluna => {
        config[coluna] = document.getElementById(coluna).checked;
    });
    localStorage.setItem('configColunasIntimacoes', JSON.stringify(config));
    
    // Fechar modal se estiver aberto
    const modalElement = document.getElementById('modalConfigColunas');
    if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
    }
    
    showToast('Configuração de colunas aplicada!', 'success');
}

// Função para resetar colunas
function resetarColunasIntimacoes() {
    const colunas = [
        'col-checkbox', 'col-defensor', 'col-classe', 'col-classificacao',
        'col-informacoes', 'col-taxa', 'col-data', 'col-acoes'
    ];
    
    colunas.forEach(coluna => {
        const checkbox = document.getElementById(coluna);
        checkbox.checked = true;
    });
}

// Função para carregar configuração de colunas
function carregarConfigColunasIntimacoes() {
    const config = localStorage.getItem('configColunasIntimacoes');
    if (config) {
        const configObj = JSON.parse(config);
        Object.keys(configObj).forEach(coluna => {
            const checkbox = document.getElementById(coluna);
            if (checkbox) {
                checkbox.checked = configObj[coluna];
            }
        });
        // Aplicar configuração sem fechar modal (já que não há modal aberto)
        aplicarConfigColunasIntimacoesSemFecharModal();
    }
}

// Função para aplicar configuração sem fechar modal
function aplicarConfigColunasIntimacoesSemFecharModal() {
    const colunas = [
        'col-checkbox', 'col-defensor', 'col-classe', 'col-classificacao',
        'col-informacoes', 'col-taxa', 'col-data', 'col-acoes'
    ];
    
    colunas.forEach(coluna => {
        const checkbox = document.getElementById(coluna);
        const elementos = document.querySelectorAll(`.${coluna}`);
        
        if (checkbox && elementos.length > 0) {
            if (checkbox.checked) {
                elementos.forEach(el => el.style.display = '');
            } else {
                elementos.forEach(el => el.style.display = 'none');
            }
        }
    });
}

// Carregar filtros dinamicamente do banco
function carregarFiltros() {
    fetch('/api/filtros/analise')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                carregarDefensores(data.defensores);
                carregarClassificacoes(data.classificacoes);
                carregarClasses(data.classes);
            } else {
                console.error('Erro ao carregar filtros:', data.message);
                showToast('Erro ao carregar filtros', 'error');
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
            showToast('Erro ao carregar filtros', 'error');
        });
}

// Carregar defensores na modal
function carregarDefensores(defensores) {
    const container = document.getElementById('filtros-defensores');
    
    if (defensores.length === 0) {
        container.innerHTML = '<div class="text-muted"><em>Nenhum defensor encontrado</em></div>';
        return;
    }
    
    container.innerHTML = defensores.map((defensor, index) => `
        <div class="form-check">
            <input class="form-check-input filtro-defensor" type="checkbox" id="filtro-defensor-${index}" value="${defensor}" checked>
            <label class="form-check-label" for="filtro-defensor-${index}">
                ${defensor}
            </label>
        </div>
    `).join('');
    
    // Adicionar event listener para o check "Todos os defensores"
    const checkTodosDefensores = document.getElementById('filtro-todos-defensores');
    checkTodosDefensores.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.filtro-defensor');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });
    
    // Adicionar event listeners para os checkboxes individuais de defensores
    const checkboxesDefensores = document.querySelectorAll('.filtro-defensor');
    checkboxesDefensores.forEach(cb => {
        cb.addEventListener('change', function() {
            const todosMarcados = document.querySelectorAll('.filtro-defensor:checked').length === checkboxesDefensores.length;
            const nenhumMarcado = document.querySelectorAll('.filtro-defensor:checked').length === 0;
            
            if (todosMarcados) {
                checkTodosDefensores.checked = true;
                checkTodosDefensores.indeterminate = false;
            } else if (nenhumMarcado) {
                checkTodosDefensores.checked = false;
                checkTodosDefensores.indeterminate = false;
            } else {
                checkTodosDefensores.checked = false;
                checkTodosDefensores.indeterminate = true;
            }
        });
    });
}

// Carregar classificações na modal
function carregarClassificacoes(classificacoes) {
    const container = document.getElementById('filtros-classificacoes');
    
    if (classificacoes.length === 0) {
        container.innerHTML = '<div class="text-muted"><em>Nenhuma classificação encontrada</em></div>';
        return;
    }
    
    container.innerHTML = classificacoes.map((classificacao, index) => `
        <div class="form-check">
            <input class="form-check-input filtro-classificacao" type="checkbox" id="filtro-classificacao-${index}" value="${classificacao}" checked>
            <label class="form-check-label" for="filtro-classificacao-${index}">
                ${classificacao}
            </label>
        </div>
    `).join('');
    
    // Adicionar event listener para o check "Todas as classificações"
    const checkTodasClassificacoes = document.getElementById('filtro-todas-classificacoes');
    checkTodasClassificacoes.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.filtro-classificacao');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });
    
    // Adicionar event listeners para os checkboxes individuais de classificações
    const checkboxesClassificacoes = document.querySelectorAll('.filtro-classificacao');
    checkboxesClassificacoes.forEach(cb => {
        cb.addEventListener('change', function() {
            const todosMarcados = document.querySelectorAll('.filtro-classificacao:checked').length === checkboxesClassificacoes.length;
            const nenhumMarcado = document.querySelectorAll('.filtro-classificacao:checked').length === 0;
            
            if (todosMarcados) {
                checkTodasClassificacoes.checked = true;
                checkTodasClassificacoes.indeterminate = false;
            } else if (nenhumMarcado) {
                checkTodasClassificacoes.checked = false;
                checkTodasClassificacoes.indeterminate = false;
            } else {
                checkTodasClassificacoes.checked = false;
                checkTodasClassificacoes.indeterminate = true;
            }
        });
    });
}

// Carregar classes na modal
function carregarClasses(classes) {
    const container = document.getElementById('filtros-classes');
    
    if (classes.length === 0) {
        container.innerHTML = '<div class="text-muted"><em>Nenhuma classe encontrada</em></div>';
        return;
    }
    
    container.innerHTML = classes.map((classe, index) => `
        <div class="form-check">
            <input class="form-check-input filtro-classe" type="checkbox" id="filtro-classe-${index}" value="${classe}" checked>
            <label class="form-check-label" for="filtro-classe-${index}">
                ${classe}
            </label>
        </div>
    `).join('');
    
    // Adicionar event listener para o check "Todas as classes"
    const checkTodasClasses = document.getElementById('filtro-todas-classes');
    checkTodasClasses.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.filtro-classe');
        checkboxes.forEach(cb => cb.checked = this.checked);
    });
    
    // Adicionar event listeners para os checkboxes individuais de classes
    const checkboxesClasses = document.querySelectorAll('.filtro-classe');
    checkboxesClasses.forEach(cb => {
        cb.addEventListener('change', function() {
            const todosMarcados = document.querySelectorAll('.filtro-classe:checked').length === checkboxesClasses.length;
            const nenhumMarcado = document.querySelectorAll('.filtro-classe:checked').length === 0;
            
            if (todosMarcados) {
                checkTodasClasses.checked = true;
                checkTodasClasses.indeterminate = false;
            } else if (nenhumMarcado) {
                checkTodasClasses.checked = false;
                checkTodasClasses.indeterminate = false;
            } else {
                checkTodasClasses.checked = false;
                checkTodasClasses.indeterminate = true;
            }
        });
    });
}

// Função para limpar filtro de taxa
function limparFiltroTaxa() {
    document.getElementById('taxa-minima').value = '';
    document.getElementById('taxa-maxima').value = '';
}

// Função para aplicar filtro
function aplicarFiltro() {
    // Obter filtros de defensores
    const todosDefensores = document.getElementById('filtro-todos-defensores').checked;
    const defensoresSelecionados = [];
    
    if (!todosDefensores) {
        const checkboxesDefensores = document.querySelectorAll('.filtro-defensor:checked');
        checkboxesDefensores.forEach(cb => defensoresSelecionados.push(cb.value));
    }
    
    // Obter filtros de classificações
    const todasClassificacoes = document.getElementById('filtro-todas-classificacoes').checked;
    const classificacoesSelecionadas = [];
    
    if (!todasClassificacoes) {
        const checkboxesClassificacoes = document.querySelectorAll('.filtro-classificacao:checked');
        checkboxesClassificacoes.forEach(cb => classificacoesSelecionadas.push(cb.value));
    }
    
    // Obter filtros de classes
    const todasClasses = document.getElementById('filtro-todas-classes').checked;
    const classesSelecionadas = [];
    
    if (!todasClasses) {
        const checkboxesClasses = document.querySelectorAll('.filtro-classe:checked');
        checkboxesClasses.forEach(cb => classesSelecionadas.push(cb.value));
    }
    
    // Obter filtros de taxa de acerto
    const taxaMinima = parseFloat(document.getElementById('taxa-minima').value) || 0;
    const taxaMaxima = parseFloat(document.getElementById('taxa-maxima').value) || 100;
    
    // Aplicar filtros nos checkboxes de intimações
    const checkboxes = document.querySelectorAll('.intimacao-checkbox');
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const classificacao = checkbox.dataset.classificacao || '';
        const defensor = row.dataset.defensor || '';
        
        // Obter classe da linha (precisamos adicionar data-classe)
        const classe = row.dataset.classe || '';
        
        // Obter taxa de acerto da intimação
        const taxaAcertoElement = row.querySelector('.taxa-acerto-cell .badge');
        let taxaAcerto = 0;
        if (taxaAcertoElement) {
            const taxaText = taxaAcertoElement.textContent.replace('%', '');
            taxaAcerto = parseFloat(taxaText) || 0;
        }
        
        let mostrarDefensor = todosDefensores || defensoresSelecionados.includes(defensor);
        let mostrarClassificacao = todasClassificacoes || classificacoesSelecionadas.includes(classificacao);
        let mostrarClasse = todasClasses || classesSelecionadas.includes(classe);
        let mostrarTaxa = taxaAcerto >= taxaMinima && taxaAcerto <= taxaMaxima;
        
        if (mostrarDefensor && mostrarClassificacao && mostrarClasse && mostrarTaxa) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
            checkbox.checked = false; // Desmarcar se estiver oculto
        }
    });
    
    atualizarResumo();
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalFiltro'));
    modal.hide();
    
    showToast('Filtro aplicado com sucesso!', 'success');
}

// Função para limpar filtros
function limparFiltros() {
    // Marcar todos os checkboxes como selecionados
    document.getElementById('filtro-todos-defensores').checked = true;
    document.getElementById('filtro-todas-classificacoes').checked = true;
    document.getElementById('filtro-todas-classes').checked = true;
    
    // Limpar filtros de taxa
    document.getElementById('taxa-minima').value = '';
    document.getElementById('taxa-maxima').value = '';
    
    // Marcar todos os checkboxes individuais (já que "Todos" está marcado)
    document.querySelectorAll('.filtro-defensor').forEach(cb => cb.checked = true);
    document.querySelectorAll('.filtro-classificacao').forEach(cb => cb.checked = true);
    document.querySelectorAll('.filtro-classe').forEach(cb => cb.checked = true);
    
    // Mostrar todas as intimações
    const checkboxes = document.querySelectorAll('.intimacao-checkbox');
    checkboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        row.style.display = '';
    });
    
    atualizarResumo();
    showToast('Filtros limpos!', 'info');
}

// Carregar taxas de acerto das intimações
function carregarTaxasAcerto() {
    console.log('🔄 Carregando taxas de acerto...');
    fetch('/api/intimacoes/taxa-acerto')
        .then(response => {
            console.log('📡 Resposta da API:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('📊 Dados recebidos:', data);
            if (data.success) {
                console.log('✅ Taxas de acerto carregadas:', data.taxas_acerto);
                atualizarTaxasAcerto(data.taxas_acerto);
            } else {
                console.error('❌ Erro ao carregar taxas de acerto:', data.message);
            }
        })
        .catch(error => {
            console.error('❌ Erro na requisição de taxas de acerto:', error);
        });
}

// Atualizar taxas de acerto na interface
function atualizarTaxasAcerto(taxasAcerto) {
    console.log('🎯 Atualizando taxas de acerto na interface:', taxasAcerto);
    Object.keys(taxasAcerto).forEach(intimacaoId => {
        const elemento = document.getElementById(`taxa-acerto-${intimacaoId}`);
        console.log(`🔍 Procurando elemento para intimação ${intimacaoId}:`, elemento);
        if (elemento) {
            const dados = taxasAcerto[intimacaoId];
            const taxa = dados.taxa_acerto;
            const total = dados.total_analises;
            const acertos = dados.acertos;
            
            // Determinar cor do badge baseado na taxa
            let badgeClass = 'bg-secondary';
            if (taxa >= 80) {
                badgeClass = 'bg-success';
            } else if (taxa >= 60) {
                badgeClass = 'bg-warning';
            } else if (taxa >= 40) {
                badgeClass = 'bg-danger';
            }
            
            elemento.innerHTML = `
                <div class="d-flex flex-column align-items-center position-relative" 
                     data-intimacao-id="${intimacaoId}"
                     style="cursor: pointer;">
                    <span class="badge ${badgeClass} mb-1">${taxa}%</span>
                    <small class="text-muted">${acertos}/${total}</small>
                    
                    <!-- Popover customizado -->
                    <div class="custom-popover" id="popover-${intimacaoId}" style="display: none;">
                        <div class="popover-content">
                            <div class="popover-body">
                                <div class="text-center">
                                    <i class="bi bi-hourglass-split"></i>
                                    Carregando detalhes...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Adicionar eventos para popover customizado
            const triggerElement = elemento.querySelector('[data-intimacao-id]');
            const popoverElement = elemento.querySelector('.custom-popover');
            
            // Variáveis para controle do popover
            elemento.popoverTimeout = null;
            elemento.showTimeout = null;
            elemento.isPopoverVisible = false;
            
            // Mostrar popover quando entrar no elemento (com delay)
            triggerElement.addEventListener('mouseenter', function() {
                clearTimeout(elemento.popoverTimeout);
                clearTimeout(elemento.showTimeout);
                
                // Armazenar ID da intimação atual globalmente
                window.currentIntimacaoId = intimacaoId;
                console.log('🔍 Intimação atual definida:', window.currentIntimacaoId);
                
                if (!elemento.isPopoverVisible) {
                    // Delay de 500ms para mostrar o popover
                    elemento.showTimeout = setTimeout(() => {
                        carregarDetalhesPrompts(intimacaoId, popoverElement);
                        popoverElement.style.display = 'block';
                        elemento.isPopoverVisible = true;
                    }, 500);
                }
            });
            
            // Esconder popover com delay quando sair do elemento
            triggerElement.addEventListener('mouseleave', function() {
                // Cancelar o timeout de mostrar se ainda não foi executado
                clearTimeout(elemento.showTimeout);
                
                elemento.popoverTimeout = setTimeout(() => {
                    if (elemento.isPopoverVisible) {
                        popoverElement.style.display = 'none';
                        elemento.isPopoverVisible = false;
                        
                        // ACRESCENTADO: Limpar checkboxes quando popover fecha
                        clearPopoverCheckboxes(popoverElement);
                    }
                }, 300);
            });
            
            // Manter popover visível quando mouse estiver sobre ele
            popoverElement.addEventListener('mouseenter', function() {
                clearTimeout(elemento.popoverTimeout);
            });
            
            popoverElement.addEventListener('mouseleave', function() {
                elemento.popoverTimeout = setTimeout(() => {
                    if (elemento.isPopoverVisible) {
                        popoverElement.style.display = 'none';
                        elemento.isPopoverVisible = false;
                        
                        // ACRESCENTADO: Limpar checkboxes quando popover fecha
                        clearPopoverCheckboxes(popoverElement);
                    }
                }, 300);
            });
        }
    });
}



// ACRESCENTADO: Função para limpar seleção dos checkboxes quando popover fecha
function clearPopoverCheckboxes(targetPopover = null) {
    let clearedCount = 0;
    
    if (targetPopover) {
        // Clear checkboxes do popover específico que foi passado como parâmetro
        const checkboxes = targetPopover.querySelectorAll('.prompt-checkbox');
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                checkbox.checked = false;
                clearedCount++;
            }
        });
    } else {
        // Clear todos os checkboxes de todos os popovers visíveis (fallback)
        const allPopovers = document.querySelectorAll('.custom-popover');
        allPopovers.forEach(popover => {
            const isVisible = popover.style.display !== 'none' && 
                             !popover.style.display.includes('none');
            
            if (isVisible) {
                const checkboxes = popover.querySelectorAll('.prompt-checkbox');
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        checkbox.checked = false;
                        clearedCount++;
                    }
                });
            }
        });
    }
    
    // ACRESCENTADO: Re-validar o botão após limpar seleção
    setTimeout(() => {
        updateCompareButton();
    }, 10);
    
    if (clearedCount > 0) {
        console.log(`🧹 ${clearedCount} checkboxes desmarcados quando popover fechou`);
    }
}

// Carregar detalhes dos prompts para o popover customizado
function carregarDetalhesPrompts(intimacaoId, popoverElement) {
    // Verificar se já foi carregado para evitar requisições desnecessárias
    if (popoverElement.dataset.loaded === 'true') {
        return; // Já foi carregado
    }
    
    // Mostrar loading no popover
    popoverElement.querySelector('.popover-body').innerHTML = `
        <div class="text-center">
            <i class="bi bi-hourglass-split"></i>
            Carregando detalhes...
        </div>
    `;
    
    fetch(`/api/intimacoes/${intimacaoId}/prompts-acerto`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const prompts = data.prompts_acerto;
                if (prompts.length === 0) {
                    const content = '<div class="text-center"><em>Nenhuma análise encontrada</em></div>';
                    popoverElement.querySelector('.popover-body').innerHTML = content;
                    popoverElement.dataset.loaded = 'true';
                    return;
                }
                
                // Construir conteúdo do popover
                let content = '<div class="text-start">';
                content += '<div class="fw-bold mb-2">Prompts Testados:</div>';
                
                prompts.forEach((prompt, index) => {
                    const taxa = prompt.taxa_acerto;
                    let badgeClass = 'bg-secondary';
                    if (taxa >= 80) {
                        badgeClass = 'bg-success';
                    } else if (taxa >= 60) {
                        badgeClass = 'bg-warning';
                    } else if (taxa >= 40) {
                        badgeClass = 'bg-danger';
                    }
                    
                    content += `
                        <div class="mb-2 p-2 border rounded prompt-card" 
                             style="transition: all 0.2s ease;">
                            <div class="d-flex align-items-start">
                                <div class="me-2 mt-1">
                                    <input type="checkbox" 
                                           class="form-check-input prompt-checkbox" 
                                           data-prompt-id="${prompt.prompt_id}"
                                           data-prompt-nome="${prompt.prompt_nome}"
                                           onchange="updateCompareButton()">
                                </div>
                                <div class="flex-grow-1" 
                                     onclick="window.open('/prompts/${prompt.prompt_id}', '_blank')" 
                                     style="cursor: pointer;">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold text-primary prompt-name">${prompt.prompt_nome}</div>
                                            <small class="text-muted">
                                                ${prompt.modelo} • Temp: ${prompt.temperatura}
                                            </small>
                                        </div>
                                        <span class="badge ${badgeClass} ms-2">${taxa}%</span>
                                    </div>
                                    <div class="mt-1">
                                        <small class="text-muted">${prompt.acertos}/${prompt.total_analises} acertos</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // ACRESCENTADO: Botão sempre habilitado com validação no backend
                content += `
                    <div class="mt-3 pt-2 border-top">
                        <button type="button" 
                                class="btn btn-primary btn-sm w-100" 
                                id="btn-compare-prompts"
                                onclick="compareSelectedPrompts()">
                            <i class="bi bi-arrow-left-right"></i>
                            Comparar Prompts Selecionados
                        </button>
                    </div>
                `;
                
                content += '</div>';
                
                popoverElement.querySelector('.popover-body').innerHTML = content;
                popoverElement.dataset.loaded = 'true';
                
                // ACRESCENTADO: Aguardar um ciclo do event loop para garantir que o HTML foi renderizado  
                setTimeout(() => {
                    // ACRESCENTADO: Botão sempre enabled agora não precisa updateCompareButton (only text update)
                    const dynamicCheckboxes = popoverElement.querySelectorAll('.prompt-checkbox');
                    dynamicCheckboxes.forEach(checkbox => {
                        const newCheckbox = checkbox.cloneNode(true);
                        checkbox.parentNode.replaceChild(newCheckbox, checkbox);
                        newCheckbox.addEventListener('change', updateCompareButton);
                    });
                    
                    updateCompareButton(); // Current simple version 
                }, 50);
            } else {
                const content = '<div class="text-center"><em>Erro ao carregar detalhes</em></div>';
                popoverElement.querySelector('.popover-body').innerHTML = content;
            }
        })
        .catch(error => {
            console.error('Erro ao carregar detalhes dos prompts:', error);
            const content = '<div class="text-center"><em>Erro ao carregar</em></div>';
            popoverElement.querySelector('.popover-body').innerHTML = content;
        });
}

// Função para limpar formulário
function limparFormulario() {
    document.getElementById('prompt-selecionado').value = '';
    limparSelecaoIntimacoes();
    
    document.getElementById('temperatura').value = '{{ temperatura_padrao }}';
    document.getElementById('temp-value').textContent = '{{ temperatura_padrao }}';
    document.getElementById('max-tokens').value = '{{ max_tokens_padrao }}';
    document.getElementById('timeout').value = '30';
    
    document.getElementById('salvar-resultados').checked = true;
    document.getElementById('calcular-acuracia').checked = true;
    document.getElementById('modo-paralelo').checked = false;
    
    atualizarResumo();
    limparResultados();
    
    showToast('Formulário limpo!', 'info');
}

// Função para executar análise
function executarAnalise() {
    console.log('=== DEBUG: executarAnalise chamada ===');
    const promptSelecionado = document.getElementById('prompt-selecionado').value;
    const intimacoesSelecionadas = Array.from(document.querySelectorAll('.intimacao-checkbox:checked')).map(cb => cb.value);
    
    if (!promptSelecionado) {
        showToast('Selecione um prompt!', 'error');
        return;
    }
    
    if (intimacoesSelecionadas.length === 0) {
        showToast('Selecione pelo menos uma intimação!', 'error');
        return;
    }
    
    const dados = {
        prompt_id: promptSelecionado,
        intimacao_ids: intimacoesSelecionadas,
        configuracoes: {
        modelo: document.getElementById('modelo').value,
        temperatura: parseFloat(document.getElementById('temperatura').value),
        max_tokens: parseInt(document.getElementById('max-tokens').value),
        timeout: parseInt(document.getElementById('timeout').value),
        salvar_resultados: document.getElementById('salvar-resultados').checked,
        calcular_acuracia: document.getElementById('calcular-acuracia').checked,
        modo_paralelo: document.getElementById('modo-paralelo').checked
        }
    };
    
    iniciarAnalise(dados);
}

// Função para iniciar análise
function iniciarAnalise(dados) {
    // Mostrar loading
    mostrarLoading();
    
    // Desabilitar botão
    const btnExecutar = document.getElementById('btn-executar');
    btnExecutar.disabled = true;
    btnExecutar.innerHTML = '<i class="bi bi-hourglass-split"></i> Executando...';
    
    // Limpar resultados anteriores
    limparResultados();
    
    // Executar análise real no backend
    executarAnaliseReal(dados);
}

// Função para executar análise real
function executarAnaliseReal(dados) {
    console.log('=== DEBUG: executarAnaliseReal chamada com dados:', dados);
    
    // Gerar session ID único para cancelamento
    sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    console.log('=== DEBUG: Session ID gerado:', sessionId);
    
    // Adicionar session ID aos dados
    dados.session_id = sessionId;
    
    // Configurar variáveis de progresso
    analiseEmAndamento = true;
    totalIntimacoes = dados.intimacao_ids.length;
    intimacoesProcessadas = 0;
    
    // Inicializar progresso
    atualizarProgresso(0, totalIntimacoes, 'Iniciando análise...');
    
    // Iniciar Server-Sent Events para progresso
    iniciarSSEProgresso();
    
    // Fazer chamada real para o backend
    fetch('/executar-analise', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(dados)
    })
    .then(response => {
        console.log('=== DEBUG: Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('=== DEBUG: Dados recebidos do backend:', data);
        
        if (data.success) {
            // Converter dados do backend para o formato esperado
            resultadosAnalise = data.resultados.map(resultado => ({
                prompt_id: resultado.prompt_id,
                prompt_nome: resultado.prompt_nome,
                regra_negocio: resultado.regra_negocio,
                intimacao_id: resultado.intimacao_id,
                resultado_ia: resultado.resultado_ia,
                classificacao_manual: resultado.classificacao_manual,
                informacao_adicional: resultado.informacao_adicional,
                tempo_processamento: resultado.tempo_processamento,
                acertou: resultado.acertou,
                prompt_completo: resultado.prompt_completo,
                resposta_completa: resultado.resposta_completa,
                modelo: resultado.modelo,
                temperatura: resultado.temperatura,
                tokens_input: resultado.tokens_input,
                tokens_output: resultado.tokens_output,
                custo_real: resultado.custo_real,
                provider: resultado.provider,
                // Incluir dados completos da intimação para o card
                intimacao: resultado.intimacao || {}
            }));
            
            // Aguardar um pouco para mostrar o progresso final
            setTimeout(() => {
                finalizarAnalise();
            }, 1000);
        } else if (data.cancelado) {
            // Análise foi cancelada
            console.log('=== DEBUG: Análise cancelada pelo usuário ===');
            finalizarAnaliseCancelada();
        } else {
            throw new Error(data.error || 'Erro desconhecido');
        }
    })
    .catch(error => {
        console.error('=== ERRO na análise:', error);
        
        // Resetar variáveis
        analiseEmAndamento = false;
        totalIntimacoes = 0;
        intimacoesProcessadas = 0;
        
        // Fechar SSE
        if (eventoSource) {
            eventoSource.close();
            eventoSource = null;
        }
        
        // Esconder loading
        esconderLoading();
        
        // Reabilitar botão
        const btnExecutar = document.getElementById('btn-executar');
        btnExecutar.disabled = false;
        btnExecutar.innerHTML = '<i class="bi bi-play-circle"></i> Executar Análise';
        
        showToast('Erro na análise: ' + error.message, 'error');
    });
}

// Função para iniciar Server-Sent Events
function iniciarSSEProgresso() {
    if (eventoSource) {
        eventoSource.close();
    }
    
    // Passar o total real de intimações para o endpoint
    eventoSource = new EventSource(`/api/analise-progresso?total=${totalIntimacoes}`);
    
    eventoSource.onmessage = function(event) {
        try {
            console.log('=== SSE Raw message:', event.data);
            const data = JSON.parse(event.data);
            console.log('=== SSE Progresso:', data);
            
            switch(data.tipo) {
                case 'inicio':
                    console.log('=== SSE: Início recebido');
                    atualizarProgresso(0, data.total, 'Iniciando análise...');
                    break;
                    
                case 'progresso':
                    console.log('=== SSE: Progresso recebido -', data.atual, 'de', data.total);
                    intimacoesProcessadas = data.atual;
                    atualizarProgresso(data.atual, data.total, data.descricao);
                    break;
                    
                case 'conclusao':
                    console.log('=== SSE: Conclusão recebida');
                    atualizarProgresso(data.total, data.total, 'Análise concluída!');
                    break;
                    
                case 'erro':
                    console.error('=== ERRO SSE:', data.mensagem);
                    showToast('Erro no progresso: ' + data.mensagem, 'error');
                    break;
            }
        } catch (error) {
            console.error('=== ERRO ao processar SSE:', error);
        }
    };
    
    eventoSource.onerror = function(error) {
        console.error('=== ERRO SSE:', error);
        if (eventoSource) {
            eventoSource.close();
            eventoSource = null;
        }
    };
}

// Função para finalizar análise cancelada
function finalizarAnaliseCancelada() {
    // Fechar SSE
    if (eventoSource) {
        eventoSource.close();
        eventoSource = null;
    }
    
    // Resetar variáveis de progresso
    analiseEmAndamento = false;
    totalIntimacoes = 0;
    intimacoesProcessadas = 0;
    sessionId = null;
    
    // Esconder loading
    esconderLoading();
    
    // Reabilitar botão
    const btnExecutar = document.getElementById('btn-executar');
    btnExecutar.disabled = false;
    btnExecutar.innerHTML = '<i class="bi bi-play-circle"></i> Executar Análise';
    
    showToast('Análise cancelada com sucesso', 'warning');
}

// Função para finalizar análise
function finalizarAnalise() {
    const totalAnalises = resultadosAnalise.length;
    const acertos = resultadosAnalise.filter(r => r.acertou).length;
    const acuracia = totalAnalises > 0 ? (acertos / totalAnalises * 100).toFixed(1) : 0;
    
    // Fechar SSE
    if (eventoSource) {
        eventoSource.close();
        eventoSource = null;
    }
    
    // Resetar variáveis de progresso
    analiseEmAndamento = false;
    totalIntimacoes = 0;
    intimacoesProcessadas = 0;
    sessionId = null;
    
    // Esconder loading
    esconderLoading();
    
    // Reabilitar botão
    const btnExecutar = document.getElementById('btn-executar');
    btnExecutar.disabled = false;
    btnExecutar.innerHTML = '<i class="bi bi-play-circle"></i> Executar Análise';
    
    // Mostrar resultados
    exibirResultados();
    
    // Scroll suave para os resultados
    setTimeout(() => {
        scrollParaResultados();
    }, 100);
    
    showToast(`${totalAnalises} análises concluídas. Acurácia: ${acuracia}%`, 'success');
    
    // Toast para avisar que foi adicionado ao histórico
    setTimeout(() => {
        showToast('📊 Análise adicionada ao histórico! Clique em "Histórico" no menu para visualizar.', 'info');
    }, 1500);
    
}

// Função para exibir resultados
function exibirResultados() {
    const container = document.getElementById('resultados-container');
    const cardResultados = document.getElementById('card-resultados');
    
    if (resultadosAnalise.length === 0) {
        cardResultados.style.display = 'none';
        return;
    }
    
    // Calcular estatísticas
    const totalAnalises = resultadosAnalise.length;
    const acertos = resultadosAnalise.filter(r => r.acertou).length;
    const erros = totalAnalises - acertos;
    const acuracia = totalAnalises > 0 ? (acertos / totalAnalises * 100).toFixed(1) : 0;
    const tempoMedio = (resultadosAnalise.reduce((sum, r) => sum + r.tempo_processamento, 0) / totalAnalises).toFixed(2);
    const custoTotal = resultadosAnalise.reduce((sum, r) => sum + (r.custo_real || 0), 0);
    

    
    // Atualizar resumo geral
    document.getElementById('resumo-geral').style.display = 'block';
    document.getElementById('total-testes').textContent = totalAnalises;
    document.getElementById('acertos').textContent = acertos;
    document.getElementById('erros').textContent = erros;
    document.getElementById('acuracia-geral').textContent = acuracia + '%';
    
    // Carregar configuração de colunas
    const configSalva = localStorage.getItem('configuracaoColunas');
    if (configSalva) {
        configuracaoColunas = JSON.parse(configSalva);
        console.log('=== DEBUG: Configuração aplicada na tabela:', configuracaoColunas);
    } else {
        console.log('=== DEBUG: Usando configuração padrão na tabela');
    }
    
    let html = `
        <!-- Detalhes dos Resultados -->
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        ${configuracaoColunas.intimacao ? '<th>Intimação</th>' : ''}
                        ${configuracaoColunas.classificacao_manual ? '<th>Classificação Manual</th>' : ''}
                        ${configuracaoColunas.informacao_adicional ? '<th>Informação Adicional</th>' : ''}
                        ${configuracaoColunas.resultado_ia ? '<th>Resultado IA</th>' : ''}
                        ${configuracaoColunas.status ? '<th>Status</th>' : ''}
                        ${configuracaoColunas.configuracoes ? '<th>Configurações</th>' : ''}
                        ${configuracaoColunas.tempo ? '<th>Tempo</th>' : ''}
                        ${configuracaoColunas.custo ? '<th>Custo</th>' : ''}
                        ${configuracaoColunas.tokens_input ? '<th>Tokens Input</th>' : ''}
                        ${configuracaoColunas.tokens_output ? '<th>Tokens Output</th>' : ''}
                        ${configuracaoColunas.prompt ? '<th>Prompt</th>' : ''}
                        ${configuracaoColunas.resposta ? '<th>Resposta</th>' : ''}
                    </tr>
                </thead>
                <tbody>
    `;
    
    resultadosAnalise.forEach(resultado => {
        console.log('=== DEBUG: Processando resultado:', resultado);
        console.log('=== DEBUG: Modelo:', resultado.modelo);
        console.log('=== DEBUG: Temperatura:', resultado.temperatura);
        console.log('=== DEBUG: Informação Adicional:', resultado.informacao_adicional);
        
        const statusClass = resultado.acertou ? 'text-success' : 'text-danger';
        const statusIcon = resultado.acertou ? 'bi-check-circle' : 'bi-x-circle';
        const statusText = resultado.acertou ? 'Acertou' : 'Errou';
        
        // Armazenar dados completos no objeto global
        dadosCompletos[resultado.intimacao_id] = {
            prompt_completo: resultado.prompt_completo || 'N/A',
            resposta_completa: resultado.resposta_completa || 'N/A'
        };
        
        html += `
            <tr class="resultado-row visivel" data-acertou="${resultado.acertou}">
                ${configuracaoColunas.intimacao ? `<td>${gerarCardCompactoIntimacao(resultado)}</td>` : ''}
                ${configuracaoColunas.classificacao_manual ? `<td><span class="badge bg-secondary">${resultado.classificacao_manual || 'N/A'}</span></td>` : ''}
                ${configuracaoColunas.informacao_adicional ? `<td>
                    ${resultado.informacao_adicional ? 
                        `<small class="text-muted">
                            ${resultado.informacao_adicional.length > 100 ? 
                                resultado.informacao_adicional.substring(0, 100) + '...' : 
                                resultado.informacao_adicional
                            }
                        </small>` : 
                        '<small class="text-muted">N/A</small>'
                    }
                </td>` : ''}
                ${configuracaoColunas.resultado_ia ? `<td><span class="badge ${getBadgeClass(resultado.resultado_ia)}">${resultado.resultado_ia || 'N/A'}</span></td>` : ''}
                ${configuracaoColunas.status ? `<td class="status-cell"><i class="bi ${statusIcon} ${statusClass}"></i> ${statusText}</td>` : ''}
                ${configuracaoColunas.configuracoes ? `<td>
                    <small>
                        <div><strong>Modelo:</strong> ${resultado.modelo || 'N/A'}</div>
                        <div><strong>Temp:</strong> ${resultado.temperatura !== undefined && resultado.temperatura !== null ? parseFloat(resultado.temperatura).toFixed(1) : 'N/A'}</div>
                    </small>
                </td>` : ''}
                ${configuracaoColunas.tempo ? `<td><small>${(resultado.tempo_processamento || 0).toFixed(2)}s</small></td>` : ''}
                ${configuracaoColunas.custo ? `<td><small>${formatarCusto(resultado)}</small></td>` : ''}
                ${configuracaoColunas.tokens_input ? `<td><small>${resultado.tokens_input || 0}</small></td>` : ''}
                ${configuracaoColunas.tokens_output ? `<td><small>${resultado.tokens_output || 0}</small></td>` : ''}
                ${configuracaoColunas.prompt ? `<td>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="mostrarPromptCompleto('${resultado.intimacao_id}')" title="Ver prompt completo">
                        <i class="bi bi-code-square"></i>
                    </button>
                </td>` : ''}
                ${configuracaoColunas.resposta ? `<td>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="mostrarRespostaCompleta('${resultado.intimacao_id}')" title="Ver resposta completa">
                        <i class="bi bi-chat-dots"></i>
                    </button>
                </td>` : ''}
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        
        <!-- Estatísticas Detalhadas -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h4>${tempoMedio}s</h4>
                        <small>Tempo Médio</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h4>$${custoTotal > 0 ? custoTotal.toFixed(6) : '0.000000'}</h4>
                        <small>Custo Total</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white prompt-card" style="cursor: pointer;" 
                     data-prompt-id="${resultadosAnalise[0].prompt_id}"
                     data-bs-toggle="tooltip" 
                     data-bs-placement="top" 
                     data-bs-html="true"
                     title="<strong>Regra de Negócio:</strong><br>${resultadosAnalise[0].regra_negocio || 'N/A'}">
                    <div class="card-body text-center">
                        <h4>${truncarTexto(resultadosAnalise[0].prompt_nome, 20)}</h4>
                        <small>Prompt Testado</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-secondary text-white">
                    <div class="card-body text-center">
                        <h4>${document.getElementById('modelo').value}</h4>
                        <small>Modelo Usado</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    cardResultados.style.display = 'block';
    
    // Armazenar resultados para filtros
    armazenarResultadosAtuais(resultadosAnalise);
    

    
    // Inicializar tooltips após renderizar a tabela
    setTimeout(async () => {
        await inicializarTooltips();
        
        // Adicionar event listener para o card de prompt
        const promptCard = document.querySelector('.prompt-card');
        if (promptCard) {
            promptCard.addEventListener('click', function() {
                const promptId = this.getAttribute('data-prompt-id');
                navegarParaPrompt(promptId);
            });
        }
    }, 100);
}

// Função para limpar resultados
function limparResultados() {
    resultadosAnalise = [];
    const cardResultados = document.getElementById('card-resultados');
    if (cardResultados) {
        cardResultados.style.display = 'none';
    }
}

// Função para exportar resultados
function exportarResultados() {
    if (resultadosAnalise.length === 0) {
        showToast('Nenhum resultado para exportar!', 'warning');
        return;
    }
    
    const dados = {
        timestamp: new Date().toISOString(),
        total_analises: resultadosAnalise.length,
        acuracia_geral: (resultadosAnalise.filter(r => r.acertou).length / resultadosAnalise.length * 100).toFixed(1),
        tempo_medio: (resultadosAnalise.reduce((sum, r) => sum + r.tempo_processamento, 0) / resultadosAnalise.length).toFixed(2),
        custo_total: 'N/A', // Cálculo de custo removido
        resultados: resultadosAnalise
    };
    
    const dataStr = JSON.stringify(dados, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `analise_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showToast('Resultados exportados!', 'success');
}

// Controle do filtro "todas"
const filtroTodas = document.getElementById('filtro-todas');
if (filtroTodas) {
    filtroTodas.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.filtro-classificacao');
    checkboxes.forEach(cb => {
        cb.checked = this.checked;
        cb.disabled = this.checked;
    });
});
}

// Controle dos filtros individuais
document.querySelectorAll('.filtro-classificacao').forEach(cb => {
    cb.addEventListener('change', function() {
        const todasMarcadas = document.querySelectorAll('.filtro-classificacao:checked').length === document.querySelectorAll('.filtro-classificacao').length;
        const filtroTodas = document.getElementById('filtro-todas');
        if (filtroTodas) filtroTodas.checked = todasMarcadas;
    });
});

// Atalhos de teclado






// Funções para mostrar prompt e resposta completos
function mostrarPromptCompleto(intimacaoId) {
    console.log('=== DEBUG: mostrarPromptCompleto chamada ===');
    console.log('Intimação ID:', intimacaoId);
    console.log('Dados completos:', dadosCompletos);
    
    const dados = dadosCompletos[intimacaoId];
    const promptCompleto = dados ? dados.prompt_completo : 'N/A';
    
    console.log('Prompt completo:', promptCompleto);
    console.log('Prompt completo length:', promptCompleto ? promptCompleto.length : 'null');
    
    const elementoId = document.getElementById('prompt-intimacao-id');
    const elementoConteudo = document.getElementById('prompt-completo-conteudo');
    
    console.log('Elemento ID encontrado:', elementoId);
    console.log('Elemento conteúdo encontrado:', elementoConteudo);
    
    if (elementoId) elementoId.textContent = intimacaoId;
    if (elementoConteudo) elementoConteudo.textContent = promptCompleto;
    
    const modal = new bootstrap.Modal(document.getElementById('modalPromptCompleto'));
    modal.show();
}

function mostrarRespostaCompleta(intimacaoId) {
    console.log('=== DEBUG: mostrarRespostaCompleta chamada ===');
    console.log('Intimação ID:', intimacaoId);
    console.log('Dados completos:', dadosCompletos);
    
    const dados = dadosCompletos[intimacaoId];
    const respostaCompleta = dados ? dados.resposta_completa : 'N/A';
    
    console.log('Resposta completa:', respostaCompleta);
    console.log('Resposta completa length:', respostaCompleta ? respostaCompleta.length : 'null');
    
    const elementoId = document.getElementById('resposta-intimacao-id');
    const elementoConteudo = document.getElementById('resposta-completa-conteudo');
    
    console.log('Elemento ID encontrado:', elementoId);
    console.log('Elemento conteúdo encontrado:', elementoConteudo);
    
    if (elementoId) elementoId.textContent = intimacaoId;
    if (elementoConteudo) elementoConteudo.textContent = respostaCompleta;
    
    const modal = new bootstrap.Modal(document.getElementById('modalRespostaCompleta'));
    modal.show();
}

function copiarPrompt() {
    const conteudo = document.getElementById('prompt-completo-conteudo').textContent;
    navigator.clipboard.writeText(conteudo).then(() => {
        showToast('Prompt copiado para a área de transferência!', 'success');
    });
}

function copiarPromptModal() {
    const conteudo = document.getElementById('modal-prompt-content').textContent;
    navigator.clipboard.writeText(conteudo).then(() => {
        showToast('Prompt copiado para a área de transferência!', 'success');
    });
}

function copiarResposta() {
    const conteudo = document.getElementById('resposta-completa-conteudo').textContent;
    navigator.clipboard.writeText(conteudo).then(() => {
        showToast('Resposta copiada para a área de transferência!', 'success');
    });
}

// Função para excluir intimação da tabela
function excluirIntimacaoTabela(intimacaoId) {
    if (confirm('Tem certeza que deseja excluir esta intimação?')) {
        console.log('=== DEBUG: EXCLUINDO INTIMAÇÃO DA TABELA ===');
        console.log('ID da intimação:', intimacaoId);
        
        // Fazer requisição para excluir
        fetch(`/api/intimacoes/${intimacaoId}/excluir`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Resposta da exclusão:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dados da resposta:', data);
            
            if (data.success) {
                showToast('Intimação excluída com sucesso!', 'success');
                
                // Remover a linha da tabela
                const row = document.querySelector(`tr[data-intimacao-id="${intimacaoId}"]`);
                if (row) {
                    row.remove();
                }
                
                // Atualizar contador de intimações
                updateIntimacoesSelection();
            } else {
                showToast(`Erro ao excluir: ${data.message}`, 'error');
            }
        })
        .catch(error => {
            console.error('Erro na exclusão:', error);
            showToast('Erro ao excluir intimação!', 'error');
        });
    }
}

// Função para determinar a classe da badge baseada na classificação
function getBadgeClass(classificacao) {
    const badgeClasses = {
        'ELABORAR PEÇA': 'bg-primary',
        'CONTATAR ASSISTIDO': 'bg-info',
        'ANALISAR PROCESSO': 'bg-warning',
        'RENUNCIAR PRAZO': 'bg-success',
        'ENCAMINHAR INTIMAÇÃO PARA OUTRO DEFENSOR': 'bg-secondary',
        'URGÊNCIA': 'bg-danger',
        'OCULTAR': 'bg-dark'
    };
    
    return badgeClasses[classificacao] || 'bg-secondary';
}

// Inicializar resumo
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DOMContentLoaded executado ===');
    
    atualizarResumo();
    atualizarConfigSummary();
    carregarConfiguracaoColunas();
    carregarConfigColunasIntimacoes();
    
    
    // Inicializar botão de regras de negócio
    atualizarBotaoRegrasNegocio();
    
    // Carregar taxas de acerto das intimações
    carregarTaxasAcerto();
    
    // Adicionar event listeners para atalhos de teclado
document.addEventListener('keydown', function(e) {
    // Ctrl+Enter para executar
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault();
        executarAnalise();
    }
    
    // Ctrl+R para limpar
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        limparFormulario();
    }
    

});
});

// Função para visualizar contexto da intimação
function visualizarContexto(intimacaoId, contexto) {
    console.log('=== Visualizando contexto da intimação:', intimacaoId);
    console.log('=== Contexto recebido:', contexto);
    
    const modalElement = document.getElementById('modalContextoIntimacao');
    const contextoContent = document.getElementById('modal-contexto-content');
    
    // Decodificar o contexto (remover escapes)
    let contextoDecodificado = contexto || 'Contexto não disponível';
    
    // Remover escapes de caracteres especiais
    contextoDecodificado = contextoDecodificado.replace(/\\n/g, '\n');
    contextoDecodificado = contextoDecodificado.replace(/\\r/g, '\r');
    contextoDecodificado = contextoDecodificado.replace(/\\`/g, '`');
    contextoDecodificado = contextoDecodificado.replace(/\\"/g, '"');
    contextoDecodificado = contextoDecodificado.replace(/\\'/g, "'");
    
    console.log('=== Contexto decodificado:', contextoDecodificado);
    
    // Armazenar o contexto original para copiar
    window.contextoOriginal = contextoDecodificado;
    
    // Processar o contexto para melhorar a formatação Markdown
    let contextoProcessado = contextoDecodificado;
    
    // Limpar espaçamentos excessivos
    contextoProcessado = contextoProcessado.replace(/\n{3,}/g, '\n\n');
    
    // Melhorar formatação de títulos (se não estiverem já formatados)
    contextoProcessado = contextoProcessado.replace(/^#\s+(.+)$/gm, '# $1');
    contextoProcessado = contextoProcessado.replace(/^##\s+(.+)$/gm, '## $1');
    contextoProcessado = contextoProcessado.replace(/^###\s+(.+)$/gm, '### $1');
    
    // Melhorar formatação de negrito (se não estiverem já formatados)
    contextoProcessado = contextoProcessado.replace(/\*\*(.+?)\*\*/g, '**$1**');
    
    // Processar seções de documento para reduzir espaçamento
    // Identificar seções que começam com "### Documento" e tratar como bloco contínuo
    contextoProcessado = contextoProcessado.replace(/(### Documento \d+)\n\n/g, '$1\n');
    
    // Para seções de documento, usar quebras simples em vez de duplas
    const secoes = contextoProcessado.split(/(### Documento \d+)/);
    if (secoes.length > 1) {
        for (let i = 2; i < secoes.length; i += 2) {
            // Seção de conteúdo do documento
            secoes[i] = secoes[i].replace(/\n\n/g, '\n');
            // Forçar criação de parágrafos para cada linha
            secoes[i] = secoes[i].split('\n').map(linha => linha.trim()).filter(linha => linha.length > 0).join('\n\n');
            // Adicionar marcador especial para identificar seção de documento
            secoes[i] = '<!-- DOCUMENTO-SECTION -->' + secoes[i] + '<!-- END-DOCUMENTO-SECTION -->';
        }
        contextoProcessado = secoes.join('');
    }
    
    // Converter quebras de linha restantes em Markdown (mas não excessivamente)
    contextoProcessado = contextoProcessado.replace(/\n/g, '\n\n');
    
    // Limpar espaçamentos duplos no final
    contextoProcessado = contextoProcessado.replace(/\n\n+$/g, '\n');
    
    console.log('=== Contexto processado para Markdown:', contextoProcessado);
    
    // Renderizar Markdown
    try {
        // Verificar se a biblioteca Marked está disponível
        if (typeof marked === 'undefined') {
            console.error('Biblioteca Marked.js não está carregada!');
            contextoContent.textContent = contextoProcessado;
        } else {
            console.log('=== Marked.js disponível, renderizando...');
            const htmlRenderizado = marked.parse(contextoProcessado);
            console.log('=== HTML renderizado:', htmlRenderizado);
            contextoContent.innerHTML = htmlRenderizado;
            
            // Aplicar estilos específicos para seções de documento
            setTimeout(() => {
                console.log('=== Aplicando estilos específicos para documento ===');
                const h3Elements = contextoContent.querySelectorAll('h3');
                console.log('H3 encontrados:', h3Elements.length);
                
                h3Elements.forEach((h3, index) => {
                    console.log(`H3 ${index}:`, h3.textContent);
                    if (h3.textContent.includes('Documento')) {
                        console.log('=== Encontrou seção Documento! ===');
                        
                        // Verificar todos os elementos após o H3
                        let nextElement = h3.nextElementSibling;
                        let contador = 0;
                        console.log('=== Verificando elementos após H3 ===');
                        
                        while (nextElement && nextElement.tagName !== 'H3') {
                            console.log(`Elemento encontrado:`, nextElement.tagName, nextElement.textContent.substring(0, 50));
                            
                            // Aplicar estilos a qualquer elemento de texto (p, div, span, etc.)
                            if (nextElement.tagName === 'P' || nextElement.tagName === 'DIV' || nextElement.tagName === 'SPAN') {
                                console.log(`Aplicando estilo ao elemento ${contador}:`, nextElement.textContent.substring(0, 50));
                                nextElement.style.marginBottom = '3px';
                                nextElement.style.lineHeight = '1.4';
                                nextElement.style.fontSize = '0.95rem';
                                nextElement.style.fontWeight = '400';
                                nextElement.style.color = '#333';
                                nextElement.style.backgroundColor = 'transparent';
                                nextElement.style.padding = '0';
                                contador++;
                            }
                            nextElement = nextElement.nextElementSibling;
                        }
                        console.log(`Estilos aplicados a ${contador} elementos`);
                    }
                });
                
                // Tentar abordagem alternativa com marcadores
                const htmlContent = contextoContent.innerHTML;
                console.log('=== HTML completo da modal ===');
                console.log(htmlContent.substring(0, 500));
                
                if (htmlContent.includes('<!-- DOCUMENTO-SECTION -->')) {
                    console.log('=== Processando marcadores de documento ===');
                    let newHtml = htmlContent;
                    
                    // Encontrar e processar seções de documento
                    const regex = /<!-- DOCUMENTO-SECTION -->(.*?)<!-- END-DOCUMENTO-SECTION -->/gs;
                    newHtml = newHtml.replace(regex, (match, content) => {
                        console.log('Processando seção de documento:', content.substring(0, 100));
                        // Adicionar classe especial aos parágrafos
                        return content.replace(/<p>/g, '<p class="documento-paragrafo">');
                    });
                    
                    contextoContent.innerHTML = newHtml;
                    
                    // Aplicar estilos aos parágrafos com a classe
                    const docParagrafos = contextoContent.querySelectorAll('.documento-paragrafo');
                    console.log('Parágrafos de documento encontrados:', docParagrafos.length);
                    docParagrafos.forEach((p, index) => {
                        console.log(`Aplicando estilo ao parágrafo ${index}:`, p.textContent.substring(0, 50));
                        p.style.fontSize = '0.95rem';
                        p.style.fontWeight = '400';
                        p.style.color = '#333';
                        p.style.backgroundColor = 'transparent';
                        p.style.padding = '0';
                        p.style.marginBottom = '3px';
                        p.style.lineHeight = '1.4';
                    });
                }
            }, 50);
        }
    } catch (error) {
        console.error('Erro ao renderizar Markdown:', error);
        // Fallback para texto simples
        contextoContent.textContent = contextoProcessado;
    }
    
    // Mostrar a modal
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

// Função para copiar contexto
function copiarContexto() {
    // Armazenar o contexto original em uma variável global quando a modal é aberta
    const texto = window.contextoOriginal || 'Contexto não disponível';
    
    navigator.clipboard.writeText(texto).then(() => {
        showToast('Contexto copiado para a área de transferência!', 'success');
    }).catch(err => {
        console.error('Erro ao copiar contexto:', err);
        showToast('Erro ao copiar contexto!', 'error');
    });
}

// Função para formatar custo com ícone (i) e tooltip
function formatarCusto(resultado) {
    const custoReal = resultado.custo_real || 0;
    const tokensInput = resultado.tokens_input || 0;
    const tokensOutput = resultado.tokens_output || 0;
    const modelo = resultado.modelo || 'gpt-4o-mini';
    const provider = resultado.provider || 'azure'; // Usar provider real da análise
    
    const custoFormatado = custoReal > 0 ? `$${custoReal.toFixed(6)}` : '$0.000000';
    
    return `${custoFormatado}
            <i class="bi bi-info-circle text-muted ms-1 custo-info-icon" 
               style="cursor: pointer; font-size: 0.8em;" 
               data-bs-toggle="tooltip" 
               data-bs-placement="top" 
               data-bs-html="true"
               data-modelo="${modelo}"
               data-tokens-input="${tokensInput}"
               data-tokens-output="${tokensOutput}"
               data-custo-real="${custoReal}"
               data-provider="${provider}"></i>`;
}

// Preços dos modelos (carregados dinamicamente)
// REMOVIDO: Todas as funções de preços duplicadas - usando apenas o serviço isolado costCalculationFrontend

// FUNÇÃO PARA TOOLTIP DE CUSTO (USANDO SERVIÇO DO BACKEND)
async function criarTooltipCusto(elemento) {
    const modelo = elemento.dataset.modelo;
    const tokensInput = parseInt(elemento.dataset.tokensInput);
    const tokensOutput = parseInt(elemento.dataset.tokensOutput);
    const custoReal = parseFloat(elemento.dataset.custoReal);
    const provider = elemento.dataset.provider;

    try {
        // Usar o serviço de custo do backend
        const response = await fetch(`/api/tooltip-custo?modelo=${modelo}&tokens_input=${tokensInput}&tokens_output=${tokensOutput}&provider=${provider}&custo_real=${custoReal}`);
        const data = await response.json();
        if (data.success) {
            return data.tooltip_html;
        }
    } catch (error) {
        console.error('Erro ao gerar tooltip:', error);
    }
    
    // Fallback simples se der erro
    return `<strong>Memória de Cálculo:</strong><br>
            Provider: ${provider}<br>
            Modelo: ${modelo}<br>
            Tokens: ${tokensInput} + ${tokensOutput}<br>
            <strong>Total: $${custoReal.toFixed(6)}</strong>`;
}

// Função para inicializar tooltips
async function inicializarTooltips() {
    // Destruir tooltips existentes
    const tooltipsExistentes = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltipsExistentes.forEach(element => {
        const tooltip = bootstrap.Tooltip.getInstance(element);
        if (tooltip) {
            tooltip.dispose();
        }
    });
    
    // Configurar tooltips de custo
    const custoIcons = document.querySelectorAll('.custo-info-icon');
    for (const icon of custoIcons) {
        const tooltipContent = await criarTooltipCusto(icon);
        icon.setAttribute('title', tooltipContent);
    }
    
    // Inicializar tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            html: true,
            delay: { show: 300, hide: 100 }
        });
    });
}

// Função para gerar card compacto de intimação
function gerarCardCompactoIntimacao(resultado) {
    // Buscar dados completos da intimação
    const intimacao = resultado.intimacao || {};
    const intimacaoId = resultado.intimacao_id;
    
    return `
        <a href="/intimacoes/${intimacaoId}" class="card-link-wrapper" style="text-decoration: none; color: inherit;">
            <div class="intimacao-card-compact">
                <div class="card-intimacao-header-compact">
                    <div class="card-intimacao-processo-compact">
                        <i class="bi bi-hourglass"></i>
                        <span class="processo-numero-compact">${intimacao.processo || 'N/A'}</span>
                    </div>
                </div>
                <div class="card-intimacao-content-compact">
                    <div class="card-intimacao-row-compact">
                        <div class="card-intimacao-field-compact">
                            <span class="field-label-compact">Órgão:</span>
                            <span class="field-value-compact">${intimacao.orgao_julgador || 'N/A'}</span>
                        </div>
                        <div class="card-intimacao-field-compact">
                            <span class="field-label-compact">Status:</span>
                            <span class="field-value-compact status-${(intimacao.status || 'pendente').toLowerCase().replace(/\s+/g, '-')}">
                                ${intimacao.status || 'Pendente'}
                            </span>
                        </div>
                    </div>
                    <div class="card-intimacao-row-compact">
                        <div class="card-intimacao-field-compact">
                            <span class="field-label-compact">Prazo:</span>
                            <span class="field-value-compact">${intimacao.prazo || 'N/A'}</span>
                        </div>
                        <div class="card-intimacao-field-compact">
                            <span class="field-label-compact">Intimado:</span>
                            <span class="field-value-compact">${intimacao.intimado || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="card-intimacao-row-compact">
                        <div class="card-intimacao-field-compact">
                            <span class="field-label-compact">Disponibilização:</span>
                            <span class="field-value-compact">${intimacao.disponibilizacao || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    `;
}
</script>

<!-- CSS do Card Compacto -->
<style>
/* Link wrapper para card clicável */
.card-link-wrapper {
    display: block;
    text-decoration: none !important;
    color: inherit !important;
}

.card-link-wrapper:hover {
    text-decoration: none !important;
    color: inherit !important;
}

/* Card compacto dentro da tabela */
.intimacao-card-compact {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
    position: relative;
    transition: all 0.2s ease;
    cursor: pointer;
}

.intimacao-card-compact::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(135deg, #dc3545, #fd7e14);
    transition: width 0.2s ease;
}

.card-link-wrapper:hover .intimacao-card-compact {
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transform: translateY(-2px);
    border-color: #007bff;
}

.card-link-wrapper:hover .intimacao-card-compact::before {
    width: 5px;
    background: linear-gradient(135deg, #007bff, #0056b3);
}

/* Header compacto */
.card-intimacao-header-compact {
    background: #f8f9fa;
    padding: 6px 10px;
    border-bottom: 1px solid #e0e0e0;
}

.card-intimacao-processo-compact {
    display: flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
    color: #495057;
}

.processo-numero-compact {
    flex: 1;
    font-family: 'Courier New', monospace;
    font-size: 12px;
}

.card-intimacao-processo-compact i {
    color: #6c757d;
    font-size: 12px;
}

/* Conteúdo compacto */
.card-intimacao-content-compact {
    padding: 8px 10px;
}

.card-intimacao-row-compact {
    display: flex;
    gap: 12px;
    margin-bottom: 4px;
}

.card-intimacao-row-compact:last-child {
    margin-bottom: 0;
}

.card-intimacao-field-compact {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1px;
}

.field-label-compact {
    font-weight: 600;
    font-size: 10px;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.field-value-compact {
    font-size: 11px;
    color: #212529;
    line-height: 1.2;
    word-break: break-word;
}

/* Status específicos */
.status-pendente {
    color: #fd7e14;
    font-weight: 600;
}

.status-concluido {
    color: #28a745;
    font-weight: 600;
}

.status-urgente {
    color: #dc3545;
    font-weight: 600;
}

/* Responsividade */
@media (max-width: 768px) {
    .card-intimacao-row-compact {
        flex-direction: column;
        gap: 4px;
    }
    
    .card-intimacao-field-compact {
        flex: none;
    }
}

/* Estilo para o card de prompt clicável */
.prompt-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.prompt-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
}

.prompt-card:active {
    transform: translateY(0);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}
</style>

<script>
// Função para truncar texto
function truncarTexto(texto, maxCaracteres) {
    if (!texto) return 'N/A';
    if (texto.length <= maxCaracteres) return texto;
    return texto.substring(0, maxCaracteres) + '...';
}

// Função para navegar para a página do prompt
function navegarParaPrompt(promptId) {
    if (promptId) {
        window.open(`/prompts/${promptId}`, '_blank');
    } else {
        showToast('ID do prompt não disponível', 'warning');
    }
}

// Variáveis globais para filtros
let filtroAtivo = 'todos';
let resultadosAtuais = [];

// Função para filtrar por status (acertos/erros)
function filtrarPorStatus(status) {
    console.log('=== DEBUG: Filtrando por status ===', status);
    
    filtroAtivo = status;
    
    // Verificar se há resultados para filtrar
    const linhas = document.querySelectorAll('.resultado-row');
    if (linhas.length === 0) {
        console.warn('=== DEBUG: Nenhuma linha de resultado encontrada para filtrar ===');
        showToast('Nenhum resultado disponível para filtrar!', 'warning');
        return;
    }
    
        if (status === 'todos') {
        mostrarTodosResultados();
    } else {
        aplicarFiltroResultados(status);
    }
    
    // Adicionar efeito visual nos cartões
    destacarCartaoAtivo(status);
}

// Função para aplicar filtro nos resultados
function aplicarFiltroResultados(status) {
    const linhas = document.querySelectorAll('.resultado-row');
    
    // Verificar se há linhas para filtrar
    if (linhas.length === 0) {
        console.warn('=== DEBUG: Nenhuma linha de resultado encontrada ===');
        return;
    }
    
    let contadorVisiveis = 0;
    
    linhas.forEach(linha => {
        const statusCell = linha.querySelector('.status-cell');
        if (statusCell) {
            // Verificar se acertou baseado no texto e ícone
            const temIconeSucesso = statusCell.querySelector('.text-success') !== null;
            const temIconeErro = statusCell.querySelector('.text-danger') !== null;
            const textoAcertou = statusCell.textContent.includes('Acertou');
            const textoErrou = statusCell.textContent.includes('Errou');
            
            const acertou = temIconeSucesso || textoAcertou;
            const errou = temIconeErro || textoErrou;
            
            console.log('=== DEBUG: Linha status ===', {
                temIconeSucesso,
                temIconeErro,
                textoAcertou,
                textoErrou,
                acertou,
                errou,
                status
            });
            
            if (status === 'acertos' && acertou) {
                linha.classList.remove('filtrado');
                linha.classList.add('visivel');
                contadorVisiveis++;
            } else if (status === 'erros' && errou) {
                linha.classList.remove('filtrado');
                linha.classList.add('visivel');
                contadorVisiveis++;
            } else {
                linha.classList.add('filtrado');
                linha.classList.remove('visivel');
            }
        }
    });
    
    console.log('=== DEBUG: Filtro aplicado ===', {
        status,
        totalLinhas: linhas.length,
        contadorVisiveis
    });
    
    // Atualizar contador de resultados visíveis
    atualizarContadorResultadosVisiveis(contadorVisiveis);
}

// Função para mostrar todos os resultados
function mostrarTodosResultados() {
    const linhas = document.querySelectorAll('.resultado-row');
    
    // Verificar se há linhas para mostrar
    if (linhas.length === 0) {
        console.warn('=== DEBUG: Nenhuma linha de resultado encontrada ===');
        return;
    }
    
    linhas.forEach(linha => {
        linha.classList.remove('filtrado');
        linha.classList.add('visivel');
    });
    
    // Remover contador de resultados visíveis do alerta
    const contadorVisiveis = document.getElementById('contador-resultados-visiveis');
    if (contadorVisiveis) {
        contadorVisiveis.remove();
    }
    
    // Esconder contador do cabeçalho
    const contadorHeader = document.getElementById('contador-resultados-header');
    if (contadorHeader) {
        contadorHeader.style.display = 'none';
    }
}

// Função para limpar filtro
function limparFiltro() {
    filtrarPorStatus('todos');
}

// Função para destacar cartão ativo
function destacarCartaoAtivo(status) {
    // Remover destaque de todos os cartões
    const cartoes = document.querySelectorAll('.stat-card');
    cartoes.forEach(cartao => {
        cartao.style.borderColor = 'transparent';
        cartao.style.backgroundColor = 'transparent';
    });
    
    // Destacar cartão ativo
    if (status !== 'todos') {
        const cartaoAtivo = document.querySelector(`.stat-card[onclick*="${status}"]`);
        if (cartaoAtivo) {
            cartaoAtivo.style.borderColor = 'rgba(0, 123, 255, 0.5)';
            cartaoAtivo.style.backgroundColor = 'rgba(0, 123, 255, 0.05)';
        }
    }
}

// Função para atualizar contador de resultados visíveis
function atualizarContadorResultadosVisiveis(contador) {
    const totalLinhas = document.querySelectorAll('.resultado-row').length;
    
    // Atualizar contador no cabeçalho
    const contadorHeader = document.getElementById('contador-resultados-header');
    const contadorTextoHeader = document.getElementById('contador-texto-header');
    
    if (contadorHeader && contadorTextoHeader) {
        if (contador === totalLinhas) {
            // Se mostrando todos, esconder o badge
            contadorHeader.style.display = 'none';
        } else {
            // Se filtrado, mostrar o badge
            contadorHeader.style.display = 'inline-block';
            contadorTextoHeader.textContent = `${contador} de ${totalLinhas}`;
        }
    }
    
    // Remover contador anterior do alerta se existir (não vamos mais criar)
    const contadorAnterior = document.getElementById('contador-resultados-visiveis');
    if (contadorAnterior) {
        contadorAnterior.remove();
    }
}

// Função para armazenar resultados atuais (chamada quando resultados são carregados)
function armazenarResultadosAtuais(resultados) {
    resultadosAtuais = resultados;
    console.log('=== DEBUG: Resultados armazenados ===', resultados.length);
}

// Função para atualizar botão de regras de negócio
function atualizarBotaoRegrasNegocio() {
    const selectPrompt = document.getElementById('prompt-selecionado');
    const btnRegrasNegocio = document.getElementById('btn-regras-negocio');
    
    if (selectPrompt.value) {
        btnRegrasNegocio.disabled = false;
        btnRegrasNegocio.classList.remove('btn-outline-secondary');
        btnRegrasNegocio.classList.add('btn-outline-info');
    } else {
        btnRegrasNegocio.disabled = true;
        btnRegrasNegocio.classList.remove('btn-outline-info');
        btnRegrasNegocio.classList.add('btn-outline-secondary');
    }
}

// Função para visualizar regras de negócio
function visualizarRegrasNegocio() {
    const selectPrompt = document.getElementById('prompt-selecionado');
    const promptId = selectPrompt.value;
    
    if (!promptId) {
        showToast('Selecione um prompt primeiro!', 'warning');
        return;
    }
    
    // Buscar dados do prompt selecionado
    const promptSelecionado = prompts.find(p => p.id === promptId);
    if (!promptSelecionado) {
        showToast('Prompt não encontrado!', 'error');
        return;
    }
    
    // Preencher modal com as regras de negócio
    const modalRegrasNegocio = new bootstrap.Modal(document.getElementById('modalRegrasNegocio'));
    const modalTitle = document.getElementById('modalRegrasNegocioLabel');
    const modalBody = document.getElementById('modalRegrasNegocioBody');
    
    modalTitle.textContent = `Regras de Negócio - ${promptSelecionado.nome}`;
    
    // Verificar se tem regras de negócio
    if (promptSelecionado.regra_negocio && promptSelecionado.regra_negocio.trim()) {
        modalBody.innerHTML = `
            <div class="mb-3">
                <h6 class="text-primary">Descrição das Regras:</h6>
                <div class="border rounded p-3 bg-light">
                    ${promptSelecionado.regra_negocio.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;
    } else {
        modalBody.innerHTML = `
            <div class="alert alert-warning" role="alert">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Este prompt não possui regras de negócio definidas.</strong>
                <br><br>
                <p class="mb-2">Para adicionar regras de negócio, edite o prompt na página de prompts.</p>
            </div>
        `;
    }
    
    modalRegrasNegocio.show();
}

// Função para editar prompt a partir do modal
function editarPrompt() {
    const selectPrompt = document.getElementById('prompt-selecionado');
    const promptId = selectPrompt.value;
    
    if (!promptId) {
        showToast('Selecione um prompt primeiro!', 'warning');
        return;
    }
    
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalRegrasNegocio'));
    modal.hide();
    
    // Redirecionar para edição do prompt
    window.location.href = `/prompts/${promptId}/editar`;
}
</script>

<!-- Modal para Regras de Negócio -->
<div class="modal fade" id="modalRegrasNegocio" tabindex="-1" aria-labelledby="modalRegrasNegocioLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalRegrasNegocioLabel">
                    <i class="bi bi-file-earmark-text"></i>
                    Regras de Negócio
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalRegrasNegocioBody">
                <!-- Conteúdo será preenchido via JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i>
                    Fechar
                </button>
                <button type="button" class="btn btn-primary" onclick="editarPrompt()">
                    <i class="bi bi-pencil-square"></i>
                    Editar Prompt
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Marked.js para renderização de Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    // Verificar se Marked.js foi carregado
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof marked !== 'undefined') {
            console.log('✅ Marked.js carregado com sucesso!');
        } else {
            console.error('❌ Marked.js não foi carregado!');
        }
    });
    
    // Função para atualizar estado do botão de comparação - SIMPLIFICADA
    // ACRESCENTADO: Botão sempre naturalmente enabled, validação no backend
    function updateCompareButton() {
        const checkedCheckboxes = document.querySelectorAll('.prompt-checkbox:checked');
        const compareButton = document.getElementById('btn-compare-prompts');
        
        if (compareButton && checkedCheckboxes.length > 0) {
            // ACRESCENTADO: Apenas atualizar texto com contagem selected, delegar validation to backend
            compareButton.textContent = checkedCheckboxes.length >= 2 
                ? `Comparar ${checkedCheckboxes.length} Prompts Selecionados`
                : 'Comparar Prompts Selecionados';
        }
        
        console.log('🔧 DEBUG: Botão mantido habilitado, validação movida para backend. Selected:', checkedCheckboxes.length);
    }
    
    // Função para comparar prompts selecionados
    // ACRESCENTADO: Validação no frontend mantém functionality, validação real no backend
    function compareSelectedPrompts() {
        const checkboxes = document.querySelectorAll('.prompt-checkbox:checked');
        
        // ACRESCENTADO: Botão sempre habilitado, deixar backend fazer toda substituição validation
        if (checkboxes.length < 2) {
            showToast('Selecione pelo menos 2 prompts para comparar', 'warning');
            return; // Keep user-friendly warning and allow backend to validate
        }
        
        // Coletar IDs dos prompts selecionados
        const promptIds = Array.from(checkboxes).map(checkbox => checkbox.dataset.promptId);
        const promptNomes = Array.from(checkboxes).map(checkbox => checkbox.dataset.promptNome);
        
        // Obter ID da intimação da variável global ou do popover ativo
        let intimacaoId = window.currentIntimacaoId;
        
        // Se não tiver na variável global, tentar capturar do popover ativo
        if (!intimacaoId) {
            const popovers = document.querySelectorAll('.custom-popover');
            for (let popover of popovers) {
                if (popover.style.display === 'block' || popover.style.display !== 'none') {
                    const intimacaoIdMatch = popover.id.match(/popover-(\d+)/);
                    if (intimacaoIdMatch) {
                        intimacaoId = intimacaoIdMatch[1];
                        break;
                    }
                }
            }
        }
        
        // Se ainda não tiver, tentar capturar da URL atual ou do contexto da página
        if (!intimacaoId) {
            // Tentar capturar da URL atual se estivermos na página de análise
            const urlParams = new URLSearchParams(window.location.search);
            intimacaoId = urlParams.get('intimacao_id');
            
            // Se não tiver na URL, tentar capturar do primeiro popover visível
            if (!intimacaoId) {
                const firstPopover = document.querySelector('.custom-popover');
                if (firstPopover) {
                    const intimacaoIdMatch = firstPopover.id.match(/popover-(\d+)/);
                    if (intimacaoIdMatch) {
                        intimacaoId = intimacaoIdMatch[1];
                    }
                }
            }
        }
        
        console.log('🔍 Intimação ID capturado:', intimacaoId);
        console.log('🔍 Window object:', window);
        console.log('🔍 CurrentIntimacaoId type:', typeof window.currentIntimacaoId);
        console.log('🔍 CurrentIntimacaoId value:', window.currentIntimacaoId);
        console.log('🔍 Popovers encontrados:', document.querySelectorAll('.custom-popover').length);
        console.log('🔍 URL atual:', window.location.href);
        console.log('🔍 Parâmetros da URL:', new URLSearchParams(window.location.search).toString());
        
        // Criar URL com parâmetros
        const params = new URLSearchParams();
        promptIds.forEach(id => params.append('prompt_ids', id));
        if (intimacaoId) {
            params.append('intimacao_id', intimacaoId);
        }
        
        // Log da URL final
        const finalUrl = `/comparar-prompts?${params.toString()}`;
        console.log('🚀 URL final:', finalUrl);
        
        // Redirecionar para página de comparação
        window.open(finalUrl, '_blank');
    }
</script>

<style>
.custom-popover {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1060;
    max-width: 400px;
    min-width: 300px;
    margin-top: 10px;
}

.popover-content {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.popover-content::before {
    content: '';
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-bottom: 8px solid #dee2e6;
}

.popover-content::after {
    content: '';
    position: absolute;
    top: -7px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 7px solid transparent;
    border-right: 7px solid transparent;
    border-bottom: 7px solid white;
}

.popover-body {
    padding: 1rem;
    max-height: 400px;
    overflow-y: auto;
}

.prompt-card {
    transition: all 0.2s ease;
}

.prompt-card:hover {
    background-color: #f8f9fa;
    border-color: #007bff;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 123, 255, 0.1);
}

.prompt-name {
    text-decoration: none;
}

.prompt-card:hover .prompt-name {
    text-decoration: underline;
}
</style>


<script>
</script>

{% endblock %}