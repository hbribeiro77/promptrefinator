{% extends "base.html" %}

{% block title %}Prompt: {{ prompt.nome }} - Sistema Analisador de Prompts{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-code-square"></i>
        {{ prompt.nome }}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('listar_prompts') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i>
                Voltar para Lista
            </a>
            <a href="{{ url_for('analise') }}?prompt_ids={{ prompt.id }}" class="btn btn-sm btn-primary">
                <i class="bi bi-play-circle"></i>
                Testar Prompt
            </a>
        </div>
        <div class="btn-group">
            <a href="{{ url_for('copiar_prompt', id=prompt.id) }}" class="btn btn-sm btn-outline-info">
                <i class="bi bi-files"></i>
                Copiar
            </a>
            <a href="{{ url_for('editar_prompt', id=prompt.id) }}" class="btn btn-sm btn-outline-warning">
                <i class="bi bi-pencil-square"></i>
                Editar
            </a>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="confirmarExclusao()">
                <i class="bi bi-trash"></i>
                Excluir
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Dados do Prompt -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i>
                    Informa√ß√µes do Prompt
                </h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>ID:</strong>
                    </div>
                    <div class="col-sm-9">
                        <code>{{ prompt.id }}</code>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>Nome:</strong>
                    </div>
                    <div class="col-sm-9">
                        {{ prompt.nome }}
                    </div>
                </div>
                
                {% if prompt.descricao %}
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>Descri√ß√£o:</strong>
                    </div>
                    <div class="col-sm-9">
                        {{ prompt.descricao }}
                    </div>
                </div>
                {% endif %}
                
                
                <div class="row mb-3">
                    <div class="col-sm-3">
                        <strong>Data de Cria√ß√£o:</strong>
                    </div>
                    <div class="col-sm-9">
                        <span class="text-muted">
                            {% if prompt.data_criacao %}
                                {% set data = prompt.data_criacao.split('T')[0] if 'T' in prompt.data_criacao else prompt.data_criacao %}
                                {% set hora = prompt.data_criacao.split('T')[1][:8] if 'T' in prompt.data_criacao else '' %}
                                {{ data.split('-')[2] }}/{{ data.split('-')[1] }}/{{ data.split('-')[0] }}{% if hora %} {{ hora }}{% endif %}
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Regra de Neg√≥cio -->
        {% if prompt.regra_negocio %}
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear"></i>
                    Regra de Neg√≥cio
                </h5>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copiarTexto('regra-negocio')">
                        <i class="bi bi-clipboard"></i>
                        Copiar
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleWrap('regra-negocio')">
                        <i class="bi bi-text-wrap"></i>
                        Quebra de Linha
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="position-relative">
                    <pre id="regra-negocio" class="bg-light p-3 rounded" style="white-space: pre-wrap; max-height: 500px; overflow-y: auto;">{{ prompt.regra_negocio }}</pre>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        Caracteres: <span id="regra-char-count">{{ prompt.regra_negocio | length }}</span> | 
                        Palavras: <span id="regra-word-count">{{ prompt.regra_negocio.split() | length }}</span> | 
                        Linhas: <span id="regra-line-count">{{ prompt.regra_negocio.split('\n') | length }}</span>
                    </small>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Conte√∫do do Prompt -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-file-code"></i>
                    Conte√∫do do Prompt
                </h5>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="copiarTexto('conteudo-prompt')">
                        <i class="bi bi-clipboard"></i>
                        Copiar
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleWrap('conteudo-prompt')">
                        <i class="bi bi-text-wrap"></i>
                        Quebra de Linha
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="previewPrompt()">
                        <i class="bi bi-eye"></i>
                        Pr√©-visualizar
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="position-relative">
                    <pre id="conteudo-prompt" class="bg-light p-3 rounded" style="white-space: pre-wrap; max-height: 500px; overflow-y: auto;">{{ prompt.conteudo }}</pre>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        Caracteres: <span id="char-count">{{ prompt.conteudo | length }}</span> | 
                        Palavras: <span id="word-count">{{ prompt.conteudo.split() | length }}</span> | 
                        Linhas: <span id="line-count">{{ prompt.conteudo.split('\n') | length }}</span> |
                        Tokens estimados: <span id="token-count">{{ (prompt.conteudo | length / 4) | round | int }}</span>
                    </small>
                </div>
                
                <!-- Verifica√ß√£o de vari√°veis -->
                <div class="mt-3">
                    {% if '{CONTEXTO}' in prompt.conteudo %}
                        <span class="badge bg-success me-2">
                            <i class="bi bi-check-circle"></i>
                            Vari√°vel {CONTEXTO} encontrada
                        </span>
                    {% else %}
                        <span class="badge bg-warning me-2">
                            <i class="bi bi-exclamation-triangle"></i>
                            Vari√°vel {CONTEXTO} n√£o encontrada
                        </span>
                    {% endif %}
                    
                    {% if '{REGRADENEGOCIO}' in prompt.conteudo %}
                        <span class="badge bg-success me-2">
                            <i class="bi bi-gear"></i>
                            Vari√°vel {REGRADENEGOCIO} encontrada
                        </span>
                    {% else %}
                        <span class="badge bg-info me-2">
                            <i class="bi bi-gear"></i>
                            Vari√°vel {REGRADENEGOCIO} n√£o encontrada
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Hist√≥rico nas Intima√ß√µes -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-ul"></i>
                    Hist√≥rico nas Intima√ß√µes
                </h5>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limparFiltrosHistorico()">
                        <i class="bi bi-x-circle"></i>
                        Limpar
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="filtrarPorClassificacaoHistorico()">
                        <i class="bi bi-funnel"></i>
                        Filtrar
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="configurarColunasIntimacoesHistorico()">
                        <i class="bi bi-gear"></i>
                        Colunas
                    </button>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="verInformacoesAdicionaisIntimacoesSelecionadas()">
                        <i class="bi bi-info-circle"></i>
                        Ver Informa√ß√µes Adicionais
                    </button>
                </div>
                
                <script>
                // Fun√ß√£o para ver informa√ß√µes adicionais das intima√ß√µes selecionadas
                function verInformacoesAdicionaisIntimacoesSelecionadas() {
                    const selecionados = getIntimacoesSelecionadasHistorico();
                    if (selecionados.length === 0) {
                        showToast('Selecione pelo menos uma intima√ß√£o!', 'warning');
                        return;
                    }
                    
                    // Buscar informa√ß√µes das intima√ß√µes selecionadas
                    fetch('/api/intimacoes/informacoes-adicionais', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            intimacoes_ids: selecionados
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            mostrarModalInformacoesAdicionais(
                                'Informa√ß√µes Adicionais das Intima√ß√µes Selecionadas',
                                data.intimacoes,
                                'intima√ß√£o'
                            );
                        } else {
                            showToast(`Erro: ${data.message}`, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao buscar informa√ß√µes:', error);
                        showToast('Erro ao buscar informa√ß√µes das intima√ß√µes!', 'error');
                    });
                }

                // Fun√ß√£o para obter intima√ß√µes selecionadas no hist√≥rico
                function getIntimacoesSelecionadasHistorico() {
                    const checkboxes = document.querySelectorAll('.intimacao-checkbox-historico:checked');
                    return Array.from(checkboxes).map(checkbox => checkbox.value);
                }
                </script>
            </div>
            <div class="card-body">
                {% if intimacoes_historico %}
                    <div class="table-responsive">
                        <table class="table table-hover intimacoes-cards-table">
                            <thead class="table-light">
                                <tr>
                                    <th class="col-checkbox-compact" style="width: 2%;">
                                        <input type="checkbox" id="select-all-intimacoes-historico" onchange="toggleSelectAllIntimacoesHistorico()">
                                    </th>
                                    <th class="col-checkbox" style="width: 15%;">Card da Intima√ß√£o</th>
                                    <th class="col-defensor" style="width: 12%;">Defensor</th>
                                    <th class="col-classe" style="width: 12%;">Classe</th>
                                    <th class="col-classificacao-manual" style="width: 20%;">Classifica√ß√£o Manual</th>
                                    <th class="col-informacao-adicional" style="width: 15%;">Informa√ß√µes Adicionais</th>
                                    <th class="col-analises" style="width: 7%;">An√°lises</th>
                                    <th class="col-acertos" style="width: 7%;">Acertos</th>
                                    <th class="col-taxa-acerto" style="width: 7%; cursor: pointer;" onclick="ordenarPorTaxaAcerto()">
                                        <span style="display: flex; align-items: center; white-space: nowrap;">
                                            Taxa de Acerto 
                                            <i class="bi bi-arrow-down-up" id="icon-taxa-acerto" style="margin-left: 4px; font-size: 12px;"></i>
                                        </span>
                                    </th>
                                    <th class="col-acoes" style="width: 10%;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for intimacao in intimacoes_historico %}
                                <tr class="intimacao-row" data-intimacao-id="{{ intimacao.id }}" data-defensor="{{ intimacao.defensor or '' }}" data-classe="{{ intimacao.classe or '' }}">
                                    <td class="col-checkbox-compact">
                                        <input type="checkbox" class="intimacao-checkbox-historico" value="{{ intimacao.id }}">
                                    </td>
                                    <td class="col-checkbox card-cell">
                                        {% include 'partials/card_intimacao_compact.html' %}
                                    </td>
                                    <td class="col-defensor">
                                        {% if intimacao.defensor %}
                                        <span class="badge bg-info" title="{{ intimacao.defensor }}">
                                            {{ intimacao.defensor[:20] }}{% if intimacao.defensor|length > 20 %}...{% endif %}
                                        </span>
                                            {% else %}
                                        <span class="text-muted">-</span>
                                            {% endif %}
                                    </td>
                                    <td class="col-classe">
                                        {% if intimacao.classe %}
                                        <span class="badge bg-secondary" title="{{ intimacao.classe }}">
                                            {{ intimacao.classe[:20] }}{% if intimacao.classe|length > 20 %}...{% endif %}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="col-classificacao-manual">
                                        {% if intimacao.classificacao_manual %}
                                            {% set badge_class = {
                                                'URG√äNCIA': 'danger',
                                                'ELABORAR PE√áA': 'success',
                                                'ANALISAR PROCESSO': 'info',
                                                'CONTATAR ASSISTIDO': 'warning',
                                                'RENUNCIAR PRAZO': 'secondary',
                                                'OCULTAR': 'dark',
                                                'ENCAMINHAR INTIMA√á√ÉO PARA OUTRO DEFENSOR': 'primary'
                                            } %}
                                            <span class="badge bg-{{ badge_class.get(intimacao.classificacao_manual, 'secondary') }}">
                                                {{ intimacao.classificacao_manual }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="col-informacao-adicional">
                                        {% if intimacao.informacao_adicional %}
                                        <div class="text-truncate" title="{{ intimacao.informacao_adicional }}">
                                            {{ intimacao.informacao_adicional[:100] }}{% if intimacao.informacao_adicional|length > 100 %}...{% endif %}
                                        </div>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="col-analises">
                                        <span class="badge bg-info" id="analises-{{ intimacao.id }}">-</span>
                                    </td>
                                    <td class="col-acertos">
                                        <span class="badge bg-success" id="acertos-{{ intimacao.id }}">-</span>
                                    </td>
                                    <td class="col-taxa-acerto">
                                        <span class="badge bg-secondary" id="taxa-acerto-{{ intimacao.id }}">-</span>
                                    </td>
                                    <td class="col-acoes">
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('visualizar_intimacao', id=intimacao.id) }}" class="btn btn-outline-primary" title="Ver detalhes">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-danger" onclick="confirmarExclusaoIntimacao('{{ intimacao.id }}')" title="Excluir">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- JavaScript para funcionalidades do hist√≥rico -->
                    <script>
                    function toggleSelectAllIntimacoesHistorico() {
                        const selectAll = document.getElementById('select-all-intimacoes-historico');
                        const checkboxes = document.querySelectorAll('.intimacao-checkbox-historico');
                        
                        checkboxes.forEach(checkbox => {
                            // Verificar se a linha est√° vis√≠vel (n√£o filtrada)
                            const row = checkbox.closest('.intimacao-row');
                            if (row && row.style.display !== 'none') {
                                checkbox.checked = selectAll.checked;
                            }
                        });
                        
                        // Atualizar estado do checkbox "Selecionar Todas"
                        updateSelectAllStateHistorico();
                    }
                    
                    function updateSelectAllStateHistorico() {
                        const selectAll = document.getElementById('select-all-intimacoes-historico');
                        const visibleCheckboxes = document.querySelectorAll('.intimacao-checkbox-historico');
                        const visibleChecked = Array.from(visibleCheckboxes).filter(checkbox => {
                            const row = checkbox.closest('.intimacao-row');
                            return row && row.style.display !== 'none' && checkbox.checked;
                        });
                        const visibleTotal = Array.from(visibleCheckboxes).filter(checkbox => {
                            const row = checkbox.closest('.intimacao-row');
                            return row && row.style.display !== 'none';
                        });
                        
                        if (visibleTotal.length === 0) {
                            selectAll.checked = false;
                            selectAll.indeterminate = false;
                        } else if (visibleChecked.length === visibleTotal.length) {
                            selectAll.checked = true;
                            selectAll.indeterminate = false;
                        } else if (visibleChecked.length > 0) {
                            selectAll.checked = false;
                            selectAll.indeterminate = true;
                        } else {
                            selectAll.checked = false;
                            selectAll.indeterminate = false;
                        }
                    }
                    
                    // Carregar an√°lises e acertos das intima√ß√µes
                    function carregarAnalisesAcertos() {
                        console.log('üîÑ Carregando an√°lises e acertos...');
                        const promptId = '{{ prompt.id }}';
                        fetch(`/api/prompts/${promptId}/analises-acertos`)
                            .then(response => {
                                console.log('üì° Resposta da API:', response.status);
                                return response.json();
                            })
                            .then(data => {
                                console.log('üìä Dados recebidos:', data);
                                if (data.success) {
                                    console.log('‚úÖ An√°lises e acertos carregados:', data.analises_acertos);
                                    atualizarAnalisesAcertos(data.analises_acertos);
                                } else {
                                    console.error('‚ùå Erro ao carregar an√°lises e acertos:', data.message);
                                }
                            })
                            .catch(error => {
                                console.error('‚ùå Erro na requisi√ß√£o de an√°lises e acertos:', error);
                            });
                    }
                    
                    // Atualizar an√°lises e acertos na interface
                    function atualizarAnalisesAcertos(analisesAcertos) {
                        console.log('üéØ Atualizando an√°lises e acertos na interface:', analisesAcertos);
                        
                        // Salvar dados para ordena√ß√£o
                        dadosOrdenacao = analisesAcertos;
                        
                        Object.keys(analisesAcertos).forEach(intimacaoId => {
                            const elementoAnalises = document.getElementById(`analises-${intimacaoId}`);
                            const elementoAcertos = document.getElementById(`acertos-${intimacaoId}`);
                            
                            const elementoTaxaAcerto = document.getElementById(`taxa-acerto-${intimacaoId}`);
                            
                            if (elementoAnalises && elementoAcertos && elementoTaxaAcerto) {
                                const dados = analisesAcertos[intimacaoId];
                                const total = dados.total_analises;
                                const acertos = dados.acertos;
                                const taxa = dados.taxa_acerto;
                                
                                // Atualizar coluna de an√°lises
                                elementoAnalises.textContent = total;
                                elementoAnalises.title = `Total de an√°lises: ${total}`;
                                
                                // Atualizar coluna de acertos
                                elementoAcertos.textContent = acertos;
                                elementoAcertos.title = `Acertos: ${acertos}`;
                                
                                // Atualizar coluna de taxa de acerto com cor baseada na taxa
                                let badgeClass = 'bg-secondary';
                                if (taxa >= 80) {
                                    badgeClass = 'bg-success';
                                } else if (taxa >= 60) {
                                    badgeClass = 'bg-warning';
                                } else if (taxa > 0) {
                                    badgeClass = 'bg-danger';
                                }
                                
                                elementoTaxaAcerto.className = `badge ${badgeClass}`;
                                elementoTaxaAcerto.innerHTML = `${taxa}%<br><small>${acertos}/${total}</small>`;
                                elementoTaxaAcerto.title = `${acertos} acertos de ${total} an√°lises (${taxa}%)`;
                                
                                console.log(`‚úÖ An√°lises, acertos e taxa atualizados para intima√ß√£o ${intimacaoId}: ${acertos}/${total} (${taxa}%)`);
                            } else {
                                console.warn(`‚ö†Ô∏è Elementos n√£o encontrados para intima√ß√£o ${intimacaoId}`);
                            }
                        });
                    }
                    
                    // Vari√°veis para controle de ordena√ß√£o
                    let ordenacaoTaxaAcerto = 'desc'; // 'asc' ou 'desc'
                    let dadosOrdenacao = [];
                    
                    // Fun√ß√£o para ordenar por taxa de acerto
                    function ordenarPorTaxaAcerto() {
                        console.log('üîÑ Ordenando por taxa de acerto...');
                        
                        // Alternar dire√ß√£o da ordena√ß√£o
                        ordenacaoTaxaAcerto = ordenacaoTaxaAcerto === 'desc' ? 'asc' : 'desc';
                        
                        // Atualizar √≠cone
                        const icon = document.getElementById('icon-taxa-acerto');
                        if (ordenacaoTaxaAcerto === 'desc') {
                            icon.className = 'bi bi-arrow-down';
                        } else {
                            icon.className = 'bi bi-arrow-up';
                        }
                        
                        // Se ainda n√£o temos dados, carregar primeiro
                        if (dadosOrdenacao.length === 0) {
                            carregarDadosParaOrdenacao();
                            return;
                        }
                        
                        // Ordenar os dados
                        ordenarTabelaPorTaxaAcerto();
                    }
                    
                    // Fun√ß√£o para carregar dados para ordena√ß√£o
                    function carregarDadosParaOrdenacao() {
                        console.log('üìä Carregando dados para ordena√ß√£o...');
                        const promptId = '{{ prompt.id }}';
                        fetch(`/api/prompts/${promptId}/analises-acertos`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    dadosOrdenacao = data.analises_acertos;
                                    ordenarTabelaPorTaxaAcerto();
                                }
                            })
                            .catch(error => {
                                console.error('‚ùå Erro ao carregar dados para ordena√ß√£o:', error);
                            });
                    }
                    
                    // Fun√ß√£o para ordenar a tabela
                    function ordenarTabelaPorTaxaAcerto() {
                        console.log('üîç Iniciando ordena√ß√£o da tabela...');
                        
                        const tbody = document.querySelector('.intimacoes-cards-table tbody');
                        if (!tbody) {
                            console.error('‚ùå tbody n√£o encontrado');
                            return;
                        }
                        
                        const rows = Array.from(tbody.querySelectorAll('tr.intimacao-row'));
                        console.log(`üìä Encontradas ${rows.length} linhas para ordenar`);
                        
                        if (rows.length === 0) {
                            console.warn('‚ö†Ô∏è Nenhuma linha encontrada para ordenar');
                            return;
                        }
                        
                        console.log('üìà Dados de ordena√ß√£o:', dadosOrdenacao);
                        
                        // Ordenar linhas baseado na taxa de acerto
                        rows.sort((a, b) => {
                            const intimacaoIdA = a.getAttribute('data-intimacao-id');
                            const intimacaoIdB = b.getAttribute('data-intimacao-id');
                            
                            const dadosA = dadosOrdenacao[intimacaoIdA];
                            const dadosB = dadosOrdenacao[intimacaoIdB];
                            
                            const taxaA = dadosA ? dadosA.taxa_acerto : 0;
                            const taxaB = dadosB ? dadosB.taxa_acerto : 0;
                            
                            console.log(`üîÑ Comparando: ${intimacaoIdA} (${taxaA}%) vs ${intimacaoIdB} (${taxaB}%)`);
                            
                            if (ordenacaoTaxaAcerto === 'asc') {
                                return taxaA - taxaB;
                            } else {
                                return taxaB - taxaA;
                            }
                        });
                        
                        // Reordenar as linhas na tabela
                        rows.forEach(row => tbody.appendChild(row));
                        
                        console.log(`‚úÖ Tabela ordenada por taxa de acerto (${ordenacaoTaxaAcerto})`);
                    }
                    
                    // Carregar an√°lises e acertos quando a p√°gina carregar
                    document.addEventListener('DOMContentLoaded', function() {
                        carregarAnalisesAcertos();
                        carregarConfigColunasHistorico();
                    });
                    
                    // Fun√ß√µes para os bot√µes de controle da tabela
                    function limparFiltrosHistorico() {
                        // Resetar todos os filtros
                        document.getElementById('filtro-todos-defensores-historico').checked = true;
                        document.getElementById('filtro-todas-classificacoes-historico').checked = true;
                        document.getElementById('filtro-todas-classes-historico').checked = true;
                        document.getElementById('taxa-minima-historico').value = '';
                        document.getElementById('taxa-maxima-historico').value = '';
                        
                        // Mostrar todas as linhas
                        document.querySelectorAll('.intimacao-row').forEach(row => {
                            row.style.display = '';
                        });
                        
                        // Atualizar estado do checkbox "Selecionar Todas"
                        updateSelectAllStateHistorico();
                        
                        showToast('Filtros limpos!', 'info');
                    }
                    
                    function filtrarPorClassificacaoHistorico() {
                        // Carregar filtros din√¢micos
                        carregarFiltrosHistorico();
                        // Mostrar modal
                        const modal = new bootstrap.Modal(document.getElementById('modalFiltroHistorico'));
                        modal.show();
                    }
                    
                    function configurarColunasIntimacoesHistorico() {
                        // Carregar configura√ß√£o salva
                        carregarConfigColunasHistorico();
                        // Mostrar modal
                        const modal = new bootstrap.Modal(document.getElementById('modalConfigColunasHistorico'));
                        modal.show();
                    }
                    
                    function carregarFiltrosHistorico() {
                        fetch('/api/filtros/analise')
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    carregarDefensoresHistorico(data.defensores);
                                    carregarClassificacoesHistorico(data.classificacoes);
                                    carregarClassesHistorico(data.classes);
                                }
                            })
                            .catch(error => {
                                console.error('Erro ao carregar filtros:', error);
                            });
                    }
                    
                    function carregarDefensoresHistorico(defensores) {
                        const container = document.getElementById('filtros-defensores-historico');
                        container.innerHTML = '';
                        
                        defensores.forEach(defensor => {
                            const div = document.createElement('div');
                            div.className = 'form-check';
                            div.innerHTML = `
                                <input class="form-check-input" type="checkbox" id="defensor-${defensor.replace(/\s+/g, '-')}-historico" checked>
                                <label class="form-check-label" for="defensor-${defensor.replace(/\s+/g, '-')}-historico">
                                    ${defensor}
                                </label>
                            `;
                            container.appendChild(div);
                        });
                    }
                    
                    function carregarClassificacoesHistorico(classificacoes) {
                        const container = document.getElementById('filtros-classificacoes-historico');
                        container.innerHTML = '';
                        
                        classificacoes.forEach(classificacao => {
                            const div = document.createElement('div');
                            div.className = 'form-check';
                            div.innerHTML = `
                                <input class="form-check-input" type="checkbox" id="classificacao-${classificacao.replace(/\s+/g, '-')}-historico" checked>
                                <label class="form-check-label" for="classificacao-${classificacao.replace(/\s+/g, '-')}-historico">
                                    ${classificacao}
                                </label>
                            `;
                            container.appendChild(div);
                        });
                    }
                    
                    function carregarClassesHistorico(classes) {
                        const container = document.getElementById('filtros-classes-historico');
                        container.innerHTML = '';
                        
                        classes.forEach(classe => {
                            const div = document.createElement('div');
                            div.className = 'form-check';
                            div.innerHTML = `
                                <input class="form-check-input" type="checkbox" id="classe-${classe.replace(/\s+/g, '-')}-historico" checked>
                                <label class="form-check-label" for="classe-${classe.replace(/\s+/g, '-')}-historico">
                                    ${classe}
                                </label>
                            `;
                            container.appendChild(div);
                        });
                    }
                    
                    // Fun√ß√£o para escapar caracteres especiais em seletores CSS
                    function escapeCssSelector(str) {
                        return str.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, '\\$&');
                    }
                    
                    function aplicarFiltroHistorico() {
                        const rows = document.querySelectorAll('.intimacao-row');
                        
                        rows.forEach(row => {
                            let show = true;
                            
                            // Filtro por defensor
                            const defensor = row.dataset.defensor || '';
                            if (defensor) {
                                const defensorEscaped = escapeCssSelector(defensor.replace(/\s+/g, '-'));
                                const defensorCheckbox = document.querySelector(`#defensor-${defensorEscaped}-historico`);
                                if (defensorCheckbox && !defensorCheckbox.checked) {
                                    show = false;
                                }
                            }
                            
                            // Filtro por classe
                            const classe = row.dataset.classe || '';
                            if (classe) {
                                const classeEscaped = escapeCssSelector(classe.replace(/\s+/g, '-'));
                                const classeCheckbox = document.querySelector(`#classe-${classeEscaped}-historico`);
                                if (classeCheckbox && !classeCheckbox.checked) {
                                    show = false;
                                }
                            }
                            
                            // Filtro por taxa de acerto
                            const taxaMinima = document.getElementById('taxa-minima-historico').value;
                            const taxaMaxima = document.getElementById('taxa-maxima-historico').value;
                            if (taxaMinima || taxaMaxima) {
                                const taxaElement = row.querySelector('.col-resultado-ia .badge');
                                if (taxaElement) {
                                    const taxaText = taxaElement.textContent;
                                    const taxa = parseFloat(taxaText.split('%')[0]);
                                    
                                    if (taxaMinima && taxa < parseFloat(taxaMinima)) {
                                        show = false;
                                    }
                                    if (taxaMaxima && taxa > parseFloat(taxaMaxima)) {
                                        show = false;
                                    }
                                }
                            }
                            
                            row.style.display = show ? '' : 'none';
                        });
                        
                        // Atualizar estado do checkbox "Selecionar Todas"
                        updateSelectAllStateHistorico();
                        
                        // Fechar modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalFiltroHistorico'));
                        modal.hide();
                        
                        showToast('Filtros aplicados!', 'success');
                    }
                    
                    function limparFiltroTaxaHistorico() {
                        document.getElementById('taxa-minima-historico').value = '';
                        document.getElementById('taxa-maxima-historico').value = '';
                    }
                    
                    function carregarConfigColunasHistorico() {
                        const config = localStorage.getItem('configColunasHistorico');
                        if (config) {
                            const colunas = JSON.parse(config);
                            Object.keys(colunas).forEach(coluna => {
                                const checkbox = document.getElementById(coluna);
                                if (checkbox) {
                                    checkbox.checked = colunas[coluna];
                                }
                            });
                            
                            // Aplicar configura√ß√£o automaticamente
                            aplicarConfigColunasHistoricoSemFecharModal();
                        }
                    }
                    
                    function aplicarConfigColunasHistorico() {
                        const colunas = {
                            'col-checkbox-compact-historico': document.getElementById('col-checkbox-compact-historico').checked,
                            'col-checkbox-historico': document.getElementById('col-checkbox-historico').checked,
                            'col-defensor-historico': document.getElementById('col-defensor-historico').checked,
                            'col-classe-historico': document.getElementById('col-classe-historico').checked,
                            'col-classificacao-manual-historico': document.getElementById('col-classificacao-manual-historico').checked,
                            'col-informacao-adicional-historico': document.getElementById('col-informacao-adicional-historico').checked,
                            'col-analises-historico': document.getElementById('col-analises-historico').checked,
                            'col-acertos-historico': document.getElementById('col-acertos-historico').checked,
                            'col-taxa-acerto-historico': document.getElementById('col-taxa-acerto-historico').checked,
                            'col-acoes-historico': document.getElementById('col-acoes-historico').checked
                        };
                        
                        // Salvar configura√ß√£o
                        localStorage.setItem('configColunasHistorico', JSON.stringify(colunas));
                        
                        // Aplicar configura√ß√£o
                        aplicarConfigColunasHistoricoSemFecharModal();
                        
                        // Fechar modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfigColunasHistorico'));
                        modal.hide();
                        
                        showToast('Configura√ß√£o de colunas aplicada!', 'success');
                    }
                    
                    function aplicarConfigColunasHistoricoSemFecharModal() {
                        const colunas = {
                            'col-checkbox-compact-historico': document.getElementById('col-checkbox-compact-historico')?.checked ?? true,
                            'col-checkbox-historico': document.getElementById('col-checkbox-historico')?.checked ?? true,
                            'col-defensor-historico': document.getElementById('col-defensor-historico')?.checked ?? true,
                            'col-classe-historico': document.getElementById('col-classe-historico')?.checked ?? true,
                            'col-classificacao-manual-historico': document.getElementById('col-classificacao-manual-historico')?.checked ?? true,
                            'col-informacao-adicional-historico': document.getElementById('col-informacao-adicional-historico')?.checked ?? true,
                            'col-analises-historico': document.getElementById('col-analises-historico')?.checked ?? true,
                            'col-acertos-historico': document.getElementById('col-acertos-historico')?.checked ?? true,
                            'col-taxa-acerto-historico': document.getElementById('col-taxa-acerto-historico')?.checked ?? true,
                            'col-acoes-historico': document.getElementById('col-acoes-historico')?.checked ?? true
                        };
                        
                        // Aplicar configura√ß√£o
                        Object.keys(colunas).forEach(coluna => {
                            const colunaClass = coluna.replace('-historico', '');
                            const elements = document.querySelectorAll(`.${colunaClass}`);
                            elements.forEach(el => {
                                el.style.display = colunas[coluna] ? '' : 'none';
                            });
                        });
                    }
                    
                    function resetarColunasHistorico() {
                        // Resetar para configura√ß√£o padr√£o
                        const checkboxes = document.querySelectorAll('#modalConfigColunasHistorico input[type="checkbox"]');
                        checkboxes.forEach(checkbox => {
                            checkbox.checked = true;
                        });
                        
                        // Aplicar configura√ß√£o padr√£o
                        aplicarConfigColunasHistorico();
                    }
                    </script>
                    
                    <style>
                    /* Estilos para ordena√ß√£o de colunas */
                    .col-taxa-acerto:hover {
                        background-color: #e9ecef !important;
                        transition: background-color 0.2s ease;
                    }
                    
                    .col-taxa-acerto i {
                        margin-left: 4px;
                        opacity: 0.7;
                    }
                    
                    .col-taxa-acerto:hover i {
                        opacity: 1;
                    }
                    
                    /* Estilos para a tabela de intima√ß√µes do hist√≥rico */
                    .intimacoes-cards-table {
                        border-collapse: separate;
                        border-spacing: 0;
                        table-layout: fixed !important;
                        width: 100% !important;
                    }
                    
                    /* Permitir que o HTML inline defina as larguras */
                    .intimacoes-cards-table th,
                    .intimacoes-cards-table td {
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }

                    .intimacoes-cards-table th {
                        border-bottom: 2px solid #dee2e6;
                        font-weight: 600;
                        color: #495057;
                        padding: 12px 4px;
                        background: #f8f9fa;
                    }

                    .intimacoes-cards-table td {
                        padding: 6px 4px;
                        vertical-align: top;
                        border-bottom: 1px solid #dee2e6;
                    }


                    /* Colunas compactas - padding reduzido */
                    .intimacoes-cards-table .col-analises,
                    .intimacoes-cards-table .col-acertos,
                    .intimacoes-cards-table .col-taxa-acerto,
                    .intimacoes-cards-table .col-acoes {
                        padding: 6px 2px !important;
                        text-align: center;
                    }



                    .intimacao-row:hover {
                        background-color: #f8f9fa;
                    }
                    </style>
                    
                    <!-- Modal de Filtro para Hist√≥rico -->
                    <div class="modal fade" id="modalFiltroHistorico" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="bi bi-funnel text-info"></i>
                                        Filtrar Intima√ß√µes do Hist√≥rico
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <!-- Filtro por Defensor -->
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="bi bi-person text-primary"></i>
                                            <strong>Defensor:</strong>
                                        </label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filtro-todos-defensores-historico" checked>
                                            <label class="form-check-label" for="filtro-todos-defensores-historico">
                                                <strong>Todos os defensores</strong>
                                            </label>
                                        </div>
                                        <hr>
                                        <div id="filtros-defensores-historico">
                                            <div class="text-center py-3">
                                                <i class="bi bi-hourglass-split"></i>
                                                Carregando defensores...
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Filtro por Classifica√ß√£o -->
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="bi bi-tags text-success"></i>
                                            <strong>Classifica√ß√£o:</strong>
                                        </label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filtro-todas-classificacoes-historico" checked>
                                            <label class="form-check-label" for="filtro-todas-classificacoes-historico">
                                                <strong>Todas as classifica√ß√µes</strong>
                                            </label>
                                        </div>
                                        <hr>
                                        <div id="filtros-classificacoes-historico">
                                            <div class="text-center py-3">
                                                <i class="bi bi-hourglass-split"></i>
                                                Carregando classifica√ß√µes...
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Filtro por Classe -->
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="bi bi-book text-warning"></i>
                                            <strong>Classe:</strong>
                                        </label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filtro-todas-classes-historico" checked>
                                            <label class="form-check-label" for="filtro-todas-classes-historico">
                                                <strong>Todas as classes</strong>
                                            </label>
                                        </div>
                                        <hr>
                                        <div id="filtros-classes-historico">
                                            <div class="text-center py-3">
                                                <i class="bi bi-hourglass-split"></i>
                                                Carregando classes...
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Filtro por Taxa de Acerto -->
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="bi bi-graph-up text-primary"></i>
                                            <strong>Taxa de Acerto:</strong>
                                        </label>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="taxa-minima-historico" class="form-label">M√≠nima (%)</label>
                                                <input type="number" class="form-control" id="taxa-minima-historico" min="0" max="100" placeholder="0">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="taxa-maxima-historico" class="form-label">M√°xima (%)</label>
                                                <input type="number" class="form-control" id="taxa-maxima-historico" min="0" max="100" placeholder="100">
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="limparFiltroTaxaHistorico()">
                                                <i class="bi bi-arrow-clockwise"></i>
                                                Limpar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="button" class="btn btn-primary" onclick="aplicarFiltroHistorico()">
                                                    <i class="bi bi-check-circle"></i>
                                        Aplicar Filtros
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modal de Configura√ß√£o de Colunas para Hist√≥rico -->
                    <div class="modal fade" id="modalConfigColunasHistorico" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="bi bi-gear text-warning"></i>
                                        Configurar Colunas - Hist√≥rico
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <h6>Colunas Dispon√≠veis:</h6>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="col-checkbox-compact-historico" checked>
                                            <label class="form-check-label" for="col-checkbox-compact-historico">
                                                Checkbox
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="col-checkbox-historico" checked>
                                            <label class="form-check-label" for="col-checkbox-historico">
                                                Card da Intima√ß√£o
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="col-defensor-historico" checked>
                                            <label class="form-check-label" for="col-defensor-historico">
                                                Defensor
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="col-classe-historico" checked>
                                            <label class="form-check-label" for="col-classe-historico">
                                                Classe
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="col-classificacao-manual-historico" checked>
                                            <label class="form-check-label" for="col-classificacao-manual-historico">
                                                Classifica√ß√£o Manual
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="col-informacao-adicional-historico" checked>
                                            <label class="form-check-label" for="col-informacao-adicional-historico">
                                                Informa√ß√µes Adicionais
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="col-analises-historico" checked>
                                            <label class="form-check-label" for="col-analises-historico">
                                                An√°lises
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="col-acertos-historico" checked>
                                            <label class="form-check-label" for="col-acertos-historico">
                                                Acertos
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="col-taxa-acerto-historico" checked>
                                            <label class="form-check-label" for="col-taxa-acerto-historico">
                                                Taxa de Acerto
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="col-acoes-historico" checked>
                                            <label class="form-check-label" for="col-acoes-historico">
                                                A√ß√µes
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-outline-secondary" onclick="resetarColunasHistorico()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                        Resetar
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="button" class="btn btn-primary" onclick="aplicarConfigColunasHistorico()">
                                        <i class="bi bi-check-circle"></i>
                                        Aplicar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                                            {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-inbox fa-2x text-muted mb-3"></i>
                        <h6 class="text-muted">Nenhuma intima√ß√£o encontrada</h6>
                        <p class="text-muted">Este prompt ainda n√£o foi usado para analisar nenhuma intima√ß√£o.</p>
                    </div>
                                            {% endif %}
            </div>
        </div>

        <!-- Hist√≥rico de An√°lises -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock-history"></i>
                    Hist√≥rico de An√°lises
                </h5>
                <a href="{{ url_for('analise') }}?prompt_ids={{ prompt.id }}" class="btn btn-sm btn-primary">
                    <i class="bi bi-plus-circle"></i>
                    Nova An√°lise
                </a>
            </div>
            <div class="card-body">
                {% if sessoes %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Modelo</th>
                                    <th>Intima√ß√µes</th>
                                    <th>Acur√°cia</th>
                                    <th>Tempo</th>
                                    <th>Custo</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sessao in sessoes %}
                                <tr {% if loop.index > 5 %}class="sessao-extra" style="display: none;"{% endif %}>
                                    <td>
                                        <small class="text-muted">
                                            {% if sessao.data_inicio %}
                                                {% set data = sessao.data_inicio.split('T')[0] if 'T' in sessao.data_inicio else sessao.data_inicio %}
                                                {% set hora = sessao.data_inicio.split('T')[1][:5] if 'T' in sessao.data_inicio else '' %}
                                                {{ data.split('-')[2] }}/{{ data.split('-')[1] }}/{{ data.split('-')[0] }}{% if hora %} {{ hora }}{% endif %}
                                        {% else %}
                                                N/A
                                        {% endif %}
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ sessao.modelo or 'N/A' }}</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ sessao.intima√ß√µes_processadas or 0 }}/{{ sessao.total_intimacoes or 0 }} Processadas
                                        </small>
                                    </td>
                                    <td>
                                        {% if sessao.intima√ß√µes_processadas and sessao.intima√ß√µes_processadas > 0 %}
                                            {% set taxa_acerto = (sessao.acertos * 100.0 / sessao.intima√ß√µes_processadas) %}
                                            {% if taxa_acerto >= 80 %}
                                                <span class="badge bg-success">{{ '%.1f'|format(taxa_acerto) }}% {{ sessao.acertos }}/{{ sessao.intima√ß√µes_processadas }}</span>
                                            {% elif taxa_acerto >= 60 %}
                                                <span class="badge bg-warning">{{ '%.1f'|format(taxa_acerto) }}% {{ sessao.acertos }}/{{ sessao.intima√ß√µes_processadas }}</span>
                                            {% else %}
                                                <span class="badge bg-danger">{{ '%.1f'|format(taxa_acerto) }}% {{ sessao.acertos }}/{{ sessao.intima√ß√µes_processadas }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">0% 0/0</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ '%.2f'|format(sessao.tempo_total or 0) }}s Total
                                        </small>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            ${{ '%.4f'|format(sessao.custo_total or 0) }} {{ sessao.tokens_total or 0 }} tokens
                                        </small>
                                    </td>
                                    <td>
                                        {% if sessao.status == 'Conclu√≠da' %}
                                            <span class="badge bg-success">{{ sessao.status }}</span>
                                        {% elif sessao.status == 'Em andamento' %}
                                            <span class="badge bg-warning">{{ sessao.status }}</span>
                                        {% elif sessao.status == 'Erro' %}
                                            <span class="badge bg-danger">{{ sessao.status }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ sessao.status or 'N/A' }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('visualizar_sessao_analise', session_id=sessao.session_id) }}" class="btn btn-sm btn-outline-primary" title="Ver detalhes">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Bot√£o para expandir/recolher -->
                    {% if sessoes|length > 5 %}
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleAnalises()" id="btn-toggle">
                            <i class="bi bi-chevron-down" id="icon-toggle"></i>
                            <span id="text-toggle">Ver Mais {{ sessoes|length - 5 }} An√°lises</span>
                        </button>
                    </div>
                    
                    <script>
                    function toggleAnalises() {
                        const sessoesExtras = document.querySelectorAll('.sessao-extra');
                        const iconToggle = document.getElementById('icon-toggle');
                        const textToggle = document.getElementById('text-toggle');
                        
                        if (sessoesExtras[0].style.display === 'none') {
                            // Mostrar an√°lises extras
                            sessoesExtras.forEach(row => row.style.display = 'table-row');
                            iconToggle.className = 'bi bi-chevron-up';
                            textToggle.textContent = 'Recolher An√°lises';
                        } else {
                            // Esconder an√°lises extras
                            sessoesExtras.forEach(row => row.style.display = 'none');
                            iconToggle.className = 'bi bi-chevron-down';
                            textToggle.textContent = 'Ver Mais {{ sessoes|length - 5 }} An√°lises';
                        }
                    }
                    </script>
                    {% endif %}
                    
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-play-circle fa-2x text-muted mb-3"></i>
                        <h6 class="text-muted">Prompt ainda n√£o foi usado</h6>
                        <p class="text-muted">Este prompt ainda n√£o foi testado com nenhuma intima√ß√£o.</p>
                        <a href="{{ url_for('analise') }}?prompt_ids={{ prompt.id }}" class="btn btn-primary">
                            <i class="bi bi-play-circle"></i>
                            Fazer Primeiro Teste
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Estat√≠sticas do Prompt -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-bar-chart"></i>
                    Estat√≠sticas de Performance
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-6">
                        <div class="border-end">
                            <h5 class="text-primary mb-0">{{ stats.total_sessoes }}</h5>
                            <small class="text-muted">An√°lises</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h5 class="text-success mb-0">
                            {{ '%.1f'|format(stats.acuracia_media) }}%
                        </h5>
                        <small class="text-muted">Acur√°cia</small>
                    </div>
                </div>
                
                {% if sessoes %}
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="border-end">
                                <h6 class="text-info mb-0">
                                    {{ '%.2f'|format(stats.tempo_total / stats.total_sessoes if stats.total_sessoes > 0 else 0) }}s
                                </h6>
                                <small class="text-muted">Tempo M√©dio</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h6 class="text-warning mb-0">
                                ${{ '%.4f'|format(stats.custo_total) }}
                            </h6>
                            <small class="text-muted">Custo Total</small>
                        </div>
                    </div>
                {% endif %}
                
                <hr>
                
                <div class="d-grid gap-2">
                    <small class="text-muted mb-2">
                        <i class="bi bi-info-circle"></i>
                        Resultados por Classifica√ß√£o:
                    </small>
                    
                    {% set resultados_count = {} %}
                    {% for analise in analises %}
                        {% if analise.resultado_ia %}
                            {% set _ = resultados_count.update({analise.resultado_ia: resultados_count.get(analise.resultado_ia, 0) + 1}) %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if resultados_count %}
                        {% for resultado, count in resultados_count.items() %}
                            {% set badge_class = {
                                'URG√äNCIA': 'danger',
                                'ELABORAR PE√áA': 'success',
                                'ANALISAR PROCESSO': 'info',
                                'CONTATAR ASSISTIDO': 'warning',
                                'RENUNCIAR PRAZO': 'secondary',
                                'OCULTAR': 'dark',
                                'ENCAMINHAR INTIMA√á√ÉO PARA OUTRO DEFENSOR': 'primary'
                            } %}
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-{{ badge_class.get(resultado, 'secondary') }}">{{ resultado }}</span>
                                <small class="text-muted">{{ count }}x ({{ '%.1f'|format((count / (analises | length)) * 100) }}%)</small>
                            </div>
                        {% endfor %}
                    {% else %}
                        <small class="text-muted">Nenhuma an√°lise dispon√≠vel</small>
                    {% endif %}
                </div>
            </div>
        </div>


        <!-- A√ß√µes R√°pidas -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-lightning"></i>
                    A√ß√µes R√°pidas
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('analise') }}?prompt_ids={{ prompt.id }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-play-circle"></i>
                        Testar Prompt
                    </a>
                    
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="copiarTexto('conteudo-prompt')">
                        <i class="bi bi-clipboard"></i>
                        Copiar Conte√∫do
                    </button>
                    
                    {% if prompt.regra_negocio %}
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="copiarTexto('regra-negocio')">
                        <i class="bi bi-gear"></i>
                        Copiar Regra de Neg√≥cio
                    </button>
                    {% endif %}
                    
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="previewPrompt()">
                        <i class="bi bi-eye"></i>
                        Pr√©-visualizar
                    </button>
                    
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="duplicarPrompt()">
                        <i class="bi bi-files"></i>
                        Duplicar Prompt
                    </button>
                    
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="exportarPrompt()">
                        <i class="bi bi-download"></i>
                        Exportar Dados
                    </button>
                    
                    <hr>
                    
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="confirmarExclusao()">
                        <i class="bi bi-trash"></i>
                        Excluir Prompt
                    </button>
                </div>
            </div>
        </div>

        <!-- Informa√ß√µes T√©cnicas -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-gear"></i>
                    Informa√ß√µes T√©cnicas
                </h6>
            </div>
            <div class="card-body">
                <small class="text-muted">
                    <div class="mb-2">
                        <strong>ID:</strong> <code>{{ prompt.id }}</code>
                    </div>
                    <div class="mb-2">
                        <strong>Criado em:</strong> 
                        {% if prompt.data_criacao %}
                            {% set data = prompt.data_criacao.split('T')[0] if 'T' in prompt.data_criacao else prompt.data_criacao %}
                            {% set hora = prompt.data_criacao.split('T')[1][:8] if 'T' in prompt.data_criacao else '' %}
                            {{ data.split('-')[2] }}/{{ data.split('-')[1] }}/{{ data.split('-')[0] }}{% if hora %} {{ hora }}{% endif %}
                        {% else %}
                            N/A
                        {% endif %}
                    </div>
                    <div class="mb-2">
                        <strong>Tamanho:</strong> {{ prompt.conteudo | length }} caracteres
                    </div>
                    <div class="mb-2">
                        <strong>Tokens estimados:</strong> {{ (prompt.conteudo | length / 4) | round | int }}
                    </div>
                    <div class="mb-2">
                        <strong>Total de an√°lises:</strong> {{ stats.total_sessoes }}
                    </div>
                    {% if sessoes and sessoes|length > 0 %}
                        <div class="mb-2">
                            <strong>√öltima sess√£o:</strong> 
                            {% if sessoes and sessoes|length > 0 and sessoes[0].data_inicio %}
                                {% set data = sessoes[0].data_inicio.split('T')[0] if 'T' in sessoes[0].data_inicio else sessoes[0].data_inicio %}
                                {% set hora = sessoes[0].data_inicio.split('T')[1][:5] if 'T' in sessoes[0].data_inicio else '' %}
                                {{ data.split('-')[2] }}/{{ data.split('-')[1] }}/{{ data.split('-')[0] }}{% if hora %} {{ hora }}{% endif %}
                            {% else %}
                                N/A
                            {% endif %}
                        </div>
                    {% endif %}
                    <div class="mb-2">
                        <strong>Cont√©m {CONTEXTO}:</strong> 
                        {% if '{CONTEXTO}' in prompt.conteudo %}
                            <span class="text-success">Sim</span>
                        {% else %}
                            <span class="text-danger">N√£o</span>
                        {% endif %}
                    </div>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Modal de pr√©-visualiza√ß√£o -->
<div class="modal fade" id="modalPreview" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-eye text-info"></i>
                    Pr√©-visualiza√ß√£o do Prompt
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="exemplo-contexto" class="form-label">Exemplo de contexto para teste:</label>
                    <textarea class="form-control" id="exemplo-contexto" rows="4" 
                              placeholder="Cole aqui um exemplo de intima√ß√£o para ver como ficar√° o prompt final..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Prompt final que ser√° enviado para a IA:</label>
                    <pre id="prompt-final" class="bg-light p-3 rounded" style="white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></pre>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Dica:</strong> Verifique se o prompt est√° claro e se a vari√°vel {CONTEXTO} foi substitu√≠da corretamente.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-outline-primary" onclick="copiarPromptFinal()">
                    <i class="bi bi-clipboard"></i>
                    Copiar Prompt
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirma√ß√£o de exclus√£o -->
<div class="modal fade" id="modalExclusao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-warning"></i>
                    Confirmar Exclus√£o
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir este prompt?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Aten√ß√£o:</strong> Esta a√ß√£o tamb√©m excluir√° todas as {{ stats.total_sessoes }} an√°lises relacionadas a este prompt.
                </div>
                <p class="text-muted"><small>Esta a√ß√£o n√£o pode ser desfeita.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btn-confirmar-exclusao">
                    <i class="bi bi-trash"></i>
                    Excluir Prompt
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Fun√ß√£o para copiar texto
function copiarTexto(elementId) {
    const elemento = document.getElementById(elementId);
    const texto = elemento.textContent || elemento.innerText;
    
    navigator.clipboard.writeText(texto).then(function() {
        showToast('Texto copiado para a √°rea de transfer√™ncia!', 'success');
    }).catch(function(err) {
        console.error('Erro ao copiar texto: ', err);
        showToast('Erro ao copiar texto.', 'error');
    });
}



// Fun√ß√£o para alternar quebra de linha
function toggleWrap(elementId) {
    const elemento = document.getElementById(elementId);
    const currentWrap = elemento.style.whiteSpace;
    
    if (currentWrap === 'nowrap') {
        elemento.style.whiteSpace = 'pre-wrap';
        showToast('Quebra de linha ativada', 'info');
    } else {
        elemento.style.whiteSpace = 'nowrap';
        showToast('Quebra de linha desativada', 'info');
    }
}

// Fun√ß√£o para pr√©-visualizar prompt
function previewPrompt() {
    const modal = new bootstrap.Modal(document.getElementById('modalPreview'));
    modal.show();
    
    // Atualizar pr√©-visualiza√ß√£o quando o contexto de exemplo mudar
    document.getElementById('exemplo-contexto').addEventListener('input', atualizarPreview);
    
    // Atualizar pr√©-visualiza√ß√£o inicial
    atualizarPreview();
}

// Fun√ß√£o para atualizar pr√©-visualiza√ß√£o
function atualizarPreview() {
    const conteudo = document.getElementById('conteudo-prompt').textContent;
    const exemploContexto = document.getElementById('exemplo-contexto').value || '[CONTEXTO DA INTIMA√á√ÉO SER√Å INSERIDO AQUI]';
    
    const promptFinal = conteudo.replace(/{CONTEXTO}/g, exemploContexto);
    document.getElementById('prompt-final').textContent = promptFinal;
}

// Fun√ß√£o para copiar prompt final
function copiarPromptFinal() {
    const promptFinal = document.getElementById('prompt-final').textContent;
    
    navigator.clipboard.writeText(promptFinal).then(function() {
        showToast('Prompt copiado para a √°rea de transfer√™ncia!', 'success');
    }).catch(function(err) {
        console.error('Erro ao copiar prompt: ', err);
        showToast('Erro ao copiar prompt.', 'error');
    });
}

// Fun√ß√£o para duplicar prompt
function duplicarPrompt() {
    const conteudo = document.getElementById('conteudo-prompt').textContent;
    const nome = '{{ prompt.nome }} (C√≥pia)';
    const descricao = '{{ prompt.descricao or "" }}';
    
    // Criar URL com par√¢metros para pr√©-preencher o formul√°rio
    const params = new URLSearchParams();
    params.append('nome', nome);
    params.append('descricao', descricao);
    params.append('conteudo', conteudo);
    
    window.location.href = `{{ url_for('novo_prompt') }}?${params.toString()}`;
}

// Fun√ß√£o para confirmar exclus√£o
function confirmarExclusao() {
    const modal = new bootstrap.Modal(document.getElementById('modalExclusao'));
    modal.show();
}

// Fun√ß√£o para exportar prompt
function exportarPrompt() {
    const dados = {
        id: '{{ prompt.id }}',
        nome: '{{ prompt.nome | replace("'", "\\'")|replace('\n', '\\n') }}',
        descricao: '{{ prompt.descricao | replace("'", "\\'")|replace('\n', '\\n') if prompt.descricao else "" }}',
        conteudo: '{{ prompt.conteudo | replace("'", "\\'")|replace('\n', '\\n') }}',
        data_criacao: '{{ prompt.data_criacao }}',
        total_analises: {{ stats.total_sessoes }},
        acuracia: {{ stats.acuracia_media }},
        sessoes: [
            {% for sessao in sessoes %}
            {
                session_id: '{{ sessao.session_id }}',
                data_inicio: '{{ sessao.data_inicio }}',
                modelo: '{{ sessao.modelo or "" }}',
                intima√ß√µes_processadas: {{ sessao.intima√ß√µes_processadas or 0 }},
                total_intimacoes: {{ sessao.total_intimacoes or 0 }},
                acertos: {{ sessao.acertos or 0 }},
                tempo_total: {{ sessao.tempo_total or 0 }},
                custo_total: {{ sessao.custo_total or 0 }},
                status: '{{ sessao.status or "" }}'
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    };
    
    
    const dataStr = JSON.stringify(dados, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `prompt_${dados.id}_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showToast('Dados do prompt exportados!', 'success');
}

// Event listener para confirma√ß√£o de exclus√£o
document.getElementById('btn-confirmar-exclusao').addEventListener('click', function() {
    console.log('=== DEBUG: CONFIRMANDO EXCLUS√ÉO DE PROMPT ===');
    console.log('ID do prompt:', '{{ prompt.id }}');
    
    const promptId = '{{ prompt.id }}';
    const btnConfirmar = this;
    const originalText = btnConfirmar.innerHTML;
    
    // Mostrar loading
    btnConfirmar.innerHTML = '<i class="bi bi-hourglass-split"></i> Excluindo...';
    btnConfirmar.disabled = true;
    
    // Fazer requisi√ß√£o para excluir
    fetch(`/api/prompts/${promptId}/excluir`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        console.log('Resposta da exclus√£o:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Dados da resposta:', data);
        
        if (data.success) {
            showToast('Prompt exclu√≠do com sucesso!', 'success');
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalExclusao'));
            modal.hide();
            
            // Redirecionar para lista ap√≥s 1 segundo
            setTimeout(() => {
                window.location.href = '{{ url_for("listar_prompts") }}';
            }, 1000);
        } else {
            showToast(`Erro ao excluir: ${data.message}`, 'error');
            btnConfirmar.innerHTML = originalText;
            btnConfirmar.disabled = false;
        }
    })
    .catch(error => {
        console.error('Erro na exclus√£o:', error);
        showToast('Erro ao excluir prompt!', 'error');
        btnConfirmar.innerHTML = originalText;
        btnConfirmar.disabled = false;
    });
});

// Fun√ß√£o para formatar data usando JavaScript nativo
function formatarData(dateString, format = 'DD/MM/YYYY HH:mm') {
    if (!dateString) return 'N/A';
    
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Data inv√°lida';
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        
        if (format === 'DD/MM/YYYY HH:mm:ss') {
            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        } else if (format === 'DD/MM/YYYY HH:mm') {
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }
        
        return `${day}/${month}/${year} ${hours}:${minutes}`;
    } catch (e) {
        return 'Data inv√°lida';
    }
}

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    // Ctrl+C para copiar conte√∫do
    if (e.ctrlKey && e.key === 'c' && !window.getSelection().toString()) {
        e.preventDefault();
        copiarTexto('conteudo-prompt');
    }
    
    // Ctrl+T para testar
    if (e.ctrlKey && e.key === 't') {
        e.preventDefault();
        window.location.href = `{{ url_for('analise') }}?prompt_ids={{ prompt.id }}`;
    }
    
    // Ctrl+P para pr√©-visualizar
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        previewPrompt();
    }
    
    // Ctrl+D para duplicar
    if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        duplicarPrompt();
    }
    
    // Escape para voltar
    if (e.key === 'Escape') {
        window.location.href = '{{ url_for("listar_prompts") }}';
    }
});



// Aplicar formata√ß√£o de data ap√≥s carregamento da p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Formatar datas nas tabelas
    const dateCells = document.querySelectorAll('td small.text-muted');
    dateCells.forEach(cell => {
        const dateText = cell.textContent.trim();
        if (dateText && dateText !== 'N/A' && dateText.includes('-')) {
            try {
                const formatted = formatarData(dateText, 'DD/MM/YYYY HH:mm');
                cell.textContent = formatted;
            } catch (e) {
                // Manter texto original se n√£o conseguir formatar
            }
        }
    });
});

</script>

<!-- Incluir componente modal de informa√ß√µes adicionais -->
{% include 'partials/modal_informacoes_adicionais.html' %}
{% endblock %}