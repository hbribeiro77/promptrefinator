{% extends "base.html" %}

{% block title %}Nova Intima√ß√£o - Sistema Analisador de Prompts{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-plus-circle"></i>
        Nova Intima√ß√£o
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('listar_intimacoes') }}" class="btn btn-sm btn-outline-secondary" onclick="console.log('=== DEBUG: BOT√ÉO VER LISTA CLICADO (FRONTEND) ==='); console.log('Redirecionando para lista de intima√ß√µes...');">
            <i class="bi bi-arrow-left"></i>
            Voltar para Lista
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-file-text"></i>
                    Dados da Intima√ß√£o
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="form-intimacao">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="contexto" class="form-label mb-0">
                                Contexto da Intima√ß√£o <span class="text-danger">*</span>
                            </label>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="btn-extrair-info" onclick="extrairInformacoes()">
                                <i class="bi bi-magic"></i>
                                Extrair Informa√ß√µes
                            </button>
                        </div>
                        <textarea class="form-control" id="contexto" name="contexto" rows="8" 
                                  placeholder="Cole aqui o texto completo da intima√ß√£o..." required></textarea>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i>
                            Cole o texto completo da intima√ß√£o. Este ser√° o contexto usado para an√°lise pela IA.
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                Caracteres: <span id="char-count">0</span> | 
                                Palavras: <span id="word-count">0</span> | 
                                Linhas: <span id="line-count">0</span>
                            </small>
                        </div>
                    </div>

                    <!-- Informa√ß√µes B√°sicas -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="processo" class="form-label">
                                Processo
                            </label>
                            <input type="text" class="form-control" id="processo" name="processo" 
                                   placeholder="N√∫mero do processo" value="{{ dados.processo or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="orgao_julgador" class="form-label">
                                √ìrg√£o Julgador
                            </label>
                            <input type="text" class="form-control" id="orgao_julgador" name="orgao_julgador" 
                                   placeholder="√ìrg√£o julgador" value="{{ dados.orgao_julgador or '' }}">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="classe" class="form-label">
                                Classe
                            </label>
                            <input type="text" class="form-control" id="classe" name="classe" 
                                   placeholder="Classe processual" value="{{ dados.classe or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="disponibilizacao" class="form-label">
                                Disponibiliza√ß√£o
                            </label>
                            <input type="text" class="form-control" id="disponibilizacao" name="disponibilizacao" 
                                   placeholder="Data de disponibiliza√ß√£o" value="{{ dados.disponibilizacao or '' }}">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="intimado" class="form-label">
                                Intimado
                            </label>
                            <input type="text" class="form-control" id="intimado" name="intimado" 
                                   placeholder="Nome do intimado" value="{{ dados.intimado or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="status" class="form-label">
                                Status
                            </label>
                            <input type="text" class="form-control" id="status" name="status" 
                                   placeholder="Status da intima√ß√£o" value="{{ dados.status or '' }}">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="prazo" class="form-label">
                                Prazo
                            </label>
                            <input type="text" class="form-control" id="prazo" name="prazo" 
                                   placeholder="Prazo da intima√ß√£o" value="{{ dados.prazo or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="defensor" class="form-label">
                                Nome do Defensor
                            </label>
                            <select class="form-select" id="defensor" name="defensor">
                                <option value="">Selecione o defensor...</option>
                                {% for defensor in defensores %}
                                    <option value="{{ defensor }}" {% if dados.defensor == defensor %}selected{% endif %}>{{ defensor }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="id_tarefa" class="form-label">
                                ID da Tarefa
                            </label>
                            <input type="text" class="form-control" id="id_tarefa" name="id_tarefa" 
                                   placeholder="Identificador da tarefa" value="{{ dados.id_tarefa or '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="cor_etiqueta" class="form-label">
                                Cor da Etiqueta
                            </label>
                            <select class="form-select" id="cor_etiqueta" name="cor_etiqueta">
                                <option value="">Selecione uma cor...</option>
                                <option value="#ffe500" style="background-color: #ffe500; color: #000;" {% if dados.cor_etiqueta == '#ffe500' %}selected{% endif %}>üü° Amarela</option>
                                <option value="#80ff00" style="background-color: #80ff00; color: #000;" {% if dados.cor_etiqueta == '#80ff00' %}selected{% endif %}>üü¢ Verde</option>
                                <option value="#00ffff" style="background-color: #00ffff; color: #000;" {% if dados.cor_etiqueta == '#00ffff' %}selected{% endif %}>üîµ Azul</option>
                            </select>
                            <div class="form-text">
                                <i class="bi bi-tag"></i>
                                Selecione uma cor para categorizar a intima√ß√£o
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="classificacao_manual" class="form-label">
                            Classifica√ß√£o Manual <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="classificacao_manual" name="classificacao_manual" required>
                            <option value="">Selecione a classifica√ß√£o...</option>
                            {% for tipo in tipos_acao %}
                                <option value="{{ tipo }}">{{ tipo }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i>
                            Esta √© a classifica√ß√£o correta que ser√° usada para comparar com a an√°lise da IA.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="informacoes_adicionais" class="form-label">
                            Informa√ß√µes Adicionais
                        </label>
                        <textarea class="form-control" id="informacoes_adicionais" name="informacoes_adicionais" rows="3" 
                                  placeholder="Observa√ß√µes, contexto adicional, notas importantes..."></textarea>
                        <div class="form-text">
                            <i class="bi bi-lightbulb"></i>
                            Informa√ß√µes que podem ajudar na an√°lise ou contexto adicional relevante.
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-outline-secondary" onclick="limparFormulario()">
                            <i class="bi bi-arrow-clockwise"></i>
                            Limpar
                        </button>
                        <button type="submit" class="btn btn-primary" id="btn-salvar">
                            <i class="bi bi-check-circle"></i>
                            Salvar Intima√ß√£o
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Dicas e Ajuda -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-lightbulb"></i>
                    Dicas para Cadastro
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="bi bi-info-circle"></i> Contexto</h6>
                    <ul class="mb-0">
                        <li>Cole o texto completo da intima√ß√£o</li>
                        <li>Inclua todas as informa√ß√µes relevantes</li>
                        <li>Mantenha a formata√ß√£o original quando poss√≠vel</li>
                    </ul>
                </div>
                
                <div class="alert alert-warning">
                    <h6><i class="bi bi-exclamation-triangle"></i> Classifica√ß√£o</h6>
                    <ul class="mb-0">
                        <li>Escolha a classifica√ß√£o mais adequada</li>
                        <li>Esta ser√° usada para medir a precis√£o da IA</li>
                        <li>Em caso de d√∫vida, use "ANALISAR PROCESSO"</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Tipos de A√ß√£o Dispon√≠veis -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-list-check"></i>
                    Tipos de A√ß√£o
                </h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% for tipo in tipos_acao %}
                        {% set badge_class = {
                            'URG√äNCIA': 'danger',
                            'ELABORAR PE√áA': 'success',
                            'ANALISAR PROCESSO': 'info',
                            'CONTATAR ASSISTIDO': 'warning',
                            'RENUNCIAR PRAZO': 'secondary',
                            'OCULTAR': 'dark',
                            'ENCAMINHAR INTIMA√á√ÉO PARA OUTRO DEFENSOR': 'primary'
                        } %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <small>{{ tipo }}</small>
                            <span class="badge bg-{{ badge_class.get(tipo, 'secondary') }} rounded-pill">
                                <i class="bi bi-tag"></i>
                            </span>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirma√ß√£o -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle text-success"></i>
                    Intima√ß√£o Salva
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Intima√ß√£o cadastrada com sucesso!</p>
                <p class="text-muted">O que voc√™ gostaria de fazer agora?</p>
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('nova_intimacao') }}" class="btn btn-outline-primary">
                    <i class="bi bi-plus-circle"></i>
                    Cadastrar Outra
                </a>
                <a href="{{ url_for('listar_intimacoes') }}" class="btn btn-primary">
                    <i class="bi bi-list"></i>
                    Ver Lista
                </a>
                <button type="button" class="btn btn-success" onclick="analisarEstaIntimacao()">
                    <i class="bi bi-cpu"></i>
                    Analisar Agora
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let ultimaIntimacaoId = null;

// Fun√ß√£o para contar caracteres, palavras e linhas
function updateTextStats() {
    const textarea = document.getElementById('contexto');
    const text = textarea.value;
    
    const charCount = text.length;
    const wordCount = text.trim() ? text.trim().split(/\s+/).length : 0;
    const lineCount = text.split('\n').length;
    
    document.getElementById('char-count').textContent = charCount.toLocaleString();
    document.getElementById('word-count').textContent = wordCount.toLocaleString();
    document.getElementById('line-count').textContent = lineCount.toLocaleString();
    
    // Avisos baseados no tamanho do texto
    const formText = textarea.parentElement.querySelector('.form-text');
    if (charCount > 4000) {
        formText.className = 'form-text text-warning';
        formText.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Texto muito longo. Considere resumir para melhor an√°lise.';
    } else if (charCount < 50) {
        formText.className = 'form-text text-warning';
        formText.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Texto muito curto. Adicione mais contexto para melhor an√°lise.';
    } else {
        formText.className = 'form-text';
        formText.innerHTML = '<i class="bi bi-info-circle"></i> Cole o texto completo da intima√ß√£o. Este ser√° o contexto usado para an√°lise pela IA.';
    }
}

// Fun√ß√£o para limpar formul√°rio
function limparFormulario() {
    if (confirm('Tem certeza que deseja limpar todos os campos?')) {
        document.getElementById('form-intimacao').reset();
        updateTextStats();
        document.getElementById('contexto').focus();
    }
}

// Fun√ß√£o para analisar esta intima√ß√£o
function analisarEstaIntimacao() {
    if (ultimaIntimacaoId) {
        window.location.href = `{{ url_for('analise') }}?intimacao_ids=${ultimaIntimacaoId}`;
    }
}

// Valida√ß√£o do formul√°rio
function validarFormulario() {
    const contexto = document.getElementById('contexto').value.trim();
    const classificacao = document.getElementById('classificacao_manual').value;
    
    if (!contexto) {
        showToast('O contexto da intima√ß√£o √© obrigat√≥rio.', 'error');
        document.getElementById('contexto').focus();
        return false;
    }
    
    if (contexto.length < 10) {
        showToast('O contexto deve ter pelo menos 10 caracteres.', 'error');
        document.getElementById('contexto').focus();
        return false;
    }
    
    if (!classificacao) {
        showToast('A classifica√ß√£o manual √© obrigat√≥ria.', 'error');
        document.getElementById('classificacao_manual').focus();
        return false;
    }
    
    return true;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('contexto');
    const form = document.getElementById('form-intimacao');
    
    // Atualizar estat√≠sticas do texto
    textarea.addEventListener('input', updateTextStats);
    textarea.addEventListener('paste', function() {
        setTimeout(updateTextStats, 10);
    });
    
    // Valida√ß√£o do formul√°rio
    form.addEventListener('submit', function(e) {
        console.log('=== DEBUG: BOT√ÉO SALVAR CLICADO (FRONTEND) ===');
        console.log('Formul√°rio submetido!');
        
        e.preventDefault();
        
        console.log('Validando formul√°rio...');
        if (!validarFormulario()) {
            console.log('Valida√ß√£o falhou!');
            return;
        }
        
        console.log('Valida√ß√£o passou! Preparando dados...');
        
        // Capturar dados do formul√°rio
        const contexto = document.getElementById('contexto').value;
        const classificacao = document.getElementById('classificacao_manual').value;
        const informacoes = document.getElementById('informacoes_adicionais').value;
        
        console.log('Dados do formul√°rio:');
        console.log('- Contexto:', contexto);
        console.log('- Classifica√ß√£o:', classificacao);
        console.log('- Informa√ß√µes:', informacoes);
        
        // Mostrar loading
        const btnSalvar = document.getElementById('btn-salvar');
        const originalText = btnSalvar.innerHTML;
        btnSalvar.innerHTML = '<i class="bi bi-hourglass-split"></i> Salvando...';
        btnSalvar.disabled = true;
        
        console.log('Enviando dados para o servidor...');
        
        // Enviar dados para o servidor
        const formData = new FormData(form);
        
        fetch('{{ url_for("nova_intimacao") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('Resposta do servidor:', response.status, response.statusText);
            if (response.redirected) {
                console.log('Redirecionando para:', response.url);
                window.location.href = response.url;
            } else {
                return response.text();
            }
        })
        .then(html => {
            if (html) {
                console.log('HTML recebido do servidor');
                // Se n√£o foi redirecionado, mostrar a p√°gina
                document.open();
                document.write(html);
                document.close();
            }
        })
        .catch(error => {
            console.error('Erro ao enviar dados:', error);
            btnSalvar.innerHTML = originalText;
            btnSalvar.disabled = false;
            showToast('Erro ao salvar intima√ß√£o!', 'error');
        });
    });
    
    // Focar no primeiro campo
    textarea.focus();
    
    // Atualizar estat√≠sticas iniciais
    updateTextStats();
});

// Atalhos de teclado
document.addEventListener('keydown', function(e) {
    // Ctrl+S para salvar
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        document.getElementById('form-intimacao').dispatchEvent(new Event('submit'));
    }
    
    // Ctrl+R para limpar
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        limparFormulario();
    }
    
    // Escape para voltar
    if (e.key === 'Escape') {
        if (confirm('Deseja sair sem salvar?')) {
            window.location.href = '{{ url_for("listar_intimacoes") }}';
        }
    }
});

// Auto-save no localStorage (rascunho)
let autoSaveTimeout;
function autoSave() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(function() {
        const formData = {
            contexto: document.getElementById('contexto').value,
            classificacao_manual: document.getElementById('classificacao_manual').value,
            informacoes_adicionais: document.getElementById('informacoes_adicionais').value,
            processo: document.getElementById('processo').value,
            orgao_julgador: document.getElementById('orgao_julgador').value,
            classe: document.getElementById('classe').value,
            disponibilizacao: document.getElementById('disponibilizacao').value,
            intimado: document.getElementById('intimado').value,
            status: document.getElementById('status').value,
            prazo: document.getElementById('prazo').value,
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('rascunho_intimacao', JSON.stringify(formData));
    }, 2000);
}

// Carregar rascunho se existir
function carregarRascunho() {
    const rascunho = localStorage.getItem('rascunho_intimacao');
    if (rascunho) {
        try {
            const data = JSON.parse(rascunho);
            const timestamp = new Date(data.timestamp);
            const agora = new Date();
            const diffHoras = (agora - timestamp) / (1000 * 60 * 60);
            
            // S√≥ carregar se o rascunho for de menos de 24 horas
            if (diffHoras < 24) {
                if (confirm('Encontrei um rascunho salvo. Deseja carreg√°-lo?')) {
                    document.getElementById('contexto').value = data.contexto || '';
                    document.getElementById('classificacao_manual').value = data.classificacao_manual || '';
                    document.getElementById('informacoes_adicionais').value = data.informacoes_adicionais || '';
                    document.getElementById('processo').value = data.processo || '';
                    document.getElementById('orgao_julgador').value = data.orgao_julgador || '';
                    document.getElementById('classe').value = data.classe || '';
                    document.getElementById('disponibilizacao').value = data.disponibilizacao || '';
                    document.getElementById('intimado').value = data.intimado || '';
                    document.getElementById('status').value = data.status || '';
                    document.getElementById('prazo').value = data.prazo || '';
                    updateTextStats();
                }
            } else {
                // Remover rascunho antigo
                localStorage.removeItem('rascunho_intimacao');
            }
        } catch (e) {
            console.error('Erro ao carregar rascunho:', e);
            localStorage.removeItem('rascunho_intimacao');
        }
    }
}

// Fun√ß√£o para extrair informa√ß√µes do contexto
function extrairInformacoes() {
    const contexto = document.getElementById('contexto').value.trim();
    
    if (!contexto) {
        showToast('Cole o contexto da intima√ß√£o primeiro!', 'warning');
        return;
    }
    
    console.log('=== DEBUG: Extraindo informa√ß√µes do contexto ===');
    
    // Desabilitar bot√£o e mostrar loading
    const btnExtrair = document.getElementById('btn-extrair-info');
    const originalText = btnExtrair.innerHTML;
    btnExtrair.disabled = true;
    btnExtrair.innerHTML = '<i class="bi bi-hourglass-split"></i> Extraindo...';
    
    // Fazer chamada para a API
    fetch('/api/extrair-informacoes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ contexto: contexto })
    })
    .then(response => response.json())
    .then(data => {
        console.log('=== DEBUG: Informa√ß√µes extra√≠das:', data);
        
        if (data.success) {
            // Preencher os campos com as informa√ß√µes extra√≠das
            if (data.informacoes.processo) {
                document.getElementById('processo').value = data.informacoes.processo;
            }
            if (data.informacoes.orgao_julgador) {
                document.getElementById('orgao_julgador').value = data.informacoes.orgao_julgador;
            }
            if (data.informacoes.classe) {
                document.getElementById('classe').value = data.informacoes.classe;
            }
            if (data.informacoes.disponibilizacao) {
                document.getElementById('disponibilizacao').value = data.informacoes.disponibilizacao;
            }
            if (data.informacoes.intimado) {
                document.getElementById('intimado').value = data.informacoes.intimado;
            }
            if (data.informacoes.status) {
                document.getElementById('status').value = data.informacoes.status;
            }
            if (data.informacoes.prazo) {
                document.getElementById('prazo').value = data.informacoes.prazo;
            }
            
            showToast('Informa√ß√µes extra√≠das com sucesso!', 'success');
        } else {
            showToast('Erro ao extrair informa√ß√µes: ' + (data.error || 'Erro desconhecido'), 'error');
        }
    })
    .catch(error => {
        console.error('=== ERRO na extra√ß√£o:', error);
        showToast('Erro ao extrair informa√ß√µes: ' + error.message, 'error');
    })
    .finally(() => {
        // Reabilitar bot√£o
        btnExtrair.disabled = false;
        btnExtrair.innerHTML = originalText;
    });
}

// Adicionar listeners para auto-save
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DEBUG: P√ÅGINA NOVA INTIMA√á√ÉO CARREGADA (FRONTEND) ===');
    console.log('P√°gina de nova intima√ß√£o carregada!');
    console.log('URL atual:', window.location.href);
    
    carregarRascunho();
    
            ['contexto', 'classificacao_manual', 'informacoes_adicionais', 'processo', 'orgao_julgador', 'classe', 'disponibilizacao', 'intimado', 'status', 'prazo'].forEach(id => {
        document.getElementById(id).addEventListener('input', autoSave);
    });
});

// Limpar rascunho quando formul√°rio for enviado com sucesso
window.addEventListener('beforeunload', function() {
    // N√£o limpar aqui, s√≥ quando realmente salvar
});
</script>
{% endblock %}