{% extends "base.html" %}

{% block title %}Sessão de Análise - {{ sessao.session_id[:8] }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('historico_analises') }}">
                            <i class="bi bi-clock-history"></i>
                            Histórico
                        </a>
                    </li>
                    <li class="breadcrumb-item active">Sessão {{ sessao.session_id[:8] }}</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0">
                <i class="bi bi-activity text-primary"></i>
                Sessão de Análise
            </h1>
            <p class="text-muted mb-0">{{ sessao.prompt_nome }} - {{ sessao.data_inicio_formatada }}</p>
        </div>
        <div>
            <a href="{{ url_for('historico_analises') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i>
                Voltar
            </a>
        </div>
    </div>

    <!-- Informações da Sessão -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i>
                        Informações da Sessão
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">ID da Sessão</small>
                            <p class="mb-2"><code>{{ sessao.session_id }}</code></p>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Status</small>
                            <p class="mb-2">
                                {% if sessao.status == 'concluida' %}
                                    <span class="badge bg-success">Concluída</span>
                                {% elif sessao.status == 'em_andamento' %}
                                    <span class="badge bg-warning">Em andamento</span>
                                {% else %}
                                    <span class="badge bg-danger">Erro</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Início</small>
                            <p class="mb-2">{{ sessao.data_inicio_formatada }}</p>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Fim</small>
                            <p class="mb-2">{{ sessao.data_fim_formatada or 'Em andamento' }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Prompt</small>
                            <p class="mb-2">
                                <a href="{{ url_for('visualizar_prompt', id=sessao.prompt_id) }}" 
                                   target="_blank" 
                                   class="text-decoration-none">
                                    <i class="bi bi-box-arrow-up-right me-1"></i>
                                    {{ sessao.prompt_nome }}
                                </a>
                            </p>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Modelo</small>
                            <p class="mb-2">{{ sessao.modelo }}</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i>
                        Estatísticas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h3 class="text-primary mb-0">{{ sessao.acertos or 0 }}/{{ sessao.intimações_processadas or 0 }}</h3>
                                <small class="text-muted">Acertos / Processadas</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h3 class="text-success mb-0">{{ sessao.acuracia }}%</h3>
                                <small class="text-muted">Acurácia</small>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-info mb-0">{{ "%.2f"|format(sessao.tempo_total or 0) }}s</h4>
                                <small class="text-muted">Tempo Total</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h4 class="text-warning mb-0">${{ "%.4f"|format(sessao.custo_total or 0) }}</h4>
                                <small class="text-muted">Custo Total</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Regra de Negócio -->
    {% if sessao.configuracoes_parsed and sessao.configuracoes_parsed.regra_negocio %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-file-text"></i>
                Regra de Negócio Utilizada
            </h5>
        </div>
        <div class="card-body">
            <div class="bg-light p-3 rounded border">
                <pre class="mb-0" style="white-space: pre-wrap; font-size: 0.9rem; line-height: 1.5; color: #495057;">{{ sessao.configuracoes_parsed.regra_negocio }}</pre>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Configurações -->
    {% if sessao.configuracoes_parsed %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-gear"></i>
                Configurações Utilizadas
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <small class="text-muted">Modelo</small>
                    <p class="mb-2">{{ sessao.modelo }}</p>
                </div>
                <div class="col">
                    <small class="text-muted">Temperatura</small>
                    <p class="mb-2">{{ sessao.temperatura }}</p>
                </div>
                <div class="col">
                    <small class="text-muted">Max Tokens</small>
                    <p class="mb-2">{{ sessao.max_tokens }}</p>
                </div>
                <div class="col">
                    <small class="text-muted">Timeout</small>
                    <p class="mb-2">{{ sessao.timeout }}s</p>
                </div>
                <div class="col">
                    <small class="text-muted">Tokens Totais</small>
                    <p class="mb-2">{{ sessao.tokens_total or 0 }}</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Filtros -->
    <div class="card mb-3">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="bi bi-funnel text-primary"></i>
                Filtros
            </h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Status</label>
                    <select class="form-select" id="filtro-status" onchange="aplicarFiltros()">
                        <option value="todos">Todos</option>
                        <option value="acertou">Acertou</option>
                        <option value="errou">Errou</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-semibold">Taxa de Acerto</label>
                    <select class="form-select" id="filtro-taxa-acerto" onchange="aplicarFiltros()">
                        <option value="todos">Todas as taxas</option>
                        <option value="0-25">0% - 25%</option>
                        <option value="25-50">25% - 50%</option>
                        <option value="50-75">50% - 75%</option>
                        <option value="75-100">75% - 100%</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-secondary" onclick="limparFiltros()">
                        <i class="bi bi-x-circle"></i>
                        Limpar Filtros
                    </button>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <small class="text-muted">
                        <span id="contador-filtrados">Carregando...</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de Ações em Lote -->
    <div class="card mb-3" id="barra-acoes-lote" style="display: none;">
        <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary me-2" id="contador-selecionadas">0 selecionadas</span>
                    <span class="text-muted">Ações em lote:</span>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="reanalisarSelecionadas()">
                        <i class="bi bi-arrow-clockwise"></i>
                        Re-analisar
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="verInformacoesAdicionaisSelecionadas()">
                        <i class="bi bi-info-circle"></i>
                        Ver Informações Adicionais
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="exportarSelecionadas()">
                        <i class="bi bi-download"></i>
                        Exportar
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="compararSelecionadas()">
                        <i class="bi bi-bar-chart"></i>
                        Comparar
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="excluirSelecionadas()">
                        <i class="bi bi-trash"></i>
                        Excluir
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparSelecoes()">
                        <i class="bi bi-x"></i>
                        Limpar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados das Análises -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-check"></i>
                    Resultados das Análises
                </h5>
                <div class="d-flex align-items-center">
                    <span class="badge bg-secondary me-2" id="contador-analises">
                        {{ analises|length }} análises
                    </span>
                    <button type="button" class="btn btn-sm btn-outline-info me-2" onclick="toggleConfiguracaoColunas()">
                        <i class="bi bi-gear"></i>
                        Configurar
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportarResultados()">
                        <i class="bi bi-download"></i>
                        Exportar
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Configuração de Colunas (colapsável) -->
        <div class="card-body border-bottom" id="configuracao-colunas" style="display: none;">
            <div class="row">
                <div class="col-md-3">
                    <h6 class="text-muted mb-2">Colunas Básicas</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-selecao" checked>
                        <label class="form-check-label" for="col-selecao">Seleção</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-intimacao" checked>
                        <label class="form-check-label" for="col-intimacao">Intimação</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-classificacao-manual" checked>
                        <label class="form-check-label" for="col-classificacao-manual">Classificação Manual</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-informacao-adicional" checked>
                        <label class="form-check-label" for="col-informacao-adicional">Informação Adicional</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <h6 class="text-muted mb-2">Colunas de Resultado</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-resultado-ia" checked>
                        <label class="form-check-label" for="col-resultado-ia">Resultado IA</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-status" checked>
                        <label class="form-check-label" for="col-status">Status</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <h6 class="text-muted mb-2">Colunas de Métricas</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-tempo" checked>
                        <label class="form-check-label" for="col-tempo">Tempo</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-custo" checked>
                        <label class="form-check-label" for="col-custo">Custo</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-tokens" checked>
                        <label class="form-check-label" for="col-tokens">Tokens</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="col-acerto-individual" checked>
                        <label class="form-check-label" for="col-acerto-individual">% de Acerto</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <h6 class="text-muted mb-2">Ações</h6>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selecionarTodasColunas()">
                            <i class="bi bi-check-all"></i>
                            Selecionar Todas
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparSelecaoColunas()">
                            <i class="bi bi-x-circle"></i>
                            Limpar Seleção
                        </button>
                        <button type="button" class="btn btn-sm btn-success" onclick="salvarConfiguracaoColunas()">
                            <i class="bi bi-check-circle"></i>
                            Salvar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            {% if analises %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="col-selecao" style="width: 30px; text-align: center;">
                                <input type="checkbox" id="selecionar-todos" onchange="toggleSelecaoTodos()" title="Selecionar todos">
                            </th>
                            <th class="col-intimacao">Intimação</th>
                            <th class="col-classificacao-manual">Classificação Manual</th>
                            <th class="col-informacao-adicional">Informação Adicional</th>
                            <th class="col-resultado-ia">Resultado IA</th>
                            <th class="col-status">Status</th>
                            <th class="col-tempo">Tempo</th>
                            <th class="col-custo">Custo</th>
                            <th class="col-tokens">Tokens</th>
                            <th class="col-acerto-individual">% de Acerto</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for analise in analises %}
                        <tr class="linha-analise" 
                            data-status="{% if analise.acertou %}acertou{% else %}errou{% endif %}"
                            data-taxa-acerto="{{ analise.taxa_acerto_intimacao }}"
                            data-analise-id="{{ analise.id }}">
                            <td class="col-selecao" style="text-align: center;">
                                <input type="checkbox" class="checkbox-analise" value="{{ analise.id }}" onchange="atualizarSelecoes()">
                            </td>
                            <td class="col-intimacao">
                                {% set intimacao = {
                                    'id': analise.intimacao_id,
                                    'processo': analise.processo or analise.intimacao_id,
                                    'orgao_julgador': analise.orgao_julgador or 'N/A',
                                    'status': analise.status or 'Pendente',
                                    'prazo': analise.prazo or 'N/A',
                                    'intimado': analise.intimado or 'N/A',
                                    'disponibilizacao': analise.disponibilizacao or analise.data_analise_formatada or 'N/A'
                                } %}
                                {% include 'partials/card_intimacao_compact.html' %}
                            </td>
                            <td class="col-classificacao-manual">
                                <span class="badge bg-secondary">{{ analise.classificacao_manual }}</span>
                            </td>
                            <td class="col-informacao-adicional">
                                {% if analise.informacao_adicional %}
                                    <div class="info-adicional-text" title="{{ analise.informacao_adicional }}">
                                        {{ analise.informacao_adicional[:50] }}{% if analise.informacao_adicional|length > 50 %}...{% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="col-resultado-ia">
                                <span class="badge bg-info">{{ analise.resultado_ia }}</span>
                            </td>
                            <td class="col-status">
                                {% if analise.acertou %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i>
                                        Acertou
                                    </span>
                                {% else %}
                                    <span class="badge bg-danger">
                                        <i class="bi bi-x-circle"></i>
                                        Errou
                                    </span>
                                {% endif %}
                            </td>
                            <td class="col-tempo">
                                <span>{{ "%.2f"|format(analise.tempo_processamento or 0) }}s</span>
                            </td>
                            <td class="col-custo">
                                <span>${{ "%.4f"|format(analise.custo_real or 0) }}</span>
                            </td>
                            <td class="col-tokens">
                                <small class="text-muted">
                                    {{ analise.tokens_input or 0 }}/{{ analise.tokens_output or 0 }}
                                </small>
                            </td>
                            <td class="col-acerto-individual">
                                <div class="d-flex flex-column align-items-center">
                                    <span class="badge bg-primary mb-1">
                                        {{ analise.taxa_acerto_intimacao }}%
                                    </span>
                                    <small class="text-muted">
                                        {{ analise.acertos_intimacao }}/{{ analise.total_testes_intimacao }}
                                    </small>
                                </div>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" 
                                            onclick="visualizarPrompt('{{ analise.id }}')" 
                                            title="Ver prompt">
                                        <i class="bi bi-chat-quote"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" 
                                            onclick="visualizarResposta('{{ analise.id }}')" 
                                            title="Ver resposta">
                                        <i class="bi bi-chat-text"></i>
                                    </button>
                                    <button class="btn btn-outline-info" 
                                            onclick="visualizarContexto('{{ analise.intimacao_id }}', '{{ analise.contexto|replace("'", "\\'")|replace('"', '\\"') }}')" 
                                            title="Ver contexto">
                                        <i class="bi bi-file-text"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <h4 class="text-muted mt-3">Nenhuma análise encontrada</h4>
                <p class="text-muted">Esta sessão não possui análises registradas.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal para visualizar prompt -->
<div class="modal fade" id="modalPrompt" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Prompt Completo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="modal-prompt-content" class="bg-light p-3 rounded"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="copiarPrompt()">
                    <i class="bi bi-clipboard"></i>
                    Copiar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para visualizar resposta -->
<div class="modal fade" id="modalResposta" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resposta da IA</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="modal-resposta-content" class="bg-light p-3 rounded"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="copiarResposta()">
                    <i class="bi bi-clipboard"></i>
                    Copiar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para visualizar contexto -->
<div class="modal fade" id="modalContexto" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Contexto da Intimação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modal-contexto-content" class="markdown-content"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="copiarContexto()">
                    <i class="bi bi-clipboard"></i>
                    Copiar
                </button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

<!-- Incluir componente modal de informações adicionais -->
{% include 'partials/modal_informacoes_adicionais.html' %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
/* Coluna de seleção compacta */
.col-selecao {
    width: 30px !important;
    min-width: 30px !important;
    max-width: 30px !important;
    padding: 8px 4px !important;
}

.col-selecao input[type="checkbox"] {
    margin: 0;
    transform: scale(0.9);
}

/* Garantir que a tabela não quebre com a coluna compacta */
.table-responsive {
    overflow-x: auto;
}

/* Ajustar espaçamento das outras colunas */
.table th:not(.col-selecao),
.table td:not(.col-selecao) {
    padding-left: 12px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Dados das análises para acesso via JavaScript
const analisesData = {{ analises|tojson }};

// Função para visualizar prompt
function visualizarPrompt(analiseId) {
    const analise = analisesData.find(a => a.id === analiseId);
    if (analise && analise.prompt_completo) {
        document.getElementById('modal-prompt-content').textContent = analise.prompt_completo;
        const modal = new bootstrap.Modal(document.getElementById('modalPrompt'));
        modal.show();
    } else {
        showToast('Prompt não disponível', 'warning');
    }
}

// Função para visualizar resposta
function visualizarResposta(analiseId) {
    const analise = analisesData.find(a => a.id === analiseId);
    if (analise && analise.resposta_completa) {
        document.getElementById('modal-resposta-content').textContent = analise.resposta_completa;
        const modal = new bootstrap.Modal(document.getElementById('modalResposta'));
        modal.show();
    } else {
        showToast('Resposta não disponível', 'warning');
    }
}

// Função para visualizar contexto
function visualizarContexto(intimacaoId, contexto) {
    if (contexto) {
        // Decodificar o contexto
        let contextoDecodificado = contexto;
        contextoDecodificado = contextoDecodificado.replace(/\\n/g, '\n');
        contextoDecodificado = contextoDecodificado.replace(/\\r/g, '\r');
        contextoDecodificado = contextoDecodificado.replace(/\\`/g, '`');
        contextoDecodificado = contextoDecodificado.replace(/\\"/g, '"');
        contextoDecodificado = contextoDecodificado.replace(/\\'/g, "'");
        
        // Armazenar o contexto original para copiar
        window.contextoOriginal = contextoDecodificado;
        
        // Processar para Markdown
        let contextoProcessado = contextoDecodificado;
        contextoProcessado = contextoProcessado.replace(/\n{3,}/g, '\n\n');
        contextoProcessado = contextoProcessado.replace(/\n/g, '\n\n');
        
        // Renderizar Markdown
        try {
            if (typeof marked !== 'undefined') {
                const htmlRenderizado = marked.parse(contextoProcessado);
                document.getElementById('modal-contexto-content').innerHTML = htmlRenderizado;
            } else {
                document.getElementById('modal-contexto-content').textContent = contextoProcessado;
            }
        } catch (e) {
            document.getElementById('modal-contexto-content').textContent = contextoProcessado;
        }
        
        const modal = new bootstrap.Modal(document.getElementById('modalContexto'));
        modal.show();
    } else {
        showToast('Contexto não disponível', 'warning');
    }
}

// Função para copiar prompt
function copiarPrompt() {
    const conteudo = document.getElementById('modal-prompt-content').textContent;
    navigator.clipboard.writeText(conteudo).then(() => {
        showToast('Prompt copiado para a área de transferência!', 'success');
    });
}

// Função para copiar resposta
function copiarResposta() {
    const conteudo = document.getElementById('modal-resposta-content').textContent;
    navigator.clipboard.writeText(conteudo).then(() => {
        showToast('Resposta copiada para a área de transferência!', 'success');
    });
}

// Função para copiar contexto
function copiarContexto() {
    if (window.contextoOriginal) {
        navigator.clipboard.writeText(window.contextoOriginal).then(() => {
            showToast('Contexto copiado para a área de transferência!', 'success');
        });
    }
}

// Função para exportar resultados
function exportarResultados() {
    // Fazer download direto do CSV
    exportarCSV();
}

// Função para exportar em CSV
function exportarCSV() {
    const sessionId = '{{ sessao.session_id }}';
    
    // Mostrar loading no botão de exportar
    const btn = document.querySelector('button[onclick="exportarResultados()"]');
    const textoOriginal = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Exportando...';
    btn.disabled = true;
    
    // Fazer requisição para exportar
    fetch('/api/historico/exportar-sessao', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            session_id: sessionId,
            formato: 'csv'
        })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        } else {
            return response.json().then(data => {
                throw new Error(data.error || 'Erro na exportação');
            });
        }
    })
    .then(blob => {
        // Criar link para download
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `historico_sessao_${sessionId.slice(0, 8)}_${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showToast('Exportação CSV concluída!', 'success');
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro na exportação: ' + error.message, 'error');
    })
    .finally(() => {
        // Restaurar botão
        btn.innerHTML = textoOriginal;
        btn.disabled = false;
    });
}



// Função showToast está definida no base.html

// Configuração de colunas
let configuracaoColunas = {};

// Carregar configuração ao inicializar
document.addEventListener('DOMContentLoaded', function() {
    carregarConfiguracaoColunas();
    aplicarConfiguracaoColunas();
    inicializarFiltros();
});

// Funções de Filtro
function inicializarFiltros() {
    aplicarFiltros();
}

function aplicarFiltros() {
    const filtroStatus = document.getElementById('filtro-status').value;
    const filtroTaxaAcerto = document.getElementById('filtro-taxa-acerto').value;
    const linhas = document.querySelectorAll('.linha-analise');
    let contadorVisiveis = 0;
    
    linhas.forEach(linha => {
        let mostrar = true;
        
        // Filtro por status
        if (filtroStatus !== 'todos') {
            const statusLinha = linha.getAttribute('data-status');
            if (statusLinha !== filtroStatus) {
                mostrar = false;
            }
        }
        
        // Filtro por taxa de acerto
        if (filtroTaxaAcerto !== 'todos' && mostrar) {
            const taxaAcerto = parseFloat(linha.getAttribute('data-taxa-acerto'));
            const [min, max] = filtroTaxaAcerto.split('-').map(Number);
            
            if (taxaAcerto < min || taxaAcerto > max) {
                mostrar = false;
            }
        }
        
        // Aplicar visibilidade
        if (mostrar) {
            linha.style.display = '';
            contadorVisiveis++;
        } else {
            linha.style.display = 'none';
        }
    });
    
    // Atualizar contador
    const totalLinhas = linhas.length;
    document.getElementById('contador-filtrados').textContent = 
        `Mostrando ${contadorVisiveis} de ${totalLinhas} análises`;
    
    // Atualizar estado das seleções após aplicar filtros
    atualizarSelecoes();
}

function limparFiltros() {
    document.getElementById('filtro-status').value = 'todos';
    document.getElementById('filtro-taxa-acerto').value = 'todos';
    aplicarFiltros();
}

// Funções de Seleção Múltipla
function toggleSelecaoTodos() {
    const selecionarTodos = document.getElementById('selecionar-todos');
    const checkboxes = document.querySelectorAll('.checkbox-analise');
    
    // Selecionar apenas checkboxes de linhas visíveis
    checkboxes.forEach(checkbox => {
        const linha = checkbox.closest('.linha-analise');
        if (linha && linha.style.display !== 'none') {
            checkbox.checked = selecionarTodos.checked;
        }
    });
    
    atualizarSelecoes();
}

function atualizarSelecoes() {
    const checkboxes = document.querySelectorAll('.checkbox-analise');
    const selecionados = document.querySelectorAll('.checkbox-analise:checked');
    const selecionarTodos = document.getElementById('selecionar-todos');
    const barraAcoes = document.getElementById('barra-acoes-lote');
    const contador = document.getElementById('contador-selecionadas');
    
    // Contar apenas checkboxes de linhas visíveis
    const checkboxesVisiveis = Array.from(checkboxes).filter(checkbox => {
        const linha = checkbox.closest('.linha-analise');
        return linha && linha.style.display !== 'none';
    });
    
    const selecionadosVisiveis = Array.from(selecionados).filter(checkbox => {
        const linha = checkbox.closest('.linha-analise');
        return linha && linha.style.display !== 'none';
    });
    
    // Atualizar checkbox "Selecionar Todos" baseado apenas nas linhas visíveis
    if (selecionadosVisiveis.length === 0) {
        selecionarTodos.indeterminate = false;
        selecionarTodos.checked = false;
    } else if (selecionadosVisiveis.length === checkboxesVisiveis.length && checkboxesVisiveis.length > 0) {
        selecionarTodos.indeterminate = false;
        selecionarTodos.checked = true;
    } else {
        selecionarTodos.indeterminate = true;
        selecionarTodos.checked = false;
    }
    
    // Mostrar/ocultar barra de ações
    if (selecionados.length > 0) {
        barraAcoes.style.display = 'block';
        contador.textContent = `${selecionados.length} selecionada${selecionados.length > 1 ? 's' : ''}`;
    } else {
        barraAcoes.style.display = 'none';
    }
}

function limparSelecoes() {
    const checkboxes = document.querySelectorAll('.checkbox-analise');
    const selecionarTodos = document.getElementById('selecionar-todos');
    
    // Limpar apenas checkboxes de linhas visíveis
    checkboxes.forEach(checkbox => {
        const linha = checkbox.closest('.linha-analise');
        if (linha && linha.style.display !== 'none') {
            checkbox.checked = false;
        }
    });
    
    selecionarTodos.checked = false;
    selecionarTodos.indeterminate = false;
    
    atualizarSelecoes();
}

// Funções de Ações em Lote
function reanalisarSelecionadas() {
    const selecionados = getAnalisesSelecionadas();
    if (selecionados.length === 0) return;
    
    // TODO: Implementar modal para selecionar prompt e re-analisar
    alert(`Re-analisar ${selecionados.length} análises selecionadas`);
}

function verInformacoesAdicionaisSelecionadas() {
    const selecionados = getAnalisesSelecionadas();
    if (selecionados.length === 0) {
        showToast('Selecione pelo menos uma análise!', 'warning');
        return;
    }
    
    // Buscar informações das análises selecionadas
    fetch('/api/analises/informacoes-adicionais', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            analises_ids: selecionados
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarModalInformacoesAdicionais(
                'Informações Adicionais das Análises Selecionadas',
                data.analises,
                'análise'
            );
        } else {
            showToast(`Erro: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('Erro ao buscar informações:', error);
        showToast('Erro ao buscar informações das análises!', 'error');
    });
}

function exportarSelecionadas() {
    const selecionados = getAnalisesSelecionadas();
    if (selecionados.length === 0) return;
    
    // TODO: Implementar exportação das análises selecionadas
    alert(`Exportar ${selecionados.length} análises selecionadas`);
}

function compararSelecionadas() {
    const selecionados = getAnalisesSelecionadas();
    if (selecionados.length === 0) return;
    
    // TODO: Implementar comparação das análises selecionadas
    alert(`Comparar ${selecionados.length} análises selecionadas`);
}

function excluirSelecionadas() {
    const selecionados = getAnalisesSelecionadas();
    if (selecionados.length === 0) return;
    
    if (confirm(`Tem certeza que deseja excluir ${selecionados.length} análises selecionadas?`)) {
        // TODO: Implementar exclusão das análises selecionadas
        alert(`Excluir ${selecionados.length} análises selecionadas`);
    }
}

function getAnalisesSelecionadas() {
    const checkboxes = document.querySelectorAll('.checkbox-analise:checked');
    return Array.from(checkboxes).map(checkbox => checkbox.value);
}

function carregarConfiguracaoColunas() {
    const configSalva = localStorage.getItem('configuracaoColunasSessao');
    if (configSalva) {
        configuracaoColunas = JSON.parse(configSalva);
    } else {
        configuracaoColunas = {
            selecao: true,
            intimacao: true,
            classificacao_manual: true,
            resultado_ia: true,
            informacao_adicional: true,
            status: true,
            tempo: true,
            custo: true,
            tokens: true,
            acerto_individual: true
        };
    }
    
    // Aplicar configuração aos checkboxes
    Object.keys(configuracaoColunas).forEach(key => {
        const checkbox = document.getElementById(`col-${key.replace('_', '-')}`);
        if (checkbox) {
            checkbox.checked = configuracaoColunas[key];
        }
    });
}

function aplicarConfiguracaoColunas() {
    const configSalva = localStorage.getItem('configuracaoColunasSessao');
    if (configSalva) {
        configuracaoColunas = JSON.parse(configSalva);
    } else {
        configuracaoColunas = {
            selecao: true,
            intimacao: true,
            classificacao_manual: true,
            resultado_ia: true,
            informacao_adicional: true,
            status: true,
            tempo: true,
            custo: true,
            tokens: true,
            acerto_individual: true
        };
    }
    
    // Aplicar visibilidade das colunas
    const colunas = {
        'selecao': '.col-selecao',
        'intimacao': '.col-intimacao',
        'classificacao_manual': '.col-classificacao-manual',
        'resultado_ia': '.col-resultado-ia',
        'informacao_adicional': '.col-informacao-adicional',
        'status': '.col-status',
        'tempo': '.col-tempo',
        'custo': '.col-custo',
        'tokens': '.col-tokens',
        'acerto_individual': '.col-acerto-individual'
    };
    
    Object.keys(colunas).forEach(key => {
        const visivel = configuracaoColunas[key];
        const elementos = document.querySelectorAll(colunas[key]);
        elementos.forEach(el => {
            el.style.display = visivel ? '' : 'none';
        });
    });
}

// Event listeners para checkboxes
document.addEventListener('change', function(e) {
    if (e.target.matches('input[type="checkbox"][id^="col-"]')) {
        const key = e.target.id.replace('col-', '').replace('-', '_');
        configuracaoColunas[key] = e.target.checked;
        localStorage.setItem('configuracaoColunasSessao', JSON.stringify(configuracaoColunas));
        aplicarConfiguracaoColunas();
    }
});

function toggleConfiguracaoColunas() {
    const configDiv = document.getElementById('configuracao-colunas');
    configDiv.style.display = configDiv.style.display === 'none' ? 'block' : 'none';
}

function selecionarTodasColunas() {
    configuracaoColunas = {
        intimacao: true,
        classificacao_manual: true,
        resultado_ia: true,
        informacao_adicional: true,
        status: true,
        tempo: true,
        custo: true,
        tokens: true
    };
    
    Object.keys(configuracaoColunas).forEach(key => {
        const checkbox = document.getElementById(`col-${key.replace('_', '-')}`);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    
    localStorage.setItem('configuracaoColunasSessao', JSON.stringify(configuracaoColunas));
    aplicarConfiguracaoColunas();
}

function limparSelecaoColunas() {
    configuracaoColunas = {
        intimacao: false,
        classificacao_manual: false,
        resultado_ia: false,
        informacao_adicional: false,
        status: false,
        tempo: false,
        custo: false,
        tokens: false
    };
    
    Object.keys(configuracaoColunas).forEach(key => {
        const checkbox = document.getElementById(`col-${key.replace('_', '-')}`);
        if (checkbox) {
            checkbox.checked = false;
        }
    });
    
    localStorage.setItem('configuracaoColunasSessao', JSON.stringify(configuracaoColunas));
    aplicarConfiguracaoColunas();
}

function salvarConfiguracaoColunas() {
    // A configuração já é salva automaticamente quando os checkboxes mudam
    showToast('Configuração salva com sucesso!', 'success');
    
    // Fechar painel de configuração
    const configDiv = document.getElementById('configuracao-colunas');
    configDiv.style.display = 'none';
}
</script>

<style>
/* Estilos para cards compactos na tabela */
.table td {
    vertical-align: top;
    padding: 0.75rem;
}

/* Ajustes para o card compacto na tabela */
.intimacao-card-compact {
    margin: 0;
    max-width: 100%;
}

.card-intimacao-content-compact {
    padding: 6px 8px;
}

.card-intimacao-row-compact {
    margin-bottom: 2px;
}

.field-label-compact {
    font-size: 9px;
}

.field-value-compact {
    font-size: 10px;
}

/* Ajuste da largura da coluna de intimação */
.table th:first-child,
.table td:first-child {
    min-width: 320px;
    max-width: 350px;
}

.markdown-content {
    max-height: 65vh;
    overflow-y: auto;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 0.375rem;
}

.markdown-content h1,
.markdown-content h2,
.markdown-content h3,
.markdown-content h4,
.markdown-content h5,
.markdown-content h6 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.markdown-content p {
    margin-bottom: 0.5rem;
    line-height: 1.5;
}

.markdown-content pre,
.markdown-content code {
    background-color: #e9ecef;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
}

.markdown-content pre {
    padding: 1rem;
    margin: 1rem 0;
    overflow-x: auto;
}

.markdown-content ul,
.markdown-content ol {
    margin-bottom: 0.5rem;
    padding-left: 1.5rem;
}

.markdown-content li {
    margin-bottom: 0.25rem;
}
</style>
{% endblock %}
